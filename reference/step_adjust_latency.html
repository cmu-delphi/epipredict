<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Adapt the model to latent data — step_adjust_latency • epipredict</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Open_Sans-0.4.10/font.css" rel="stylesheet"><link href="../deps/Source_Serif_Pro-0.4.10/font.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Adapt the model to latent data — step_adjust_latency"><meta name="description" content="In the standard case, the arx models assume that the last observation is also
the day from which the forecast is being made. But if the data has latency,
then you may wish to adjust the predictors (lags) and/or the outcome (ahead)
to compensate.
This is most useful in realtime and
pseudo-prospective forecasting for data where there is some delay between the
event occurring and the event being reported."><meta property="og:description" content="In the standard case, the arx models assume that the last observation is also
the day from which the forecast is being made. But if the data has latency,
then you may wish to adjust the predictors (lags) and/or the outcome (ahead)
to compensate.
This is most useful in realtime and
pseudo-prospective forecasting for data where there is some delay between the
event occurring and the event being reported."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">epipredict</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/epipredict.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/custom_epiworkflows.html">Epiworkflows</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/backtesting.html">Backtesting</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/update.html">Using the add/update/remove/adjust functions</a></li>
    <li><a class="dropdown-item" href="../articles/panel-data.html">Using epipredict on non-epidemic panel data</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/cmu-delphi/epipredict/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Adapt the model to latent data</h1>
      <small class="dont-index">Source: <a href="https://github.com/cmu-delphi/epipredict/blob/main/R/step_adjust_latency.R" class="external-link"><code>R/step_adjust_latency.R</code></a></small>
      <div class="d-none name"><code>step_adjust_latency.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>In the standard case, the arx models assume that the last observation is also
the day from which the forecast is being made. But if the data has latency,
then you may wish to adjust the predictors (lags) and/or the outcome (ahead)
to compensate.
This is most useful in realtime and
pseudo-prospective forecasting for data where there is some delay between the
event occurring and the event being reported.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">step_adjust_latency</span><span class="op">(</span></span>
<span>  <span class="va">recipe</span>,</span>
<span>  <span class="va">...</span>,</span>
<span>  method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"extend_ahead"</span>, <span class="st">"locf"</span>, <span class="st">"extend_lags"</span><span class="op">)</span>,</span>
<span>  epi_keys_checked <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  keys_to_ignore <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  fixed_latency <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  fixed_forecast_date <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  check_latency_length <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  id <span class="op">=</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/rand_id.html" class="external-link">rand_id</a></span><span class="op">(</span><span class="st">"adjust_latency"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-recipe">recipe<a class="anchor" aria-label="anchor" href="#arg-recipe"></a></dt>
<dd><p>A recipe object. The step will be added to the
sequence of operations for this recipe.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>One or more selector functions to choose variables
for this step. See <code><a href="https://recipes.tidymodels.org/reference/selections.html" class="external-link">selections()</a></code> for more details.</p></dd>


<dt id="arg-method">method<a class="anchor" aria-label="anchor" href="#arg-method"></a></dt>
<dd><p>a character. Determines the method by which the
forecast handles latency. The options are:</p><ul><li><p><code>"extend_ahead"</code>: Lengthen the ahead so that forecasting from the last
observation results in a forecast <code>ahead</code> after the <code>forecast_date</code> date.
E.g. if there are 3 days of latency between the last observation and the
<code>forecast_date</code> date for a 4 day ahead forecast, the ahead used in practice
is actually 7.</p></li>
<li><p><code>"locf"</code>: carries forward the last observed value(s) up to the forecast
date.</p></li>
<li><p><code>"extend_lags"</code>: per <code>epi_key</code> and <code>predictor</code>, adjusts the lag so that
the shortest lag at predict time is at the last observation. E.g. if the
lags are <code>c(0,7,14)</code> for data that is 3 days latent, the actual lags used
become <code>c(3,10,17)</code>.</p></li>
</ul></dd>


<dt id="arg-epi-keys-checked">epi_keys_checked<a class="anchor" aria-label="anchor" href="#arg-epi-keys-checked"></a></dt>
<dd><p>a character vector. A list of keys to group by before
finding the <code>max_time_value</code> (the last day of data), defaulting to
<code>geo_value</code>. Different locations may have different latencies; to produce a
forecast at every location, we need to guarantee data at every location by
using the largest latency across every location; this means taking
<code>max_time_value</code> to be the minimum of the <code>max_time_value</code>s for each set of
key values (so the earliest date).  If <code>NULL</code> or an empty character vector,
it will take the maximum across all values, irrespective of any keys.</p>
<p>Note that this is a separate concern from different latencies across
different <em>data columns</em>, which is only handled by the choice of <code>method</code>.</p></dd>


<dt id="arg-keys-to-ignore">keys_to_ignore<a class="anchor" aria-label="anchor" href="#arg-keys-to-ignore"></a></dt>
<dd><p>a list of character vectors. Set this to avoid using
specific key values in the <code>epi_keys_checked</code> to set latency. For example,
say you have two locations <code>pr</code> and <code>gu</code> which have useful training data,
but have stopped providing up-to-date information, and so are no longer
part of the test set. Setting <code>keys_to_ignore = list(geo_value = c("pr", "gu"))</code> will exclude them from the latency calculation.</p></dd>


<dt id="arg-fixed-latency">fixed_latency<a class="anchor" aria-label="anchor" href="#arg-fixed-latency"></a></dt>
<dd><p>either a positive integer, or a labeled positive integer
vector. Cannot be set at the same time as <code>fixed_forecast_date</code>. If
non-<code>NULL</code>, the amount to offset the ahead or lag by. If a single integer,
this is used for all columns; if a labeled vector, the labels must
correspond to the base column names (before lags/aheads).  If <code>NULL</code>, the
latency is the distance between the <code>epi_df</code>'s <code>max_time_value</code> and the <code>forecast_date</code>.</p></dd>


<dt id="arg-fixed-forecast-date">fixed_forecast_date<a class="anchor" aria-label="anchor" href="#arg-fixed-forecast-date"></a></dt>
<dd><p>either a date of the same kind used in the
<code>epi_df</code>, or <code>NULL</code>. Exclusive with <code>fixed_latency</code>. If a date, it gives
the date from which the forecast is actually occurring. If <code>NULL</code>, the
<code>forecast_date</code> is determined either via the <code>fixed_latency</code>, or is set to
the <code>epi_df</code>'s <code>as_of</code> value if <code>fixed_latency</code> is also <code>NULL</code>.</p></dd>


<dt id="arg-check-latency-length">check_latency_length<a class="anchor" aria-label="anchor" href="#arg-check-latency-length"></a></dt>
<dd><p>bool, determines whether to warn if the latency
is unusually high. Turn off if you know your forecast is going to be far
into the future.</p></dd>


<dt id="arg-id">id<a class="anchor" aria-label="anchor" href="#arg-id"></a></dt>
<dd><p>A character string that is unique to this step to identify it.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>An updated version of <code>recipe</code> with the new step added to the
sequence of any existing operations.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>This step allows the user to create models on the most recent
data, automatically accounting for latency patterns. Instead of using the last observation
date, <code>step_adjust_latency</code> uses the <code>as_of</code> date of the <code>epi_df</code> as the
<code>forecast_date</code>, and adjusts the model so that there is data available. To
demonstrate some of the subtleties, let's consider a toy dataset:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">toy_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span> <span class="op">~</span><span class="va">geo_value</span>, <span class="op">~</span><span class="va">time_value</span>, <span class="op">~</span><span class="va">a</span>, <span class="op">~</span><span class="va">b</span>,</span>
<span> <span class="st">"ma"</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2015-01-11"</span><span class="op">)</span>, <span class="fl">20</span>, <span class="fl">6</span>,</span>
<span> <span class="st">"ma"</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2015-01-12"</span><span class="op">)</span>, <span class="fl">23</span>, <span class="cn">NA</span>,</span>
<span> <span class="st">"ma"</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2015-01-13"</span><span class="op">)</span>, <span class="fl">25</span>, <span class="cn">NA</span>,</span>
<span> <span class="st">"ca"</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2015-01-11"</span><span class="op">)</span>, <span class="fl">100</span>, <span class="fl">5</span>,</span>
<span> <span class="st">"ca"</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2015-01-12"</span><span class="op">)</span>, <span class="fl">103</span>, <span class="fl">10</span>,</span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>   <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epi_df.html" class="external-link">as_epi_df</a></span><span class="op">(</span>as_of <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2015-01-14"</span><span class="op">)</span><span class="op">)</span></span></code></pre><p></p></div>
<p>If we're looking to predict the value on the 15th, forecasting from the 14th
(the <code>as_of</code> date above), there are two issues we will need to address:</p><ol><li><p><code>"ca"</code> is latent by 2 days, whereas <code>"ma"</code> is latent by 1</p></li>
<li><p>if we want to use <code>b</code> as an exogenous variable, for <code>"ma"</code> it is latent by
3 days instead of just 1.</p></li>
</ol><p>Regardless of <code>method</code>, <code>epi_keys_checked="geo_value"</code> guarantees tha the
difference between <code>"ma"</code> and <code>"ca"</code> is accounted for by making the latency
adjustment at least 2. For some comparison, here's what the various methods
will do:</p><div class="section">
<h3 id="locf"><code>locf</code><a class="anchor" aria-label="anchor" href="#locf"></a></h3>


<p>Short for "last observation carried forward", <code>locf</code> assumes that every day
between the last observation and the forecast day is exactly the same.
This is a very straightforward assumption, but wrecks any features that
depend on changes in value over time, such as the growth rate, or even
adjacent lags. A more robust version of this falls under the heading of
nowcasting, an eventual aim for this package. On the toy dataset, it
doesn't matter which day we're trying to predict, since it just fills
forward to the <code>forecast_date</code>:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">toy_recipe</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epi_recipe.html">epi_recipe</a></span><span class="op">(</span><span class="va">toy_df</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/step_adjust_latency.html">step_adjust_latency</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html" class="external-link">has_role</a></span><span class="op">(</span><span class="st">"raw"</span><span class="op">)</span>, method<span class="op">=</span><span class="st">"locf"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">toy_recipe</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html" class="external-link">prep</a></span><span class="op">(</span><span class="va">toy_df</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/bake.html" class="external-link">bake</a></span><span class="op">(</span><span class="va">toy_df</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">time_value</span><span class="op">)</span></span>
<span><span class="co">#&gt; An `epi_df` object, 8 x 4 with metadata:</span></span>
<span><span class="co">#&gt; * geo_type  = state</span></span>
<span><span class="co">#&gt; * time_type = day</span></span>
<span><span class="co">#&gt; * as_of     = 2015-01-14</span></span>
<span><span class="co">#&gt;</span></span>
<span><span class="co">#&gt; # A tibble: 8 x 4</span></span>
<span><span class="co">#&gt;   geo_value time_value     a     b</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;     &lt;date&gt;     &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 ca        2015-01-11   100     5</span></span>
<span><span class="co">#&gt; 2 ca        2015-01-12   103    10</span></span>
<span><span class="co">#&gt; 3 ca        2015-01-13   103    10</span></span>
<span><span class="co">#&gt; 4 ca        2015-01-14   103    10</span></span>
<span><span class="co">#&gt; 5 ma        2015-01-11    20     6</span></span>
<span><span class="co">#&gt; 6 ma        2015-01-12    23     6</span></span>
<span><span class="co">#&gt; 7 ma        2015-01-13    25     6</span></span>
<span><span class="co">#&gt; 8 ma        2015-01-14    25     6</span></span></code></pre><p></p></div>
</div>

<div class="section">
<h3 id="extend-lags"><code>extend_lags</code><a class="anchor" aria-label="anchor" href="#extend-lags"></a></h3>


<p><code>extend_lags</code> increases the lags so that they are guaranteed to have
data. This has the advantage of being applicable on
a per-column basis; if cases and deaths are reported at different
latencies, the lags for each are adjusted separately. In the toy example:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">toy_recipe</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epi_recipe.html">epi_recipe</a></span><span class="op">(</span><span class="va">toy_df</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/step_adjust_latency.html">step_adjust_latency</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html" class="external-link">has_role</a></span><span class="op">(</span><span class="st">"raw"</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">"extend_lags"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/step_epi_shift.html">step_epi_lag</a></span><span class="op">(</span><span class="va">a</span>, lag<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/step_epi_shift.html">step_epi_lag</a></span><span class="op">(</span><span class="va">b</span>, lag<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/step_epi_shift.html">step_epi_ahead</a></span><span class="op">(</span><span class="va">a</span>, ahead<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">toy_recipe</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html" class="external-link">prep</a></span><span class="op">(</span><span class="va">toy_df</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/bake.html" class="external-link">bake</a></span><span class="op">(</span><span class="va">toy_df</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">time_value</span><span class="op">)</span></span>
<span><span class="co">#&gt; An `epi_df` object, 21 x 7 with metadata:</span></span>
<span><span class="co">#&gt; * geo_type  = state</span></span>
<span><span class="co">#&gt; * time_type = day</span></span>
<span><span class="co">#&gt; * as_of     = 2015-01-14</span></span>
<span><span class="co">#&gt;</span></span>
<span><span class="co">#&gt; # A tibble: 21 x 7</span></span>
<span><span class="co">#&gt;    geo_value time_value     a     b lag_3_a lag_4_b ahead_1_a</span></span>
<span><span class="co">#&gt;    &lt;chr&gt;     &lt;date&gt;     &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1 ca        2015-01-10    NA    NA      NA      NA       100</span></span>
<span><span class="co">#&gt;  2 ca        2015-01-11   100     5      NA      NA       103</span></span>
<span><span class="co">#&gt;  3 ca        2015-01-12   103    10      NA      NA        NA</span></span>
<span><span class="co">#&gt;  4 ca        2015-01-13    NA    NA      NA      NA        NA</span></span>
<span><span class="co">#&gt;  5 ca        2015-01-14    NA    NA     100      NA        NA</span></span>
<span><span class="co">#&gt;  6 ca        2015-01-15    NA    NA     103       5        NA</span></span>
<span><span class="co">#&gt;  7 ca        2015-01-16    NA    NA      NA      10        NA</span></span>
<span><span class="co">#&gt;  8 ca        2015-01-17    NA    NA      NA      NA        NA</span></span>
<span><span class="co">#&gt;  9 ca        2015-01-18    NA    NA      NA      NA        NA</span></span>
<span><span class="co">#&gt; 10 ca        2015-01-19    NA    NA      NA      NA        NA</span></span>
<span><span class="co">#&gt; # i 11 more rows</span></span></code></pre><p></p></div>
<p>The maximum latency in column <code>a</code> is 2 days, so the lag is increased to 3,
while the max latency in column <code>b</code> is 3, so the same lag is increased to
4; both of these changes are reflected in the column names. Meanwhile the
ahead is uneffected.</p>
<p>As a side-note, lag/ahead can be somewhat ambiguous about direction. Here,
the values are brought forward in time, so that for a given row, column
<code>lag_3_a</code> represents the value 3 days before.</p>
</div>

<div class="section">
<h3 id="extend-ahead"><code>extend_ahead</code><a class="anchor" aria-label="anchor" href="#extend-ahead"></a></h3>


<p><code>extend_ahead</code> increases the ahead, turning a 3 day ahead forecast
into a 7 day one; this has the advantage of simplicity and is reflective of
the actual modelling task, but potentially leaves information unused if
different data sources have different latencies; it must use the latency of
the most latent data to insure there is data available. In the toy example:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">toy_recipe</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epi_recipe.html">epi_recipe</a></span><span class="op">(</span><span class="va">toy_df</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/step_adjust_latency.html">step_adjust_latency</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html" class="external-link">has_role</a></span><span class="op">(</span><span class="st">"raw"</span><span class="op">)</span>, method<span class="op">=</span><span class="st">"extend_ahead"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/step_epi_shift.html">step_epi_lag</a></span><span class="op">(</span><span class="va">a</span>, lag<span class="op">=</span><span class="fl">0</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/step_epi_shift.html">step_epi_ahead</a></span><span class="op">(</span><span class="va">a</span>, ahead<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">toy_recipe</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html" class="external-link">prep</a></span><span class="op">(</span><span class="va">toy_df</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/bake.html" class="external-link">bake</a></span><span class="op">(</span><span class="va">toy_df</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">time_value</span><span class="op">)</span></span>
<span><span class="co">#&gt; An `epi_df` object, 10 x 6 with metadata:</span></span>
<span><span class="co">#&gt; * geo_type  = state</span></span>
<span><span class="co">#&gt; * time_type = day</span></span>
<span><span class="co">#&gt; * as_of     = 2015-01-14</span></span>
<span><span class="co">#&gt;</span></span>
<span><span class="co">#&gt; # A tibble: 10 x 6</span></span>
<span><span class="co">#&gt;    geo_value time_value     a     b lag_0_a ahead_3_a</span></span>
<span><span class="co">#&gt;    &lt;chr&gt;     &lt;date&gt;     &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1 ca        2015-01-08    NA    NA      NA       100</span></span>
<span><span class="co">#&gt;  2 ca        2015-01-09    NA    NA      NA       103</span></span>
<span><span class="co">#&gt;  3 ca        2015-01-11   100     5     100        NA</span></span>
<span><span class="co">#&gt;  4 ca        2015-01-12   103    10     103        NA</span></span>
<span><span class="co">#&gt;  5 ma        2015-01-08    NA    NA      NA        20</span></span>
<span><span class="co">#&gt;  6 ma        2015-01-09    NA    NA      NA        23</span></span>
<span><span class="co">#&gt;  7 ma        2015-01-10    NA    NA      NA        25</span></span>
<span><span class="co">#&gt;  8 ma        2015-01-11    20     6      20        NA</span></span>
<span><span class="co">#&gt;  9 ma        2015-01-12    23    NA      23        NA</span></span>
<span><span class="co">#&gt; 10 ma        2015-01-13    25    NA      25        NA</span></span></code></pre><p></p></div>
<p>Even though we're doing a 1 day ahead forecast, because our worst latency
is 3 days from column <code>b</code>'s <code>"ma"</code> data, our outcome column is <code>ahead_4_a</code>
(so 4 days ahead). If we want to ignore any latency in column <code>b</code>, we need
to explicitly set the columns to consider while adjusting like this:
<code>step_adjust_latency(a, method="extend_ahead")</code>.</p>
</div>

    </div>
    <div class="section level2">
    <h2 id="programmatic-details">Programmatic details<a class="anchor" aria-label="anchor" href="#programmatic-details"></a></h2>
    <p><code>step_adjust_latency</code> uses the metadata, such as <code>time_type</code> and <code>as_of</code>, of
the <code>epi_df</code> used in the initial prep step, rather than baking or
prediction. This means reusing the same forecaster on new data is not
advised, though typically it is not advised in general.</p>
<p>The latency adjustment only applies to columns created after this step, so
this step should go before both <code>step_epi_ahead</code> and <code>step_epi_lag</code>. This will work:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">toy_recipe</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epi_recipe.html">epi_recipe</a></span><span class="op">(</span><span class="va">toy_df</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>   <span class="co"># non-lag steps</span></span>
<span>   <span class="fu"><a href="../reference/step_adjust_latency.html">step_adjust_latency</a></span><span class="op">(</span><span class="va">a</span>, method <span class="op">=</span> <span class="st">"extend_lags"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>   <span class="fu"><a href="../reference/step_epi_shift.html">step_epi_lag</a></span><span class="op">(</span><span class="va">a</span>, lag<span class="op">=</span><span class="fl">0</span><span class="op">)</span> <span class="co"># other steps</span></span></code></pre><p></p></div>
<p>while this will not:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">toy_recipe</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epi_recipe.html">epi_recipe</a></span><span class="op">(</span><span class="va">toy_df</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>   <span class="fu"><a href="../reference/step_epi_shift.html">step_epi_lag</a></span><span class="op">(</span><span class="va">a</span>, lag<span class="op">=</span><span class="fl">0</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>   <span class="fu"><a href="../reference/step_adjust_latency.html">step_adjust_latency</a></span><span class="op">(</span><span class="va">a</span>, method <span class="op">=</span> <span class="st">"extend_lags"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: If `method` is "extend_lags" or "locf", then the previous `step_epi_lag`s won't</span></span>
<span><span class="co">#&gt; work with modified data.</span></span></code></pre><p></p></div>
<p>If you create columns that you then apply lags to (such as
<code><a href="step_growth_rate.html">step_growth_rate()</a></code>), these should be created before
<code>step_adjust_latency</code>, so any subseqent latency can be addressed.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p>Other row operation steps:
<code><a href="step_epi_shift.html">step_epi_lag</a>()</code>,
<code><a href="step_growth_rate.html">step_growth_rate</a>()</code>,
<code><a href="step_lag_difference.html">step_lag_difference</a>()</code></p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="va">rates</span> <span class="op">&lt;-</span> <span class="va">covid_case_death_rates</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time_value</span> <span class="op">&gt;</span> <span class="st">"2021-11-01"</span>, <span class="va">geo_value</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ak"</span>, <span class="st">"ca"</span>, <span class="st">"ny"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># setting the `as_of` to something realistic</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/attributes.html" class="external-link">attributes</a></span><span class="op">(</span><span class="va">rates</span><span class="op">)</span><span class="op">$</span><span class="va">metadata</span><span class="op">$</span><span class="va">as_of</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">rates</span><span class="op">$</span><span class="va">time_value</span><span class="op">)</span> <span class="op">+</span> <span class="fl">3</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="epi_recipe.html">epi_recipe</a></span><span class="op">(</span><span class="va">rates</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu">step_adjust_latency</span><span class="op">(</span><span class="fu">recipes</span><span class="fu">::</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html" class="external-link">has_role</a></span><span class="op">(</span><span class="st">"raw"</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">"extend_ahead"</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="step_epi_shift.html">step_epi_ahead</a></span><span class="op">(</span><span class="va">death_rate</span>, ahead <span class="op">=</span> <span class="fl">7</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="step_epi_shift.html">step_epi_lag</a></span><span class="op">(</span><span class="va">death_rate</span>, lag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">7</span>, <span class="fl">14</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">r</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> <span style="color: #00BBBB;">──</span> <span style="font-weight: bold;">Epi Recipe</span> <span style="color: #00BBBB;">──────────────────────────────────────────────────────────────────</span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> ── Inputs </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Number of variables by role</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> raw:        2</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> geo_value:  1</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> time_value: 1</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> ── Operations </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 1. Adj. extend_ahead: <span style="color: #0000BB;">recipes::has_role("raw")</span> latency <span style="color: #0000BB;">TBD at train time</span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 2. Leading: <span style="color: #0000BB;">death_rate</span> by <span style="color: #0000BB;">7</span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 3. Lagging: <span style="color: #0000BB;">death_rate</span> by <span style="color: #0000BB;">0, 7, 14</span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">rates_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="epi_workflow.html">epi_workflow</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="add_epi_recipe.html">add_epi_recipe</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="Add_model.html">add_model</a></span><span class="op">(</span><span class="fu"><a href="https://parsnip.tidymodels.org/reference/linear_reg.html" class="external-link">linear_reg</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="pipe.html">%&gt;%</a></span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">rates</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">rates_fit</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> ══ Epi Workflow [trained] ══════════════════════════════════════════════════════</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> <span style="font-style: italic;">Preprocessor:</span> Recipe</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> <span style="font-style: italic;">Model:</span> linear_reg()</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> <span style="font-style: italic;">Postprocessor:</span> None</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> ── Preprocessor ────────────────────────────────────────────────────────────────</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 3 Recipe steps.</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 1. step_adjust_latency()</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 2. step_epi_ahead()</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 3. step_epi_lag()</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> ── Model ───────────────────────────────────────────────────────────────────────</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Call:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> stats::lm(formula = ..y ~ ., data = data)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Coefficients:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       (Intercept)   lag_0_death_rate   lag_7_death_rate  lag_14_death_rate  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>            0.3806            -0.2208            -0.0403            -0.0394  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p><a href="https://delphi.cmu.edu/about/" class="external-link">About Delphi</a> • <a href="https://delphi.cmu.edu/epidemic-signals/terms-of-use/" class="external-link">Terms of Use</a> • <a href="https://docs.google.com/forms/u/1/d/e/1FAIpQLScqgT1fKZr5VWBfsaSp-DNaN03aV6EoZU4YljIzHJ1Wl_zmtg/viewform" class="external-link">Contact Us</a> • <a href="https://github.com/cmu-delphi/" class="external-link">Delphi GitHub</a> • <a href="https://cmu-delphi.github.io/delphi-epidata/" class="external-link">Epidata API</a></p>
</div>

<div class="pkgdown-footer-right">
  <p>epipredict</p>
</div>

    </footer></div>





  </body></html>

