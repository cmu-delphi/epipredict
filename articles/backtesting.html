<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Accurately backtesting forecasters • epipredict</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Open_Sans-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Serif_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Accurately backtesting forecasters">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">epipredict</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/epipredict.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/custom_epiworkflows.html">Epiworkflows</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/backtesting.html">Backtesting</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/update.html">Using the add/update/remove/adjust functions</a></li>
    <li><a class="dropdown-item" href="../articles/panel-data.html">Using epipredict on non-epidemic panel data</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/cmu-delphi/epipredict/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Accurately backtesting forecasters</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/cmu-delphi/epipredict/blob/main/vignettes/backtesting.Rmd" class="external-link"><code>vignettes/backtesting.Rmd</code></a></small>
      <div class="d-none name"><code>backtesting.Rmd</code></div>
    </div>

    
    
<p>Backtesting is a crucial step in the development of forecasting
models. It involves testing the model on historical time periods to see
how well it generalizes to new data.</p>
<p>In the context of epidemiological forecasting, to do backtesting
accurately, we need to account for the fact that the data available at
<em>the time of the forecast</em> would have been different from the
data available at the time of the <em>backtest</em>. This is because new
data is constantly being collected and added to the dataset, and old
data potentially revised. Training and making predictions only on
finalized data can lead to overly optimistic estimates of accuracy (see,
for example, <a href="https://www.pnas.org/content/118/51/e2111453118/" class="external-link">McDonald et al.
2021</a> and the references therein).</p>
<p>In the <a href="https://github.com/cmu-delphi/epiprocess" class="external-link">epiprocess</a> package, we provide the function
<code><a href="https://cmu-delphi.github.io/epiprocess/reference/epix_slide.html" class="external-link">epix_slide()</a></code> to help conviently perform version-faithful
forecasting by only using the data as it would have been available at
forecast reference time. In this vignette, we will demonstrate how to
use <code><a href="https://cmu-delphi.github.io/epiprocess/reference/epix_slide.html" class="external-link">epix_slide()</a></code> to backtest an auto-regressive forecaster
constructed using <code><a href="../reference/arx_forecaster.html">arx_forecaster()</a></code> on historical COVID-19
case data from the US and Canada.</p>
<div class="section level2">
<h2 id="getting-case-data-from-us-states-into-an-epi_archive">Getting case data from US states into an
<code>epi_archive</code><a class="anchor" aria-label="anchor" href="#getting-case-data-from-us-states-into-an-epi_archive"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Setup</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/cmu-delphi/epipredict/" class="external-link">epipredict</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/cmu-delphi/epiprocess" class="external-link">epiprocess</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://cmu-delphi.github.io/epidatr/" class="external-link">epidatr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span></span></code></pre></div>
<p>First, we create an <code>epi_archive()</code> to store the version
history of the percentage of doctor’s visits with CLI (COVID-like
illness) computed from medical insurance claims and the number of new
confirmed COVID-19 cases per 100,000 population (daily) for 4 states</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Select the `percent_cli` column from the data archive</span></span>
<span><span class="va">doctor_visits</span> <span class="op">&lt;-</span> <span class="va">archive_cases_dv_subset</span><span class="op">$</span><span class="va">DT</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">time_value</span>, <span class="va">version</span>, <span class="va">percent_cli</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html" class="external-link">drop_na</a></span><span class="op">(</span><span class="va">percent_cli</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epi_archive.html" class="external-link">as_epi_archive</a></span><span class="op">(</span>compactify <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>The data can also be fetched from the Delphi Epidata API with the
following query:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://cmu-delphi.github.io/epidatr/" class="external-link">epidatr</a></span><span class="op">)</span></span>
<span><span class="va">doctor_visits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://cmu-delphi.github.io/epidatr/reference/pub_covidcast.html" class="external-link">pub_covidcast</a></span><span class="op">(</span></span>
<span>  source <span class="op">=</span> <span class="st">"doctor-visits"</span>,</span>
<span>  signals <span class="op">=</span> <span class="st">"smoothed_adj_cli"</span>,</span>
<span>  geo_type <span class="op">=</span> <span class="st">"state"</span>,</span>
<span>  time_type <span class="op">=</span> <span class="st">"day"</span>,</span>
<span>  geo_values <span class="op">=</span> <span class="st">"ca,fl,ny,tx"</span>,</span>
<span>  time_values <span class="op">=</span> <span class="fu"><a href="https://cmu-delphi.github.io/epidatr/reference/epirange.html" class="external-link">epirange</a></span><span class="op">(</span><span class="fl">20200601</span>, <span class="fl">20211201</span><span class="op">)</span>,</span>
<span>  issues <span class="op">=</span> <span class="fu"><a href="https://cmu-delphi.github.io/epidatr/reference/epirange.html" class="external-link">epirange</a></span><span class="op">(</span><span class="fl">20200601</span>, <span class="fl">20211201</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># The version date column is called `issue` in the Epidata API. Rename it.</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span>version <span class="op">=</span> <span class="va">issue</span>, <span class="va">geo_value</span>, <span class="va">time_value</span>, percent_cli <span class="op">=</span> <span class="va">value</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epi_archive.html" class="external-link">as_epi_archive</a></span><span class="op">(</span>compactify <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>In the interest of computational speed, we limit the dataset to 4
states and 2020–2021, but the full archive can be used in the same way
and has performed well in the past.</p>
<p>We choose this dataset in particular partly because it is revision
heavy; for example, here is a plot that compares monthly snapshots of
the data.</p>
<details><summary>
Code for plotting
</summary><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">geo_choose</span> <span class="op">&lt;-</span> <span class="st">"ca"</span></span>
<span><span class="va">forecast_dates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span></span>
<span>  from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2020-08-01"</span><span class="op">)</span>,</span>
<span>  to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2021-11-01"</span><span class="op">)</span>,</span>
<span>  by <span class="op">=</span> <span class="st">"1 month"</span><span class="op">)</span></span>
<span><span class="va">percent_cli_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="co"># Snapshotted data for the version-faithful forecasts</span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span></span>
<span>    <span class="va">forecast_dates</span>,</span>
<span>    <span class="op">~</span> <span class="va">doctor_visits</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epix_as_of.html" class="external-link">epix_as_of</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>version <span class="op">=</span> <span class="va">.x</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>version_faithful <span class="op">=</span> <span class="st">"Version faithful"</span><span class="op">)</span>,</span>
<span>  <span class="co"># Latest data for the version-un-faithful forecasts</span></span>
<span>  <span class="va">doctor_visits</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epix_as_of.html" class="external-link">epix_as_of</a></span><span class="op">(</span><span class="va">doctor_visits</span><span class="op">$</span><span class="va">versions_end</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>version_faithful <span class="op">=</span> <span class="st">"Version un-faithful"</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">p0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span></span>
<span>  <span class="va">archive_cases_dv_subset</span>, <span class="va">percent_cli</span>, </span>
<span>  .versions <span class="op">=</span> <span class="va">forecast_dates</span>, </span>
<span>  .mark_versions <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  .facet_filter <span class="op">=</span> <span class="op">(</span><span class="va">geo_value</span> <span class="op">==</span> <span class="st">"ca"</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html" class="external-link">scale_x_date</a></span><span class="op">(</span>minor_breaks <span class="op">=</span> <span class="st">"month"</span>, date_labels <span class="op">=</span> <span class="st">"%b %Y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">""</span>, y <span class="op">=</span> <span class="st">"% of doctor's visits with\n Covid-like illness"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_c</a></span><span class="op">(</span></span>
<span>    option <span class="op">=</span> <span class="st">"viridis"</span>,</span>
<span>    guide <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>reverse<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>, direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span>, expand <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/expansion.html" class="external-link">expansion</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.05</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
</details><p><img src="backtesting_files/figure-html/plot_just_revisioning-1.png" width="90%" style="display: block; margin: auto;"></p>
<p>The snapshots are taken on the first of each month, with the vertical
dashed line representing the issue date for the time series of the
corresponding color. For example, the snapshot on March 1st, 2021 is
aquamarine, and increases to slightly over 10. Every series is
necessarily to the left of the snapshot date (since all known values
must happen before the snapshot is taken<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Until we have a time machine&lt;/p&gt;"><sup>1</sup></a>). The black line
overlaying the various snapshots represents the “final value”, which is
just the snapshot at the last version in the archive (the
<code>versions_end</code>).</p>
<p>Comparing with the black line tells us how much the value at the time
of the snapshot differs with what was eventually reported. The drop in
January 2021 in the snapshot on <code>2021-02-01</code> was initially
reported as much steeper than it eventually turned out to be, while in
the period after that the values were initially reported as higher than
they actually were.</p>
<p>Handling data latency is important in both real-time forecasting and
retrospective forecasting. Looking at the very first snapshot,
<code>2020-08-01</code> (the purple dotted vertical line), there is a
noticeable gap between the forecast date and the end of the red
time-series to its left. In fact, if we take a snapshot and get the last
<code>time_value</code>,</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">doctor_visits</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epix_as_of.html" class="external-link">epix_as_of</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2020-08-01"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">time_value</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "2020-07-25"</span></span></code></pre></div>
<p>the last day of data is the 25th, a entire week before
<code>2020-08-01</code>. This can require some effort to work around,
especially if the latency is variable; see
<code><a href="../reference/step_adjust_latency.html">step_adjust_latency()</a></code> for some methods included in this
package. Much of that functionality is built into
<code><a href="../reference/arx_forecaster.html">arx_forecaster()</a></code> using the parameter
<code>adjust_ahead</code>, which we will use below.</p>
</div>
<div class="section level2">
<h2 id="backtesting-a-simple-autoregressive-forecaster">Backtesting a simple autoregressive forecaster<a class="anchor" aria-label="anchor" href="#backtesting-a-simple-autoregressive-forecaster"></a>
</h2>
<p>In addition to outlier detection and nowcasting, a common use case of
<code><a href="https://cmu-delphi.github.io/epiprocess/reference/epi_archive.html" class="external-link">epiprocess::epi_archive()</a></code> object is for accurate model
back-testing.</p>
<p>To start, let’s use a simple autoregressive forecaster to predict
<code>percent_cli</code>, the percentage of doctor’s hospital visits
associated with COVID-like illness, 14 days in the future. For increased
accuracy we will use quantile regression.</p>
<div class="section level3">
<h3 id="comparing-a-single-day-and-ahead">Comparing a single day and ahead<a class="anchor" aria-label="anchor" href="#comparing-a-single-day-and-ahead"></a>
</h3>
<p>As a sanity check before we backtest the <em>entire</em> dataset,
let’s forecast a single day in the middle of the dataset. We can do this
by setting the <code>.versions</code> argument in
<code><a href="https://cmu-delphi.github.io/epiprocess/reference/epix_slide.html" class="external-link">epix_slide()</a></code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">forecast_date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2021-04-06"</span><span class="op">)</span></span>
<span><span class="va">forecasts</span> <span class="op">&lt;-</span> <span class="va">doctor_visits</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epix_slide.html" class="external-link">epix_slide</a></span><span class="op">(</span></span>
<span>    <span class="op">~</span> <span class="fu"><a href="../reference/arx_forecaster.html">arx_forecaster</a></span><span class="op">(</span></span>
<span>      <span class="va">.x</span>,</span>
<span>      outcome <span class="op">=</span> <span class="st">"percent_cli"</span>,</span>
<span>      predictors <span class="op">=</span> <span class="st">"percent_cli"</span>,</span>
<span>      args_list <span class="op">=</span> <span class="fu"><a href="../reference/arx_args_list.html">arx_args_list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">)</span><span class="op">$</span><span class="va">predictions</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="../reference/pivot_quantiles.html">pivot_quantiles_wider</a></span><span class="op">(</span><span class="va">.pred_distn</span><span class="op">)</span>,</span>
<span>    .versions <span class="op">=</span> <span class="va">forecast_date</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>We need truth data to compare our forecast against. We can construct
it by using <code><a href="https://cmu-delphi.github.io/epiprocess/reference/epix_as_of.html" class="external-link">epix_as_of()</a></code> to snapshot the archive at the
last available date<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;For forecasting a single day like this, we could have
actually just used
&lt;code&gt;doctor_visits |&amp;gt; epix_as_of(forecast_date)&lt;/code&gt; to get the
relevant snapshot, and then fed that into &lt;code&gt;&lt;a href="../reference/arx_forecaster.html"&gt;arx_forecaster()&lt;/a&gt;&lt;/code&gt;
as we did in the &lt;a href="../index.html#motivating-example"&gt;landing
page&lt;/a&gt;.&lt;/p&gt;'><sup>2</sup></a>.</p>
<p><em>Note:</em> We always want to compare our forecasts to actual
(most recently reported) values because that is the outcome we care
about. <code>as_of</code> data is useful for understanding why we’re
getting the forecasts we’re getting, but <code>as_of</code> values are
only preliminary outcomes. Therefore, it’s not meaningful to use them
for evaluating the performance of a forecast. Unfortunately, it’s not
uncommon for revisions to cause poor (final) performance of a forecaster
that was decent at the time of the forecast.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">forecasts</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span></span>
<span>    <span class="va">doctor_visits</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epix_as_of.html" class="external-link">epix_as_of</a></span><span class="op">(</span><span class="va">doctor_visits</span><span class="op">$</span><span class="va">versions_end</span><span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"geo_value"</span>, <span class="st">"target_date"</span> <span class="op">=</span> <span class="st">"time_value"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">forecast_date</span>, <span class="va">.pred</span>, <span class="va">`0.05`</span>, <span class="va">`0.95`</span>, <span class="va">percent_cli</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 6</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">geo_value</span> <span style="font-weight: bold;">forecast_date</span> <span style="font-weight: bold;">.pred</span> <span style="font-weight: bold;">`0.05`</span> <span style="font-weight: bold;">`0.95`</span> <span style="font-weight: bold;">percent_cli</span></span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> ca        2021-04-03     6.79  2.63   11.0         4.06</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> fl        2021-04-03     7.40  3.23   11.6         5.10</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> ny        2021-04-03     8.05  3.88   12.2         6.92</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> tx        2021-04-03     5.00  0.836   9.17        3.25</span></span></code></pre></div>
<p><code>.pred</code> corresponds to the point forecast (median), and
<code>0.05</code> and <code>0.95</code> correspond to the 5th and 95th
quantiles. The <code>percent_cli</code> truth data falls within the
prediction intervals, so our implementation passes a simple
validation.</p>
</div>
<div class="section level3">
<h3 id="comparing-version-faithful-and-version-un-faithful-forecasts">Comparing version faithful and version un-faithful forecasts<a class="anchor" aria-label="anchor" href="#comparing-version-faithful-and-version-un-faithful-forecasts"></a>
</h3>
<p>Now let’s compare the behavior of this forecaster, both properly
considering data versioning (“version faithful”) and ignoring data
versions (“version un-faithful”).</p>
<p>For the version un-faithful approach, we need to do some setup if we
want to use <code>epix_slide</code> for backtesting. We want to simulate
a data set that receives finalized updates every day, that is, a data
set with no revisions. To do this, we will snapshot the latest version
of the data to create a synthetic data set, and convert it into an
archive where <code>version = time_value</code><a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Generally we advise against this; the only time to
consider faking versioning like this are if you’re back-testing data
with no versions available at all, or if you’re doing an explicit
comparison like this. If you have no versions you should assume
performance is worse than what the test would otherwise suggest.&lt;/p&gt;"><sup>3</sup></a>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">archive_cases_dv_subset_faux</span> <span class="op">&lt;-</span> <span class="va">doctor_visits</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epix_as_of.html" class="external-link">epix_as_of</a></span><span class="op">(</span><span class="va">doctor_visits</span><span class="op">$</span><span class="va">versions_end</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>version <span class="op">=</span> <span class="va">time_value</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epi_archive.html" class="external-link">as_epi_archive</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>For the version faithful approach, we will continue using the
original <code>epi_archive</code> object containing all version
updates.</p>
<p>We will also create the helper function
<code>forecast_wrapper()</code> to let us easily map across aheads.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">forecast_wrapper</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">epi_data</span>, <span class="va">aheads</span>, <span class="va">outcome</span>, <span class="va">predictors</span>, <span class="va">process_data</span> <span class="op">=</span> <span class="va">identity</span></span>
<span>    <span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span></span>
<span>    <span class="va">aheads</span>,</span>
<span>    \<span class="op">(</span><span class="va">ahead</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="../reference/arx_forecaster.html">arx_forecaster</a></span><span class="op">(</span></span>
<span>        <span class="fu">process_data</span><span class="op">(</span><span class="va">epi_data</span><span class="op">)</span>, <span class="va">outcome</span>, <span class="va">predictors</span>,</span>
<span>        args_list <span class="op">=</span> <span class="fu"><a href="../reference/arx_args_list.html">arx_args_list</a></span><span class="op">(</span></span>
<span>          ahead <span class="op">=</span> <span class="va">ahead</span>,</span>
<span>          lags <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">7</span>, <span class="fl">14</span>, <span class="fl">21</span><span class="op">)</span>,</span>
<span>          adjust_latency <span class="op">=</span> <span class="st">"extend_ahead"</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span><span class="op">$</span><span class="va">predictions</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/pivot_quantiles.html">pivot_quantiles_wider</a></span><span class="op">(</span><span class="va">.pred_distn</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><em>Note:</em> In the helper function, we’re using the parameter
<code>adjust_latency</code>. We need to use it because the most recently
released data may still be several days old on any given forecast date
(lag &gt; 0); <code>adjust_latency</code> will modify the forecaster to
compensate<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;In this case by adjusting the length of the ahead so
that it is actually forecasting from the last day of data (e.g. for 2
day latent data and a true ahead of 5, the &lt;code&gt;extended_ahead&lt;/code&gt;
would actually be 7)&lt;/p&gt;"><sup>4</sup></a>. See the function
<code><a href="../reference/step_adjust_latency.html">step_adjust_latency()</a></code> for more details and examples.</p>
<p>Now that we’re set up, we can generate forecasts for both the version
faithful and un-faithful archives, and bind the results together.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">forecast_dates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span></span>
<span>  from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2020-09-01"</span><span class="op">)</span>,</span>
<span>  to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2021-11-01"</span><span class="op">)</span>,</span>
<span>  by <span class="op">=</span> <span class="st">"1 month"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">aheads</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">7</span>, <span class="fl">14</span>, <span class="fl">21</span>, <span class="fl">28</span><span class="op">)</span></span>
<span></span>
<span><span class="va">version_unfaithful</span> <span class="op">&lt;-</span> <span class="va">archive_cases_dv_subset_faux</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epix_slide.html" class="external-link">epix_slide</a></span><span class="op">(</span></span>
<span>    <span class="op">~</span> <span class="fu">forecast_wrapper</span><span class="op">(</span><span class="va">.x</span>, <span class="va">aheads</span>, <span class="st">"percent_cli"</span>, <span class="st">"percent_cli"</span><span class="op">)</span>,</span>
<span>    .before <span class="op">=</span> <span class="fl">120</span>,</span>
<span>    .versions <span class="op">=</span> <span class="va">forecast_dates</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>version_faithful <span class="op">=</span> <span class="st">"Version un-faithful"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">version_faithful</span> <span class="op">&lt;-</span> <span class="va">doctor_visits</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epix_slide.html" class="external-link">epix_slide</a></span><span class="op">(</span></span>
<span>    <span class="op">~</span> <span class="fu">forecast_wrapper</span><span class="op">(</span><span class="va">.x</span>, <span class="va">aheads</span>, <span class="st">"percent_cli"</span>, <span class="st">"percent_cli"</span><span class="op">)</span>,</span>
<span>    .before <span class="op">=</span> <span class="fl">120</span>,</span>
<span>    .versions <span class="op">=</span> <span class="va">forecast_dates</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>version_faithful <span class="op">=</span> <span class="st">"Version faithful"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">forecasts</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>    <span class="va">version_unfaithful</span>,</span>
<span>    <span class="va">version_faithful</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><code><a href="../reference/arx_forecaster.html">arx_forecaster()</a></code> does all the heavy lifting. It creates
and lags copies of the features (here, the response and doctors visits),
creates and leads copies of the target while respecting timestamps and
locations, fits a forecasting model using the specified engine, creates
predictions, and creates non-parametric confidence bands.</p>
<p>To see how the version faithful and un-faithful predictions compare,
let’s plot them on top of the latest case rates, using the same
versioned plotting method as above. Note that even though we fit the
model on four states (California, Texas, Florida, and New York), we’ll
just display the results for two states, California (CA) and Florida
(FL), to get a sense of the model performance while keeping the graphic
simpler.</p>
<details><summary>
Code for plotting
</summary><div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">geo_choose</span> <span class="op">&lt;-</span> <span class="st">"ca"</span></span>
<span><span class="va">forecasts_filtered</span> <span class="op">&lt;-</span> <span class="va">forecasts</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">geo_value</span> <span class="op">==</span> <span class="va">geo_choose</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>time_value <span class="op">=</span> <span class="va">version</span><span class="op">)</span></span>
<span><span class="co"># we need to add the ground truth data to the version faithful plot as well</span></span>
<span><span class="va">plotting_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="va">percent_cli_data</span>,</span>
<span>  <span class="va">percent_cli_data</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">version_faithful</span> <span class="op">==</span> <span class="st">"Version un-faithful"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>version <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">percent_cli_data</span><span class="op">$</span><span class="va">version</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>version_faithful <span class="op">=</span> <span class="st">"Version faithful"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">forecasts_filtered</span>,</span>
<span>             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">target_date</span>, group <span class="op">=</span> <span class="va">time_value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">`0.05`</span>, ymax <span class="op">=</span> <span class="va">`0.95`</span>, fill <span class="op">=</span> <span class="op">(</span><span class="va">time_value</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.pred</span>, color <span class="op">=</span> <span class="op">(</span><span class="va">time_value</span><span class="op">)</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="fl">2L</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.pred</span>, color <span class="op">=</span> <span class="op">(</span><span class="va">time_value</span><span class="op">)</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># the forecast date</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">percent_cli_data</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">geo_value</span> <span class="op">==</span> <span class="va">geo_choose</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">version_faithful</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">version</span>, xintercept <span class="op">=</span> <span class="va">version</span>, group <span class="op">=</span> <span class="va">version</span><span class="op">)</span>,</span>
<span>    lty <span class="op">=</span> <span class="fl">2</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># the underlying data</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">plotting_data</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">geo_value</span> <span class="op">==</span> <span class="va">geo_choose</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time_value</span>, y <span class="op">=</span> <span class="va">percent_cli</span>, color <span class="op">=</span> <span class="op">(</span><span class="va">version</span><span class="op">)</span>, group <span class="op">=</span> <span class="va">version</span><span class="op">)</span>,</span>
<span>    inherit.aes <span class="op">=</span> <span class="cn">FALSE</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">version_faithful</span> <span class="op">~</span> <span class="va">geo_value</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html" class="external-link">scale_x_date</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="st">"2 months"</span>, date_labels <span class="op">=</span> <span class="st">"%b %Y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/expansion.html" class="external-link">expansion</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.05</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Date"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"smoothed, day of week adjusted covid-like doctors visits"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_c</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"viridis"</span>, direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"viridis"</span>, direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">geo_choose</span> <span class="op">&lt;-</span> <span class="st">"fl"</span></span>
<span><span class="va">forecasts_filtered</span> <span class="op">&lt;-</span> <span class="va">forecasts</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">geo_value</span> <span class="op">==</span> <span class="va">geo_choose</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>time_value <span class="op">=</span> <span class="va">version</span><span class="op">)</span></span>
<span></span>
<span><span class="va">forecasts_filtered</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="va">names</span></span>
<span><span class="co">#&gt;  [1] "version"          "geo_value"        ".pred"           </span></span>
<span><span class="co">#&gt;  [4] "forecast_date"    "target_date"      "0.05"            </span></span>
<span><span class="co">#&gt;  [7] "0.1"              "0.25"             "0.5"             </span></span>
<span><span class="co">#&gt; [10] "0.75"             "0.9"              "0.95"            </span></span>
<span><span class="co">#&gt; [13] "version_faithful" "time_value"</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">forecasts_filtered</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">target_date</span>, group <span class="op">=</span> <span class="va">time_value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">`0.05`</span>, ymax <span class="op">=</span> <span class="va">`0.95`</span>, fill <span class="op">=</span> <span class="op">(</span><span class="va">time_value</span><span class="op">)</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.pred</span>, color <span class="op">=</span> <span class="op">(</span><span class="va">time_value</span><span class="op">)</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="fl">2L</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.pred</span>, color <span class="op">=</span> <span class="op">(</span><span class="va">time_value</span><span class="op">)</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># the forecast date</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">percent_cli_data</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">geo_value</span> <span class="op">==</span> <span class="va">geo_choose</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">version_faithful</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">version</span>, xintercept <span class="op">=</span> <span class="va">version</span>, group <span class="op">=</span> <span class="va">version</span><span class="op">)</span>,</span>
<span>    lty <span class="op">=</span> <span class="fl">2</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># the underlying data</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">plotting_data</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">geo_value</span> <span class="op">==</span> <span class="va">geo_choose</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time_value</span>, y <span class="op">=</span> <span class="va">percent_cli</span>, color <span class="op">=</span> <span class="op">(</span><span class="va">version</span><span class="op">)</span>, group <span class="op">=</span> <span class="va">version</span><span class="op">)</span>,</span>
<span>    inherit.aes <span class="op">=</span> <span class="cn">FALSE</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">version_faithful</span> <span class="op">~</span> <span class="va">geo_value</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html" class="external-link">scale_x_date</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="st">"2 months"</span>, date_labels <span class="op">=</span> <span class="st">"%b %Y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/expansion.html" class="external-link">expansion</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.05</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Date"</span>, y <span class="op">=</span> <span class="st">"smoothed, day of week adjusted covid-like doctors visits"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_c</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"viridis"</span>, direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"viridis"</span>, direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span><span class="va">p2</span></span></code></pre></div>
<img src="backtesting_files/figure-html/plot_fl_forecasts-1.png" width="90%" style="display: block; margin: auto;"></details><p><img src="backtesting_files/figure-html/show-plot1-1.png" width="90%" style="display: block; margin: auto;"></p>
<p>There are some weeks when the forecasts are somewhat similar, and
others when they are wildly different, although neither approach
produces amazingly accurate forecasts.</p>
<p>In the version faithful case for California, the March 2021 forecast
(turquoise) starts at a value just above 10, which is very well lined up
with reported values leading up to that forecast. The measured and
forecasted trends are also concordant (both increasingly moderately
fast).</p>
<p>Because the data for this time period was later adjusted down with a
decreasing trend, the March 2021 forecast looks quite bad compared to
finalized data. The equivalent version un-faithful forecast starts at a
value of 5, which is in line with the finalized data but would have been
out of place compared to the version data.</p>
<p>The October 2021 forecast for the version faithful case floors out at
zero, whereas the un-faithful is much closer to the finalized data.</p>
<p><img src="backtesting_files/figure-html/show-plot2-1.png" width="90%" style="display: block; margin: auto;"></p>
<p>Now let’s look at Florida. In the version faithful case, the three
late-2021 forecasts (purples and pinks) starting in September predict
very low values, near 0. The trend leading up to each forecast shows a
substantial decrease, so these forecasts seem appropriate and we would
expect them to score fairly well on various performance metrics when
compared to the versioned data.</p>
<p>However in hindsight, we know that early versions of the data
systematically under-reported COVID-related doctor visits such that
these forecasts don’t actually perform well compared to
<em>finalized</em> data. In this example, version faithful forecasts
predicted values at or near 0 while finalized data shows values in the
5-10 range. As a result, the version un-faithful forecasts for these
same dates are quite a bit higher, and would perform well when scored
using the finalized data and poorly with versioned data.</p>
<p>In general, the longer ago a forecast was made, the worse its
performance is compared to finalized data. Finalized data accumulates
revisions over time that make it deviate more and more from the
non-finalized data a model was trained on. Forecasts <em>trained</em> on
finalized data will of course appear to perform better when
<em>scored</em> on finalized data, but will have unknown performance on
the non-finalized data we need to use if we want timely predictions.</p>
<p>Without using data that would have been available on the actual
forecast date, you have little insight into what level of performance
you can expect in practice.</p>
<p>Good performance of a version un-faithful model is a mirage; it is
only achievable if the training data has no revisions. If a data source
has any revisions, version un-faithful-level performance is unachievable
when making forecasts in real time.</p>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p><a href="https://delphi.cmu.edu/about/" class="external-link">About Delphi</a> • <a href="https://delphi.cmu.edu/epidemic-signals/terms-of-use/" class="external-link">Terms of Use</a> • <a href="https://docs.google.com/forms/u/1/d/e/1FAIpQLScqgT1fKZr5VWBfsaSp-DNaN03aV6EoZU4YljIzHJ1Wl_zmtg/viewform" class="external-link">Contact Us</a> • <a href="https://github.com/cmu-delphi/" class="external-link">Delphi GitHub</a> • <a href="https://cmu-delphi.github.io/delphi-epidata/" class="external-link">Epidata API</a></p>
</div>

<div class="pkgdown-footer-right">
  <p>epipredict</p>
</div>

    </footer>
</div>





  </body>
</html>
