<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Accurately backtesting forecasters • epipredict</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Open_Sans-0.4.9/font.css" rel="stylesheet">
<link href="../deps/Source_Serif_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Accurately backtesting forecasters">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">epipredict</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.1.11</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/epipredict.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/preprocessing-and-models.html">Examples of Preprocessing and Models</a></li>
    <li><a class="dropdown-item" href="../articles/backtesting.html">Accurately backtesting forecasters</a></li>
    <li><a class="dropdown-item" href="../articles/arx-classifier.html">Auto-regressive classifier</a></li>
    <li><a class="dropdown-item" href="../articles/update.html">Using the add/update/remove and adjust functions</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/cmu-delphi/epipredict/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Accurately backtesting forecasters</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/cmu-delphi/epipredict/blob/dev/vignettes/backtesting.Rmd" class="external-link"><code>vignettes/backtesting.Rmd</code></a></small>
      <div class="d-none name"><code>backtesting.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/cmu-delphi/epipredict/" class="external-link">epipredict</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://cmu-delphi.github.io/epiprocess/" class="external-link">epiprocess</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://cmu-delphi.github.io/epidatr/" class="external-link">epidatr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="accurately-backtesting-forecasters">Accurately backtesting forecasters<a class="anchor" aria-label="anchor" href="#accurately-backtesting-forecasters"></a>
</h2>
<p>Backtesting is a crucial step in the development of forecasting
models. It involves testing the model on historical data to see how well
it performs. This is important because it allows us to see how well the
model generalizes to new data and to identify any potential issues with
the model. In the context of epidemiological forecasting, to do
backtesting accurately, we need to account for the fact that the data
available at the time of the forecast would have been different from the
data available at the time of the backtest. This is because new data is
constantly being collected and added to the dataset, which can affect
the accuracy of the forecast.</p>
<p>For this reason, it is important to use version-aware forecasting,
where the model is trained on data that would have been available at the
time of the forecast. This ensures that the model is tested on data that
is as close as possible to what would have been available in real-time;
training and making predictions on finalized data can lead to an overly
optimistic sense of accuracy (see, for example, <a href="https://www.pnas.org/content/118/51/e2111453118/" class="external-link">McDonald et al.
(2021)</a> and the references therein).</p>
<p>In the <a href="https://cmu-delphi.github.io/epiprocess/" class="external-link">epiprocess</a> package, we provide
<code><a href="https://cmu-delphi.github.io/epiprocess/reference/epix_slide.html" class="external-link">epix_slide()</a></code>, a function that allows a convenient way to
perform version-aware forecasting by only using the data as it would
have been available at forecast reference time. In
<code><a href="https://cmu-delphi.github.io/epiprocess/articles/epi_archive.html" class="external-link">vignette("epi_archive", package = "epiprocess")</a></code>, we
introduced the concept of an <code>epi_archive</code> and we
demonstrated how to use <code><a href="https://cmu-delphi.github.io/epiprocess/reference/epix_slide.html" class="external-link">epix_slide()</a></code> to forecast the future
using a simple quantile regression model. In this vignette, we will
demonstrate how to use <code><a href="https://cmu-delphi.github.io/epiprocess/reference/epix_slide.html" class="external-link">epix_slide()</a></code> to backtest an
auto-regressive forecaster on historical COVID-19 case data from the US
and Canada. Instead of building a forecaster from scratch as we did in
the previous vignette, we will use the <code><a href="../reference/arx_forecaster.html">arx_forecaster()</a></code>
function from the <a href="https://github.com/cmu-delphi/epipredict/" class="external-link">epipredict</a> package.</p>
<div class="section level3">
<h3 id="getting-case-data-from-us-states-into-an-epi_archive">Getting case data from US states into an
<code>epi_archive</code><a class="anchor" aria-label="anchor" href="#getting-case-data-from-us-states-into-an-epi_archive"></a>
</h3>
<p>First, we download the version history (ie. archive) of the
percentage of doctor’s visits with CLI (COVID-like illness) computed
from medical insurance claims and the number of new confirmed COVID-19
cases per 100,000 population (daily) for 6 states from the COVIDcast API
(as used in the <code>epiprocess</code> vignette mentioned above).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Select the `percent_cli` column from the data archive</span></span>
<span><span class="va">doctor_visits</span> <span class="op">&lt;-</span> <span class="va">archive_cases_dv_subset</span><span class="op">$</span><span class="va">DT</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">time_value</span>, <span class="va">version</span>, <span class="va">percent_cli</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html" class="external-link">drop_na</a></span><span class="op">(</span><span class="va">percent_cli</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epi_archive.html" class="external-link">as_epi_archive</a></span><span class="op">(</span>compactify <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>The data can also be fetched from the Delphi Epidata API with the
following query:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://cmu-delphi.github.io/epidatr/" class="external-link">epidatr</a></span><span class="op">)</span></span>
<span><span class="va">doctor_visits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://cmu-delphi.github.io/epidatr/reference/pub_covidcast.html" class="external-link">pub_covidcast</a></span><span class="op">(</span></span>
<span>  source <span class="op">=</span> <span class="st">"doctor-visits"</span>,</span>
<span>  signals <span class="op">=</span> <span class="st">"smoothed_adj_cli"</span>,</span>
<span>  geo_type <span class="op">=</span> <span class="st">"state"</span>,</span>
<span>  time_type <span class="op">=</span> <span class="st">"day"</span>,</span>
<span>  geo_values <span class="op">=</span> <span class="st">"ca,fl,ny,tx"</span>,</span>
<span>  time_values <span class="op">=</span> <span class="fu"><a href="https://cmu-delphi.github.io/epidatr/reference/epirange.html" class="external-link">epirange</a></span><span class="op">(</span><span class="fl">20200601</span>, <span class="fl">20211201</span><span class="op">)</span>,</span>
<span>  issues <span class="op">=</span> <span class="fu"><a href="https://cmu-delphi.github.io/epidatr/reference/epirange.html" class="external-link">epirange</a></span><span class="op">(</span><span class="fl">20200601</span>, <span class="fl">20211201</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>version <span class="op">=</span> <span class="va">issue</span>, percent_cli <span class="op">=</span> <span class="va">value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epi_archive.html" class="external-link">as_epi_archive</a></span><span class="op">(</span>compactify <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="backtesting-a-simple-autoregressive-forecaster">Backtesting a simple autoregressive forecaster<a class="anchor" aria-label="anchor" href="#backtesting-a-simple-autoregressive-forecaster"></a>
</h3>
<p>One of the most common use cases of
<code><a href="https://cmu-delphi.github.io/epiprocess/reference/epi_archive.html" class="external-link">epiprocess::epi_archive()</a></code> object is for accurate model
backtesting.</p>
<p>In this section we will:</p>
<ul>
<li>develop a simple autoregressive forecaster that predicts the next
value of the signal based on the current and past values of the signal
itself, and</li>
<li>demonstrate how to slide this forecaster over the
<code>epi_archive</code> object to produce forecasts at a few dates
date, using version-unaware and -aware computations,</li>
<li>compare the two approaches.</li>
</ul>
<p>To start, let’s use a simple autoregressive forecaster to predict the
percentage of doctor’s hospital visits with CLI (COVID-like illness)
(<code>percent_cli</code>) in the future (we choose this target because
of the dataset’s pattern of substantial revisions; forecasting doctor’s
visits is an unusual forecasting target otherwise). While some AR models
output single point forecasts, we will use quantile regression to
produce a point prediction along with an 90% uncertainty band,
represented by a predictive quantiles at the 5% and 95% levels (lower
and upper endpoints of the uncertainty band).</p>
<p>The <code><a href="../reference/arx_forecaster.html">arx_forecaster()</a></code> function wraps the autoregressive
forecaster we need and comes with sensible defaults:</p>
<ul>
<li>we specify the predicted outcome to be the percentage of doctor’s
visits with CLI (<code>percent_cli</code>),</li>
<li>we use a linear regression model as the engine,</li>
<li>the autoregressive features assume lags of 0, 7, and 14 days,</li>
<li>we forecast 7 days ahead.</li>
</ul>
<p>All these default settings and more can be seen by calling
<code><a href="../reference/arx_args_list.html">arx_args_list()</a></code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/arx_args_list.html">arx_args_list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> lags : <span style="color: #0000BB;">0</span>, <span style="color: #0000BB;">7</span>, and <span style="color: #0000BB;">14</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> ahead : <span style="color: #0000BB;">7</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> n_training : <span style="color: #0000BB;">Inf</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> quantile_levels : <span style="color: #0000BB;">0.05</span>, <span style="color: #0000BB;">0.1</span>, <span style="color: #0000BB;">0.25</span>, <span style="color: #0000BB;">0.5</span>, <span style="color: #0000BB;">0.75</span>, <span style="color: #0000BB;">0.9</span>, and <span style="color: #0000BB;">0.95</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> forecast_date : <span style="color: #0000BB;">"NULL"</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> target_date : <span style="color: #0000BB;">"NULL"</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> adjust_latency : <span style="color: #0000BB;">"none"</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> warn_latency : <span style="color: #0000BB;">TRUE</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> symmetrize : <span style="color: #0000BB;">TRUE</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> nonneg : <span style="color: #0000BB;">TRUE</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> max_lags : <span style="color: #0000BB;">14</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> quantile_by_key : <span style="color: #0000BB;">"_empty_"</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> check_enough_data_n : <span style="color: #0000BB;">"NULL"</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> check_enough_data_epi_keys : <span style="color: #0000BB;">"NULL"</span></span></span></code></pre></div>
<p>These can be modified as needed, by sending your desired arguments
into <code>arx_forecaster(args_list = arx_args_list())</code>. For now
we will use the defaults.</p>
<p><strong>Note</strong>: We will use a <strong>geo-pooled
approach</strong>, where we train the model on data from all states and
territories combined. This is because the data is quite similar across
states, and pooling the data can help improve the accuracy of the
forecasts, while also reducing the susceptibility of the model to noise.
In the interest of computational speed, we only use the 6 state dataset
here, but the full archive can be used in the same way and has performed
well in the past. Implementation-wise, geo-pooling is achieved by not
using <code>group_by(geo_value)</code> prior to
<code><a href="https://cmu-delphi.github.io/epiprocess/reference/epix_slide.html" class="external-link">epix_slide()</a></code>. In other cases, grouping may be preferrable,
so we leave it to the user to decide, but flag this modeling decision
here.</p>
<p>Let’s use the <code><a href="https://cmu-delphi.github.io/epiprocess/reference/epix_as_of.html" class="external-link">epix_as_of()</a></code> method to generate a snapshot
of the archive at the last date, and then run the forecaster.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Let's forecast 14 days prior to the last date in the archive, to compare.</span></span>
<span><span class="va">forecast_date</span> <span class="op">&lt;-</span> <span class="va">doctor_visits</span><span class="op">$</span><span class="va">versions_end</span> <span class="op">-</span> <span class="fl">14</span></span>
<span><span class="co"># The .versions argument selects only the last version in the archive and</span></span>
<span><span class="co"># produces a forecast only on that date.</span></span>
<span><span class="va">forecasts</span> <span class="op">&lt;-</span> <span class="va">doctor_visits</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epix_slide.html" class="external-link">epix_slide</a></span><span class="op">(</span></span>
<span>    <span class="op">~</span> <span class="fu"><a href="../reference/arx_forecaster.html">arx_forecaster</a></span><span class="op">(</span></span>
<span>      <span class="va">.x</span>,</span>
<span>      outcome <span class="op">=</span> <span class="st">"percent_cli"</span>,</span>
<span>      predictors <span class="op">=</span> <span class="st">"percent_cli"</span>,</span>
<span>      args_list <span class="op">=</span> <span class="fu"><a href="../reference/arx_args_list.html">arx_args_list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">)</span><span class="op">$</span><span class="va">predictions</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="../reference/pivot_quantiles_wider.html">pivot_quantiles_wider</a></span><span class="op">(</span><span class="va">.pred_distn</span><span class="op">)</span>,</span>
<span>    .versions <span class="op">=</span> <span class="va">forecast_date</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co"># Join the forecasts with with the latest data at the time of the forecast to</span></span>
<span><span class="co"># compare. Since `percent_cli` data has a few days of lag, we use `tidyr::fill` to</span></span>
<span><span class="co"># fill the missing values with the last observed value.</span></span>
<span><span class="va">forecasts</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span></span>
<span>    <span class="va">doctor_visits</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epix_as_of.html" class="external-link">epix_as_of</a></span><span class="op">(</span><span class="va">doctor_visits</span><span class="op">$</span><span class="va">versions_end</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://tidyr.tidyverse.org/reference/fill.html" class="external-link">fill</a></span><span class="op">(</span><span class="va">percent_cli</span><span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"geo_value"</span>, <span class="st">"target_date"</span> <span class="op">=</span> <span class="st">"time_value"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">forecast_date</span>, <span class="va">.pred</span>, <span class="va">`0.05`</span>, <span class="va">`0.95`</span>, <span class="va">percent_cli</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 6</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">geo_value</span> <span style="font-weight: bold;">forecast_date</span> <span style="font-weight: bold;">.pred</span> <span style="font-weight: bold;">`0.05`</span> <span style="font-weight: bold;">`0.95`</span> <span style="font-weight: bold;">percent_cli</span></span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> ca        2021-11-12     7.23  4.22   10.2         4.75</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> fl        2021-11-12     1.40  0       4.41        1.57</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> ny        2021-11-12     3.98  0.968   6.99        3.52</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> tx        2021-11-12     2.23  0       5.24        2.01</span></span></code></pre></div>
<p>The resulting epi_df now contains two new columns: <code>.pred</code>
and <code>.pred_distn</code>, corresponding to the point forecast
(median) and the quantile distribution containing our requested quantile
forecasts (in this case, 0.05 and 0.95) respectively. The forecasts fall
within the prediction interval, so our implementation passes a simple
validation.</p>
<p>Now let’s go ahead and slide this forecaster in a version unaware way
and a version aware way. For the version unaware way, we need to
snapshot the latest version of the data, and then make a faux archive by
setting <code>version = time_value</code>. This has the effect of
simulating a data set that receives the final version updates every day.
For the version aware way, we will simply use the true
<code>epi_archive</code> object.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">archive_cases_dv_subset_faux</span> <span class="op">&lt;-</span> <span class="va">doctor_visits</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epix_as_of.html" class="external-link">epix_as_of</a></span><span class="op">(</span><span class="va">doctor_visits</span><span class="op">$</span><span class="va">versions_end</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>version <span class="op">=</span> <span class="va">time_value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epi_archive.html" class="external-link">as_epi_archive</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>To reduce typing, we create the wrapper function
<code>forecast_k_week_ahead()</code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Latest snapshot of data, and forecast dates</span></span>
<span><span class="va">forecast_dates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2020-08-01"</span><span class="op">)</span>, to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2021-11-01"</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">"1 month"</span><span class="op">)</span></span>
<span><span class="va">aheads</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">7</span>, <span class="fl">14</span>, <span class="fl">21</span>, <span class="fl">28</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># @param epi_archive The epi_archive object to forecast from</span></span>
<span><span class="co"># @param ahead The number of days ahead to forecast</span></span>
<span><span class="co"># @param outcome The outcome variable to forecast</span></span>
<span><span class="co"># @param predictors The predictors to use in the model</span></span>
<span><span class="co"># @param forecast_dates The dates to forecast on</span></span>
<span><span class="co"># @param process_data A function to process the data before forecasting</span></span>
<span><span class="va">forecast_k_week_ahead</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">epi_archive</span>,</span>
<span>    <span class="va">ahead</span> <span class="op">=</span> <span class="fl">7</span>,</span>
<span>    <span class="va">outcome</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">predictors</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">forecast_dates</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">process_data</span> <span class="op">=</span> <span class="va">identity</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">forecast_dates</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">forecast_dates</span> <span class="op">&lt;-</span> <span class="va">epi_archive</span><span class="op">$</span><span class="va">versions_end</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">outcome</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">predictors</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Please specify the outcome and predictors."</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">epi_archive</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epix_slide.html" class="external-link">epix_slide</a></span><span class="op">(</span></span>
<span>      <span class="op">~</span> <span class="fu"><a href="../reference/arx_forecaster.html">arx_forecaster</a></span><span class="op">(</span></span>
<span>        <span class="fu">process_data</span><span class="op">(</span><span class="va">.x</span><span class="op">)</span>, <span class="va">outcome</span>, <span class="va">predictors</span>,</span>
<span>        args_list <span class="op">=</span> <span class="fu"><a href="../reference/arx_args_list.html">arx_args_list</a></span><span class="op">(</span>ahead <span class="op">=</span> <span class="va">ahead</span><span class="op">)</span></span>
<span>      <span class="op">)</span><span class="op">$</span><span class="va">predictions</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="../reference/pivot_quantiles_wider.html">pivot_quantiles_wider</a></span><span class="op">(</span><span class="va">.pred_distn</span><span class="op">)</span>,</span>
<span>      .before <span class="op">=</span> <span class="fl">120</span>,</span>
<span>      .versions <span class="op">=</span> <span class="va">forecast_dates</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate the forecasts and bind them together</span></span>
<span><span class="va">forecasts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">aheads</span>, <span class="op">~</span> <span class="fu">forecast_k_week_ahead</span><span class="op">(</span></span>
<span>    <span class="va">archive_cases_dv_subset_faux</span>,</span>
<span>    ahead <span class="op">=</span> <span class="va">.x</span>,</span>
<span>    outcome <span class="op">=</span> <span class="st">"percent_cli"</span>,</span>
<span>    predictors <span class="op">=</span> <span class="st">"percent_cli"</span>,</span>
<span>    forecast_dates <span class="op">=</span> <span class="va">forecast_dates</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>version_aware <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">aheads</span>, <span class="op">~</span> <span class="fu">forecast_k_week_ahead</span><span class="op">(</span></span>
<span>    <span class="va">doctor_visits</span>,</span>
<span>    ahead <span class="op">=</span> <span class="va">.x</span>,</span>
<span>    outcome <span class="op">=</span> <span class="st">"percent_cli"</span>,</span>
<span>    predictors <span class="op">=</span> <span class="st">"percent_cli"</span>,</span>
<span>    forecast_dates <span class="op">=</span> <span class="va">forecast_dates</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>version_aware <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Here, <code><a href="../reference/arx_forecaster.html">arx_forecaster()</a></code> does all the heavy lifting. It
creates leads of the target (respecting time stamps and locations) along
with lags of the features (here, the response and doctors visits),
estimates a forecasting model using the specified engine, creates
predictions, and non-parametric confidence bands.</p>
<p>To see how the predictions compare, we plot them on top of the latest
case rates. Note that even though we’ve fitted the model on all states,
we’ll just display the results for two states, California (CA) and
Florida (FL), to get a sense of the model performance while keeping the
graphic simple.</p>
<details><summary>
Code for plotting
</summary><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">geo_choose</span> <span class="op">&lt;-</span> <span class="st">"ca"</span></span>
<span><span class="va">forecasts_filtered</span> <span class="op">&lt;-</span> <span class="va">forecasts</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">geo_value</span> <span class="op">==</span> <span class="va">geo_choose</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>time_value <span class="op">=</span> <span class="va">version</span><span class="op">)</span></span>
<span><span class="va">percent_cli_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="co"># Snapshotted data for the version-aware forecasts</span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span></span>
<span>    <span class="va">forecast_dates</span>,</span>
<span>    <span class="op">~</span> <span class="va">doctor_visits</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epix_as_of.html" class="external-link">epix_as_of</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>version <span class="op">=</span> <span class="va">.x</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>version_aware <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="co"># Latest data for the version-unaware forecasts</span></span>
<span>  <span class="va">doctor_visits</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epix_as_of.html" class="external-link">epix_as_of</a></span><span class="op">(</span><span class="va">doctor_visits</span><span class="op">$</span><span class="va">versions_end</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>version_aware <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">geo_value</span> <span class="op">==</span> <span class="va">geo_choose</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">forecasts_filtered</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">target_date</span>, group <span class="op">=</span> <span class="va">time_value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">`0.05`</span>, ymax <span class="op">=</span> <span class="va">`0.95`</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">time_value</span><span class="op">)</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.pred</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">time_value</span><span class="op">)</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="fl">2L</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.pred</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">time_value</span><span class="op">)</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">percent_cli_data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">version</span><span class="op">)</span>, xintercept <span class="op">=</span> <span class="va">version</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">percent_cli_data</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time_value</span>, y <span class="op">=</span> <span class="va">percent_cli</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">version</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    inherit.aes <span class="op">=</span> <span class="cn">FALSE</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">version_aware</span> <span class="op">~</span> <span class="va">geo_value</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html" class="external-link">scale_x_date</a></span><span class="op">(</span>minor_breaks <span class="op">=</span> <span class="st">"month"</span>, date_labels <span class="op">=</span> <span class="st">"%b %y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/expansion.html" class="external-link">expansion</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.05</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Date"</span>, y <span class="op">=</span> <span class="st">"smoothed, day of week adjusted covid-like doctors visits"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">geo_choose</span> <span class="op">&lt;-</span> <span class="st">"fl"</span></span>
<span><span class="va">forecasts_filtered</span> <span class="op">&lt;-</span> <span class="va">forecasts</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">geo_value</span> <span class="op">==</span> <span class="va">geo_choose</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>time_value <span class="op">=</span> <span class="va">version</span><span class="op">)</span></span>
<span><span class="va">percent_cli_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="co"># Snapshotted data for the version-aware forecasts</span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span></span>
<span>    <span class="va">forecast_dates</span>,</span>
<span>    <span class="op">~</span> <span class="va">doctor_visits</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epix_as_of.html" class="external-link">epix_as_of</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>version <span class="op">=</span> <span class="va">.x</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>version_aware <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="co"># Latest data for the version-unaware forecasts</span></span>
<span>  <span class="va">doctor_visits</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epix_as_of.html" class="external-link">epix_as_of</a></span><span class="op">(</span><span class="va">doctor_visits</span><span class="op">$</span><span class="va">versions_end</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>version_aware <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">geo_value</span> <span class="op">==</span> <span class="va">geo_choose</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">forecasts_filtered</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">target_date</span>, group <span class="op">=</span> <span class="va">time_value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">`0.05`</span>, ymax <span class="op">=</span> <span class="va">`0.95`</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">time_value</span><span class="op">)</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.pred</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">time_value</span><span class="op">)</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="fl">2L</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.pred</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">time_value</span><span class="op">)</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">percent_cli_data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">version</span><span class="op">)</span>, xintercept <span class="op">=</span> <span class="va">version</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">percent_cli_data</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time_value</span>, y <span class="op">=</span> <span class="va">percent_cli</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">version</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    inherit.aes <span class="op">=</span> <span class="cn">FALSE</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">version_aware</span> <span class="op">~</span> <span class="va">geo_value</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html" class="external-link">scale_x_date</a></span><span class="op">(</span>minor_breaks <span class="op">=</span> <span class="st">"month"</span>, date_labels <span class="op">=</span> <span class="st">"%b %y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/expansion.html" class="external-link">expansion</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.05</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Date"</span>, y <span class="op">=</span> <span class="st">"smoothed, day of week adjusted covid-like doctors visits"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
</details><pre><code><span><span class="co">#&gt; Warning: Removed 544 rows containing missing values or values outside the scale range</span></span>
<span><span class="co">#&gt; (`geom_vline()`).</span></span></code></pre>
<p><img src="backtesting_files/figure-html/show-plot1-1.png" width="90%" style="display: block; margin: auto;"></p>
<pre><code><span><span class="co">#&gt; Warning: Removed 544 rows containing missing values or values outside the scale range</span></span>
<span><span class="co">#&gt; (`geom_vline()`).</span></span></code></pre>
<p><img src="backtesting_files/figure-html/show-plot1-2.png" width="90%" style="display: block; margin: auto;"></p>
<p>For the two states of interest, neither approach produces amazingly
accurate forecasts. However, the extent to which using versioned data
can affect backtesting, scoring, and therefore model choice for
production can be inferred from these plots.</p>
<div class="section level4">
<h4 id="example-using-case-data-from-canada">Example using case data from Canada<a class="anchor" aria-label="anchor" href="#example-using-case-data-from-canada"></a>
</h4>
<details><summary>
Data and forecasts. Similar to the above.
</summary><p>By leveraging the flexibility of <code>epiprocess</code>, we can
apply the same techniques to data from other sources. Since some
collaborators are in British Columbia, Canada, we’ll do essentially the
same thing for Canada as we did above.</p>
<p>The <a href="https://opencovid.ca/" class="external-link">COVID-19 Canada Open Data Working
Group</a> collects daily time series data on COVID-19 cases, deaths,
recoveries, testing and vaccinations at the health region and province
levels. Data are collected from publicly available sources such as
government datasets and news releases. Unfortunately, there is no simple
versioned source, so we have created our own from the Github commit
history.</p>
<p>First, we load versioned case rates at the provincial level. After
converting these to 7-day averages (due to highly variable provincial
reporting mismatches), we then convert the data to an
<code>epi_archive</code> object, and extract the latest version from it.
Finally, we run the same forcasting exercise as for the American data,
but here we compare the forecasts produced from using simple linear
regression with those from using boosted regression trees.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aheads</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">7</span>, <span class="fl">14</span>, <span class="fl">21</span>, <span class="fl">28</span><span class="op">)</span></span>
<span><span class="va">canada_archive</span> <span class="op">&lt;-</span> <span class="va">can_prov_cases</span></span>
<span><span class="va">canada_archive_faux</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epix_as_of.html" class="external-link">epix_as_of</a></span><span class="op">(</span><span class="va">canada_archive</span>, <span class="va">canada_archive</span><span class="op">$</span><span class="va">versions_end</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>version <span class="op">=</span> <span class="va">time_value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epi_archive.html" class="external-link">as_epi_archive</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># This function will add the 7-day average of the case rate to the data</span></span>
<span><span class="co"># before forecasting.</span></span>
<span><span class="va">smooth_cases</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">epi_df</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">epi_df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epi_slide_opt.html" class="external-link">epi_slide_mean</a></span><span class="op">(</span><span class="st">"case_rate"</span>, .window_size <span class="op">=</span> <span class="fl">7</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span>, .suffix <span class="op">=</span> <span class="st">"_{.n}dav"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">forecast_dates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html" class="external-link">seq.Date</a></span><span class="op">(</span></span>
<span>  from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">canada_archive</span><span class="op">$</span><span class="va">DT</span><span class="op">$</span><span class="va">version</span><span class="op">)</span>,</span>
<span>  to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">canada_archive</span><span class="op">$</span><span class="va">DT</span><span class="op">$</span><span class="va">version</span><span class="op">)</span>,</span>
<span>  by <span class="op">=</span> <span class="st">"1 month"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate the forecasts, and bind them together</span></span>
<span><span class="va">canada_forecasts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span></span>
<span>    <span class="va">aheads</span>,</span>
<span>    <span class="op">~</span> <span class="fu">forecast_k_week_ahead</span><span class="op">(</span></span>
<span>      <span class="va">canada_archive_faux</span>,</span>
<span>      ahead <span class="op">=</span> <span class="va">.x</span>,</span>
<span>      outcome <span class="op">=</span> <span class="st">"case_rate_7dav"</span>,</span>
<span>      predictors <span class="op">=</span> <span class="st">"case_rate_7dav"</span>,</span>
<span>      forecast_dates <span class="op">=</span> <span class="va">forecast_dates</span>,</span>
<span>      process_data <span class="op">=</span> <span class="va">smooth_cases</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>version_aware <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span></span>
<span>    <span class="va">aheads</span>,</span>
<span>    <span class="op">~</span> <span class="fu">forecast_k_week_ahead</span><span class="op">(</span></span>
<span>      <span class="va">canada_archive</span>,</span>
<span>      ahead <span class="op">=</span> <span class="va">.x</span>,</span>
<span>      outcome <span class="op">=</span> <span class="st">"case_rate_7dav"</span>,</span>
<span>      predictors <span class="op">=</span> <span class="st">"case_rate_7dav"</span>,</span>
<span>      forecast_dates <span class="op">=</span> <span class="va">forecast_dates</span>,</span>
<span>      process_data <span class="op">=</span> <span class="va">smooth_cases</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>version_aware <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The figures below shows the results for a single province.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">geo_choose</span> <span class="op">&lt;-</span> <span class="st">"Alberta"</span></span>
<span><span class="va">forecasts_filtered</span> <span class="op">&lt;-</span> <span class="va">canada_forecasts</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">geo_value</span> <span class="op">==</span> <span class="va">geo_choose</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>time_value <span class="op">=</span> <span class="va">version</span><span class="op">)</span></span>
<span><span class="va">case_rate_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="co"># Snapshotted data for the version-aware forecasts</span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span></span>
<span>    <span class="va">forecast_dates</span>,</span>
<span>    <span class="op">~</span> <span class="va">canada_archive</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epix_as_of.html" class="external-link">epix_as_of</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">smooth_cases</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>case_rate <span class="op">=</span> <span class="va">case_rate_7dav</span>, version <span class="op">=</span> <span class="va">.x</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>version_aware <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="co"># Latest data for the version-unaware forecasts</span></span>
<span>  <span class="va">canada_archive</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epix_as_of.html" class="external-link">epix_as_of</a></span><span class="op">(</span><span class="va">doctor_visits</span><span class="op">$</span><span class="va">versions_end</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">smooth_cases</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>case_rate <span class="op">=</span> <span class="va">case_rate_7dav</span>, version_aware <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">geo_value</span> <span class="op">==</span> <span class="va">geo_choose</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">forecasts_filtered</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">target_date</span>, group <span class="op">=</span> <span class="va">time_value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">`0.05`</span>, ymax <span class="op">=</span> <span class="va">`0.95`</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">time_value</span><span class="op">)</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.pred</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">time_value</span><span class="op">)</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="fl">2L</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.pred</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">time_value</span><span class="op">)</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">case_rate_data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">version</span><span class="op">)</span>, xintercept <span class="op">=</span> <span class="va">version</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">case_rate_data</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time_value</span>, y <span class="op">=</span> <span class="va">case_rate</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">version</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    inherit.aes <span class="op">=</span> <span class="cn">FALSE</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">version_aware</span> <span class="op">~</span> <span class="va">geo_value</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html" class="external-link">scale_x_date</a></span><span class="op">(</span>minor_breaks <span class="op">=</span> <span class="st">"month"</span>, date_labels <span class="op">=</span> <span class="st">"%b %y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/expansion.html" class="external-link">expansion</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.05</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Date"</span>, y <span class="op">=</span> <span class="st">"smoothed, day of week adjusted covid-like doctors visits"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
<p><img src="backtesting_files/figure-html/plot-can-fc-lr-1.png" width="90%" style="display: block; margin: auto;"></p>
</details>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p><a href="https://delphi.cmu.edu/about/" class="external-link">About Delphi</a> • <a href="https://delphi.cmu.edu/epidemic-signals/terms-of-use/" class="external-link">Terms of Use</a> • <a href="https://docs.google.com/forms/u/1/d/e/1FAIpQLScqgT1fKZr5VWBfsaSp-DNaN03aV6EoZU4YljIzHJ1Wl_zmtg/viewform" class="external-link">Contact Us</a> • <a href="https://github.com/cmu-delphi/" class="external-link">Delphi GitHub</a> • <a href="https://cmu-delphi.github.io/delphi-epidata/" class="external-link">Epidata API</a></p>
</div>

<div class="pkgdown-footer-right">
  <p>epipredict</p>
</div>

    </footer>
</div>





  </body>
</html>
