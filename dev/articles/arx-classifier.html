<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Auto-regressive classifier • epipredict</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Open_Sans-0.4.9/font.css" rel="stylesheet">
<link href="../deps/Source_Serif_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Auto-regressive classifier">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">epipredict</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.1.14</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/epipredict.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/preprocessing-and-models.html">Examples of Preprocessing and Models</a></li>
    <li><a class="dropdown-item" href="../articles/backtesting.html">Accurately backtesting forecasters</a></li>
    <li><a class="dropdown-item" href="../articles/arx-classifier.html">Auto-regressive classifier</a></li>
    <li><a class="dropdown-item" href="../articles/update.html">Using the add/update/remove and adjust functions</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/cmu-delphi/epipredict/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Auto-regressive classifier</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/cmu-delphi/epipredict/blob/dev/vignettes/arx-classifier.Rmd" class="external-link"><code>vignettes/arx-classifier.Rmd</code></a></small>
      <div class="d-none name"><code>arx-classifier.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="load-required-packages">Load required packages<a class="anchor" aria-label="anchor" href="#load-required-packages"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/cmu-delphi/epipredict/" class="external-link">epipredict</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="introducing-the-arx-classifier">Introducing the ARX classifier<a class="anchor" aria-label="anchor" href="#introducing-the-arx-classifier"></a>
</h2>
<p>The <code><a href="../reference/arx_classifier.html">arx_classifier()</a></code> is an autoregressive classification
model for <code>epi_df</code> data that is used to predict a discrete
class for each case under consideration. It is a direct forecaster in
that it estimates the classes at a specific horizon or ahead value.</p>
<p>To get a sense of how the <code><a href="../reference/arx_classifier.html">arx_classifier()</a></code> works, let’s
consider a simple example with minimal inputs. For this, we will use the
built-in <code>covid_case_death_rates</code> that contains confirmed
COVID-19 cases and deaths from JHU CSSE for all states over Dec 31, 2020
to Dec 31, 2021. From this, we’ll take a subset of data for five states
over June 4, 2021 to December 31, 2021. Our objective is to predict
whether the case rates are increasing when considering the 0, 7 and 14
day case rates:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">jhu</span> <span class="op">&lt;-</span> <span class="va">covid_case_death_rates</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">time_value</span> <span class="op">&gt;=</span> <span class="st">"2021-06-04"</span>,</span>
<span>    <span class="va">time_value</span> <span class="op">&lt;=</span> <span class="st">"2021-12-31"</span>,</span>
<span>    <span class="va">geo_value</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ca"</span>, <span class="st">"fl"</span>, <span class="st">"tx"</span>, <span class="st">"ny"</span>, <span class="st">"nj"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/arx_classifier.html">arx_classifier</a></span><span class="op">(</span><span class="va">jhu</span>, outcome <span class="op">=</span> <span class="st">"case_rate"</span>, predictors <span class="op">=</span> <span class="st">"case_rate"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">out</span><span class="op">$</span><span class="va">predictions</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 × 4</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">geo_value</span> <span style="font-weight: bold;">.pred_class</span> <span style="font-weight: bold;">forecast_date</span> <span style="font-weight: bold;">target_date</span></span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> ca        (-Inf,0.25] 2021-12-31    2022-01-07 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> fl        (-Inf,0.25] 2021-12-31    2022-01-07 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> nj        (-Inf,0.25] 2021-12-31    2022-01-07 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> ny        (-Inf,0.25] 2021-12-31    2022-01-07 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> tx        (-Inf,0.25] 2021-12-31    2022-01-07</span></span></code></pre></div>
<p>The key takeaway from the predictions is that there are two
prediction classes: (-Inf, 0.25] and (0.25, Inf). This is because for
our goal of classification the classes must be discrete. The
discretization of the real-valued outcome is controlled by the
<code>breaks</code> argument, which defaults to 0.25. Such breaks will
be automatically extended to cover the entire real line. For example,
the default break of 0.25 is silently extended to breaks = c(-Inf, .25,
Inf) and, therefore, results in two classes: [-Inf, 0.25] and (0.25,
Inf). These two classes are used to discretize the outcome. The
conversion of the outcome to such classes is handled internally. So if
discrete classes already exist for the outcome in the
<code>epi_df</code>, then we recommend to code a classifier from scratch
using the <code>epi_workflow</code> framework for more control.</p>
<p>The <code>trainer</code> is a <code>parsnip</code> model describing
the type of estimation such that <code>mode = "classification"</code> is
enforced. The two typical trainers that are used are
<code><a href="https://parsnip.tidymodels.org/reference/logistic_reg.html" class="external-link">parsnip::logistic_reg()</a></code> for two classes or
<code><a href="https://parsnip.tidymodels.org/reference/multinom_reg.html" class="external-link">parsnip::multinom_reg()</a></code> for more than two classes.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">workflows</span><span class="fu">::</span><span class="fu"><a href="https://hardhat.tidymodels.org/reference/hardhat-extract.html" class="external-link">extract_spec_parsnip</a></span><span class="op">(</span><span class="va">out</span><span class="op">$</span><span class="va">epi_workflow</span><span class="op">)</span></span>
<span><span class="co">#&gt; Logistic Regression Model Specification (classification)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Computational engine: glm</span></span></code></pre></div>
<p>From the parsnip model specification, we can see that the trainer
used is logistic regression, which is expected for our binary outcome.
More complicated trainers like <code><a href="https://parsnip.tidymodels.org/reference/naive_Bayes.html" class="external-link">parsnip::naive_Bayes()</a></code> or
<code><a href="https://parsnip.tidymodels.org/reference/rand_forest.html" class="external-link">parsnip::rand_forest()</a></code> may also be used (however, we will
stick to the basics in this gentle introduction to the classifier).</p>
<p>If you use the default trainer of logistic regression for binary
classification and you decide against using the default break of 0.25,
then you should only input one break so that there are two
classification bins to properly dichotomize the outcome. For example,
let’s set a break of 0.5 instead of relying on the default of 0.25. We
can do this by passing 0.5 to the <code>breaks</code> argument in
<code><a href="../reference/arx_class_args_list.html">arx_class_args_list()</a></code> as follows:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out_break_0.5</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/arx_classifier.html">arx_classifier</a></span><span class="op">(</span></span>
<span>  <span class="va">jhu</span>,</span>
<span>  outcome <span class="op">=</span> <span class="st">"case_rate"</span>,</span>
<span>  predictors <span class="op">=</span> <span class="st">"case_rate"</span>,</span>
<span>  args_list <span class="op">=</span> <span class="fu"><a href="../reference/arx_class_args_list.html">arx_class_args_list</a></span><span class="op">(</span></span>
<span>    breaks <span class="op">=</span> <span class="fl">0.5</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: glm.fit: algorithm did not converge</span></span>
<span><span class="co">#&gt; Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred</span></span>
<span></span>
<span><span class="va">out_break_0.5</span><span class="op">$</span><span class="va">predictions</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 × 4</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">geo_value</span> <span style="font-weight: bold;">.pred_class</span> <span style="font-weight: bold;">forecast_date</span> <span style="font-weight: bold;">target_date</span></span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> ca        (-Inf,0.5]  2021-12-31    2022-01-07 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> fl        (-Inf,0.5]  2021-12-31    2022-01-07 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> nj        (-Inf,0.5]  2021-12-31    2022-01-07 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> ny        (-Inf,0.5]  2021-12-31    2022-01-07 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> tx        (-Inf,0.5]  2021-12-31    2022-01-07</span></span></code></pre></div>
<p>Indeed, we can observe that the two <code>.pred_class</code> are now
(-Inf, 0.5] and (0.5, Inf). See <code><a href="../reference/arx_class_args_list.html">help(arx_class_args_list)</a></code>
for other available modifications.</p>
<p>Additional arguments that may be supplied to
<code><a href="../reference/arx_class_args_list.html">arx_class_args_list()</a></code> include the expected
<code>lags</code> and <code>ahead</code> arguments for an
autoregressive-type model. These have default values of 0, 7, and 14
days for the lags of the predictors and 7 days ahead of the forecast
date for predicting the outcome. There is also <code>n_training</code>
to indicate the upper bound for the number of training rows per key. If
you would like some practice with using this, then remove the filtering
command to obtain data within “2021-06-04” and “2021-12-31” and instead
set <code>n_training</code> to be the number of days between these two
dates, inclusive of the end points. The end results should be the same.
In addition to <code>n_training</code>, there are
<code>forecast_date</code> and <code>target_date</code> to specify the
date that the forecast is created and intended, respectively. We will
not dwell on such arguments here as they are not unique to this
classifier or absolutely essential to understanding how it operates. The
remaining arguments will be discussed organically, as they are needed to
serve our purposes. For information on any remaining arguments that are
not discussed here, please see the function documentation for a complete
list and their definitions.</p>
</div>
<div class="section level2">
<h2 id="example-of-using-the-arx-classifier">Example of using the ARX classifier<a class="anchor" aria-label="anchor" href="#example-of-using-the-arx-classifier"></a>
</h2>
<p>Now, to demonstrate the power and utility of this built-in arx
classifier, we will loosely adapt the classification example that was
written from scratch in
<code><a href="../articles/preprocessing-and-models.html">vignette("preprocessing-and-models")</a></code>. However, to keep
things simple and not merely a direct translation, we will only consider
two prediction categories and leave the extension to three as an
exercise for the reader.</p>
<p>To motivate this example, a major use of autoregressive
classification models is to predict upswings or downswings like in
hotspot prediction models to anticipate the direction of the outcome
(see <a href="https://www.pnas.org/doi/full/10.1073/pnas.2111453118" class="external-link">McDonald,
Bien, Green, Hu, et al. (2021)</a> for more on these). In our case, one
simple question that such models can help answer is… Do we expect that
the future will have increased case rates or not relative to the
present?</p>
<p>To answer this question, we can create a predictive model for
upswings and downswings of case rates rather than the raw case rates
themselves. For this situation, our target is to predict whether there
is an increase in case rates or not. Following <a href="https://www.pnas.org/doi/full/10.1073/pnas.2111453118" class="external-link">McDonald,
Bien, Green, Hu, et al.(2021)</a>, we look at the relative change
between
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Y</mi><mrow><mi>l</mi><mo>,</mo><mi>t</mi></mrow></msub><annotation encoding="application/x-tex">Y_{l,t}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Y</mi><mrow><mi>l</mi><mo>,</mo><mi>t</mi><mo>+</mo><mi>a</mi></mrow></msub><annotation encoding="application/x-tex">Y_{l, t+a}</annotation></semantics></math>,
where the former is the case rate at location
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>l</mi><annotation encoding="application/x-tex">l</annotation></semantics></math>
at time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>
and the latter is the rate for that location at time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>+</mo><mi>a</mi></mrow><annotation encoding="application/x-tex">t+a</annotation></semantics></math>.
Using these variables, we define a categorical response variable with
two classes</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>Z</mi><mrow><mi>l</mi><mo>,</mo><mi>t</mi></mrow></msub><mo>=</mo><mrow><mo stretchy="true" form="prefix">{</mo><mtable><mtr><mtd columnalign="center" style="text-align: center"><mtext mathvariant="normal">up,</mtext></mtd><mtd columnalign="center" style="text-align: center"><mrow><mtext mathvariant="normal">if </mtext><mspace width="0.333em"></mspace></mrow><msubsup><mi>Y</mi><mrow><mi>l</mi><mo>,</mo><mi>t</mi></mrow><mi>Δ</mi></msubsup><mo>&gt;</mo><mn>0.25</mn></mtd></mtr><mtr><mtd columnalign="center" style="text-align: center"><mtext mathvariant="normal">not up,</mtext></mtd><mtd columnalign="center" style="text-align: center"><mtext mathvariant="normal">otherwise</mtext></mtd></mtr></mtable></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
Z_{l,t} = \left\{\begin{matrix}
\text{up,} &amp; \text{if } Y_{l,t}^\Delta &gt; 0.25\\
\text{not up,} &amp; \text{otherwise}
\end{matrix}\right.
\end{align}</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>Y</mi><mrow><mi>l</mi><mo>,</mo><mi>t</mi></mrow><mi>Δ</mi></msubsup><mo>=</mo><mo stretchy="false" form="prefix">(</mo><msub><mi>Y</mi><mrow><mi>l</mi><mo>,</mo><mi>t</mi></mrow></msub><mo>−</mo><msub><mi>Y</mi><mrow><mi>l</mi><mo>,</mo><mi>t</mi><mo>−</mo><mn>7</mn></mrow></msub><mi>/</mi><msub><mi>Y</mi><mrow><mi>l</mi><mo>,</mo><mi>t</mi><mo>−</mo><mn>7</mn></mrow></msub></mrow><annotation encoding="application/x-tex">Y_{l,t}^\Delta = (Y_{l, t} - Y_{l, t-7} / Y_{l, t-7}</annotation></semantics></math>.
If
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msubsup><mi>Y</mi><mrow><mi>l</mi><mo>,</mo><mi>t</mi></mrow><mi>Δ</mi></msubsup><annotation encoding="application/x-tex">Y_{l,t}^\Delta</annotation></semantics></math>
&gt; 0.25, meaning that the number of new cases over the week has
increased by over 25%, then
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Z</mi><mrow><mi>l</mi><mo>,</mo><mi>t</mi></mrow></msub><annotation encoding="application/x-tex">Z_{l,t}</annotation></semantics></math>
is up. This is the criteria for location
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>l</mi><annotation encoding="application/x-tex">l</annotation></semantics></math>
to be a hotspot at time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>.
On the other hand, if
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msubsup><mi>Y</mi><mrow><mi>l</mi><mo>,</mo><mi>t</mi></mrow><mi>Δ</mi></msubsup><annotation encoding="application/x-tex">Y_{l,t}^\Delta</annotation></semantics></math>
$, then then
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Z</mi><mrow><mi>l</mi><mo>,</mo><mi>t</mi></mrow></msub><annotation encoding="application/x-tex">Z_{l,t}</annotation></semantics></math>
is categorized as not up, meaning that there has not been a &gt;25%
increase in the new cases over the past week.</p>
<p>The logistic regression model we use to predict this binary response
can be considered to be a simplification of the multinomial regression
model presented in
<code><a href="../articles/preprocessing-and-models.html">vignette("preprocessing-and-models")</a></code>:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>π</mi><mtext mathvariant="normal">up</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mi>P</mi><mi>r</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Z</mi><mrow><mi>l</mi><mo>,</mo><mi>t</mi></mrow></msub><mo>=</mo><mtext mathvariant="normal">up</mtext><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mfrac><msup><mi>e</mi><mrow><msub><mi>g</mi><mtext mathvariant="normal">up</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msup><mrow><mn>1</mn><mo>+</mo><msup><mi>e</mi><mrow><msub><mi>g</mi><mtext mathvariant="normal">up</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msup></mrow></mfrac><mo>,</mo></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>π</mi><mtext mathvariant="normal">not up</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mi>P</mi><mi>r</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Z</mi><mrow><mi>l</mi><mo>,</mo><mi>t</mi></mrow></msub><mo>=</mo><mtext mathvariant="normal">not up</mtext><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mn>1</mn><mo>−</mo><mi>P</mi><mi>r</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Z</mi><mrow><mi>l</mi><mo>,</mo><mi>t</mi></mrow></msub><mo>=</mo><mtext mathvariant="normal">up</mtext><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mfrac><mn>1</mn><mrow><mn>1</mn><mo>+</mo><msup><mi>e</mi><mrow><msub><mi>g</mi><mtext mathvariant="normal">up</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msup></mrow></mfrac></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\pi_{\text{up}}(x) &amp;= Pr(Z_{l, t} = \text{up}|x) = \frac{e^{g_{\text{up}}(x)}}{1 + e^{g_{\text{up}}(x)}}, \\
\pi_{\text{not up}}(x)&amp;= Pr(Z_{l, t} = \text{not up}|x) = 1 - Pr(Z_{l, t} = \text{up}|x)  = \frac{1}{1 + e^{g_{\text{up}}(x)}}
\end{align}</annotation></semantics></math> where</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>g</mi><mtext mathvariant="normal">up</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><mrow><mo>Pr</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Z</mi><mrow><mi>l</mi><mo>,</mo><mi>t</mi></mrow></msub><mo>=</mo><mtext mathvariant="normal">up</mtext><mo stretchy="false" form="postfix">|</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mo>Pr</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Z</mi><mrow><mi>l</mi><mo>,</mo><mi>t</mi></mrow></msub><mo>=</mo><mtext mathvariant="normal">not up</mtext><mo stretchy="false" form="postfix">|</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>β</mi><mn>10</mn></msub><mo>+</mo><msub><mi>β</mi><mn>11</mn></msub><msubsup><mi>Y</mi><mrow><mi>l</mi><mo>,</mo><mi>t</mi></mrow><mi>Δ</mi></msubsup><mo>+</mo><msub><mi>β</mi><mn>12</mn></msub><msubsup><mi>Y</mi><mrow><mi>l</mi><mo>,</mo><mi>t</mi><mo>−</mo><mn>7</mn></mrow><mi>Δ</mi></msubsup><mo>+</mo><msub><mi>β</mi><mn>13</mn></msub><msubsup><mi>Y</mi><mrow><mi>l</mi><mo>,</mo><mi>t</mi><mo>−</mo><mn>14</mn></mrow><mi>Δ</mi></msubsup><mi>.</mi></mrow><annotation encoding="application/x-tex">
g_{\text{up}}(x) = \log\left ( \frac{\Pr(Z_{l, t} = \text{up} \vert x)}{\Pr(Z_{l, t} = \text{not up} \vert x)} \right ) = \beta_{10} + \beta_{11}Y_{l,t}^\Delta + \beta_{12}Y_{l,t-7}^\Delta + \beta_{13}Y_{l,t-14}^\Delta.
</annotation></semantics></math></p>
<p>Now then, we will operate on the same subset of the
<code>covid_case_death_rates</code> that we used in our above example.
This time, we will use it to investigate whether the number of newly
reported cases over the past 7 days has increased by at least 25%
compared to the preceding week for our sample of states.</p>
<p>Notice that by using the <code><a href="../reference/arx_classifier.html">arx_classifier()</a></code> function we’ve
completely eliminated the need to manually categorize the response
variable and implement pre-processing steps, which was necessary in
<code><a href="../articles/preprocessing-and-models.html">vignette("preprocessing-and-models")</a></code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">log_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/arx_classifier.html">arx_classifier</a></span><span class="op">(</span></span>
<span>  <span class="va">jhu</span>,</span>
<span>  outcome <span class="op">=</span> <span class="st">"case_rate"</span>,</span>
<span>  predictors <span class="op">=</span> <span class="st">"case_rate"</span>,</span>
<span>  args_list <span class="op">=</span> <span class="fu"><a href="../reference/arx_class_args_list.html">arx_class_args_list</a></span><span class="op">(</span></span>
<span>    breaks <span class="op">=</span> <span class="fl">0.25</span> <span class="op">/</span> <span class="fl">7</span> <span class="co"># division by 7 gives weekly not daily</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">log_res</span><span class="op">$</span><span class="va">epi_workflow</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ══ Epi Workflow [trained] ═══════════════════════════════════════════════════</span></span>
<span><span class="co">#&gt; <span style="font-style: italic;">Preprocessor:</span> Recipe</span></span>
<span><span class="co">#&gt; <span style="font-style: italic;">Model:</span> logistic_reg()</span></span>
<span><span class="co">#&gt; <span style="font-style: italic;">Postprocessor:</span> Frosting</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Preprocessor ─────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 7 Recipe steps.</span></span>
<span><span class="co">#&gt; 1. step_growth_rate()</span></span>
<span><span class="co">#&gt; 2. step_epi_lag()</span></span>
<span><span class="co">#&gt; 3. step_epi_ahead()</span></span>
<span><span class="co">#&gt; 4. step_mutate()</span></span>
<span><span class="co">#&gt; 5. step_naomit()</span></span>
<span><span class="co">#&gt; 6. step_naomit()</span></span>
<span><span class="co">#&gt; 7. step_training_window()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Model ────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:  stats::glm(formula = ..y ~ ., family = stats::binomial, data = data)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;                      (Intercept)   lag_0_gr_7_rel_change_case_rate  </span></span>
<span><span class="co">#&gt;                           -1.603                            16.134  </span></span>
<span><span class="co">#&gt;  lag_7_gr_7_rel_change_case_rate  lag_14_gr_7_rel_change_case_rate  </span></span>
<span><span class="co">#&gt;                           25.265                            -1.893  </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Degrees of Freedom: 914 Total (i.e. Null);  911 Residual</span></span>
<span><span class="co">#&gt; Null Deviance:       1156 </span></span>
<span><span class="co">#&gt; Residual Deviance: 813.7     AIC: 821.7</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Postprocessor ────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 3 Frosting layers.</span></span>
<span><span class="co">#&gt; 1. layer_predict()</span></span>
<span><span class="co">#&gt; 2. layer_add_forecast_date()</span></span>
<span><span class="co">#&gt; 3. layer_add_target_date()</span></span>
<span><span class="co">#&gt; </span></span></code></pre></div>
<p>Comparing the pre-processing steps for this to those in the other
vignette, we can see that they are not precisely the same, but they
cover the same essentials of transforming <code>case_rate</code> to the
growth rate scale (<code><a href="../reference/step_growth_rate.html">step_growth_rate()</a></code>), lagging the
predictors (<code><a href="../reference/step_epi_shift.html">step_epi_lag()</a></code>), leading the response
(<code><a href="../reference/step_epi_shift.html">step_epi_ahead()</a></code>), which are both constructed from the
growth rates, and constructing the binary classification response
variable (<code><a href="https://recipes.tidymodels.org/reference/step_mutate.html" class="external-link">step_mutate()</a></code>).</p>
<p>On this topic, it is important to understand that we are not actually
concerned about the case values themselves. Rather we are concerned
whether the quantity of cases in the future is a lot larger than that in
the present. For this reason, the outcome does not remain as cases, but
rather it is transformed by using either growth rates (as the predictors
and outcome in our example are) or lagged differences. While the latter
is closer to the requirements for the <a href="https://github.com/cdcepi/Flusight-forecast-data/blob/745511c436923e1dc201dea0f4181f21a8217b52/data-experimental/README.md" class="external-link">2022-23
CDC Flusight Hospitalization Experimental Target</a>, and it is
conceptually easy to understand because it is simply the change of the
value for the horizon, it is not the default. The default is
<code>growth_rate</code>. One reason for this choice is because the
growth rate is on a rate scale, not on the absolute scale, so it fosters
comparability across locations without any conscious effort (on the
other hand, when using the <code>lag_difference</code> one would need to
take care to operate on rates per 100k and not raw counts). We utilize
<code><a href="https://cmu-delphi.github.io/epiprocess/reference/growth_rate.html" class="external-link">epiprocess::growth_rate()</a></code> to create the outcome using some
of the additional arguments. One important argument for the growth rate
calculation is the <code>method</code>. Only <code>rel_change</code> for
relative change should be used as the method because the test data is
the only data that is accessible and the other methods require access to
the training data.</p>
<p>The other optional arguments for controlling the growth rate
calculation (that can be inputted as <code>additional_gr_args</code>)
can be found in the documentation for
<code><a href="https://cmu-delphi.github.io/epiprocess/reference/growth_rate.html" class="external-link">epiprocess::growth_rate()</a></code> and the related
<code><a href="https://cmu-delphi.github.io/epiprocess/articles/growth_rate.html" class="external-link">vignette("growth_rate", package = "epiprocess")</a></code>.</p>
<div class="section level3">
<h3 id="visualizing-the-results">Visualizing the results<a class="anchor" aria-label="anchor" href="#visualizing-the-results"></a>
</h3>
<p>To visualize the prediction classes across the states for the target
date, we can plot our results as a heatmap. However, if we were to plot
the results for only one target date, like our 7-day ahead predictions,
then that would be a pretty sad heatmap (which would look more like a
bar chart than a heatmap)… So instead of doing that, let’s get
predictions for several aheads and plot a heatmap across the target
dates. To get the predictions across several ahead values, we will use
the map function in the same way that we did in other vignettes:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">multi_log_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">40</span>, <span class="op">~</span> <span class="fu"><a href="../reference/arx_classifier.html">arx_classifier</a></span><span class="op">(</span></span>
<span>  <span class="va">jhu</span>,</span>
<span>  outcome <span class="op">=</span> <span class="st">"case_rate"</span>,</span>
<span>  predictors <span class="op">=</span> <span class="st">"case_rate"</span>,</span>
<span>  args_list <span class="op">=</span> <span class="fu"><a href="../reference/arx_class_args_list.html">arx_class_args_list</a></span><span class="op">(</span></span>
<span>    breaks <span class="op">=</span> <span class="fl">0.25</span> <span class="op">/</span> <span class="fl">7</span>, <span class="co"># division by 7 gives weekly not daily</span></span>
<span>    ahead <span class="op">=</span> <span class="va">.x</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span><span class="op">$</span><span class="va">predictions</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/list_c.html" class="external-link">list_rbind</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred</span></span>
<span><span class="co">#&gt; Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred</span></span></code></pre></div>
<p>We can plot a the heatmap of the results over the aheads to see if
there’s anything novel or interesting to take away:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">multi_log_res</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">target_date</span>, <span class="va">geo_value</span>, fill <span class="op">=</span> <span class="va">.pred_class</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"State"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Target date"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_fill_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Set1"</span><span class="op">)</span></span></code></pre></div>
<p><img src="arx-classifier_files/figure-html/unnamed-chunk-8-1.png" width="90%" style="display: block; margin: auto;"></p>
<p>While there is a bit of variability near to the end, we can clearly
see that there are upswings for all states starting from the beginning
of January 2022, which we can recall was when there was a massive spike
in cases for many states. So our results seem to align well with what
actually happened at the beginning of January 2022.</p>
</div>
</div>
<div class="section level2">
<h2 id="a-brief-reflection">A brief reflection<a class="anchor" aria-label="anchor" href="#a-brief-reflection"></a>
</h2>
<p>The most noticeable benefit of using the
<code><a href="../reference/arx_classifier.html">arx_classifier()</a></code> function is the simplification and
reduction of the manual implementation of the classifier from about 30
down to 3 lines. However, as we noted before, the trade-off for
simplicity is control over the precise pre-processing, post-processing,
and additional features embedded in the coding of a classifier. So the
good thing is that <code>epipredict</code> provides both - a built-in
<code>arx_classifer()</code> or the means to implement your own
classifier from scratch by using the <code>epi_workflow</code>
framework. And which you choose will depend on the circumstances. Our
advice is to start with using the built-in classifier for ostensibly
simple projects and begin to implement your own when the modelling
project takes a complicated turn. To get some practice on coding up a
classifier by hand, consider translating this binary classification
model example to an <code>epi_workflow</code>, akin to that in
<code><a href="../articles/preprocessing-and-models.html">vignette("preprocessing-and-models")</a></code>.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p><a href="https://delphi.cmu.edu/about/" class="external-link">About Delphi</a> • <a href="https://delphi.cmu.edu/epidemic-signals/terms-of-use/" class="external-link">Terms of Use</a> • <a href="https://docs.google.com/forms/u/1/d/e/1FAIpQLScqgT1fKZr5VWBfsaSp-DNaN03aV6EoZU4YljIzHJ1Wl_zmtg/viewform" class="external-link">Contact Us</a> • <a href="https://github.com/cmu-delphi/" class="external-link">Delphi GitHub</a> • <a href="https://cmu-delphi.github.io/delphi-epidata/" class="external-link">Epidata API</a></p>
</div>

<div class="pkgdown-footer-right">
  <p>epipredict</p>
</div>

    </footer>
</div>





  </body>
</html>
