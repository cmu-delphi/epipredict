<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Custom Epiworkflows • epipredict</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Open_Sans-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Serif_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Custom Epiworkflows">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">epipredict</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/epipredict.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/custom_epiworkflows.html">Epiworkflows</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/backtesting.html">Backtesting</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/update.html">Using the add/update/remove/adjust functions</a></li>
    <li><a class="dropdown-item" href="../articles/panel-data.html">Using epipredict on non-epidemic panel data</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/cmu-delphi/epipredict/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Custom Epiworkflows</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/cmu-delphi/epipredict/blob/dev/vignettes/custom_epiworkflows.Rmd" class="external-link"><code>vignettes/custom_epiworkflows.Rmd</code></a></small>
      <div class="d-none name"><code>custom_epiworkflows.Rmd</code></div>
    </div>

    
    
<p>If you want to do custom data preprocessing or fit a model that isn’t
included in the canned workflows, you’ll need to write a custom
<code><a href="../reference/epi_workflow.html">epi_workflow()</a></code>. An <code><a href="../reference/epi_workflow.html">epi_workflow()</a></code> is a
sub-class of a <code><a href="https://workflows.tidymodels.org/reference/workflow.html" class="external-link">workflows::workflow()</a></code> from the
<a href="https://github.com/tidymodels/workflows" class="external-link">workflows</a> package designed to handle panel data
specifically.</p>
<p>To understand how to work with custom <code><a href="../reference/epi_workflow.html">epi_workflow()</a></code>s,
let’s recreate and then modify the <code>four_week_ahead</code> example
from the <a href="../index.html#motivating-example">landing page</a>.
Let’s first remind ourselves how to use a simple canned workflow:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">training_data</span> <span class="op">&lt;-</span> <span class="va">covid_case_death_rates</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time_value</span> <span class="op">&lt;=</span> <span class="va">forecast_date</span>, <span class="va">geo_value</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">used_locations</span><span class="op">)</span></span>
<span><span class="va">four_week_ahead</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/arx_forecaster.html">arx_forecaster</a></span><span class="op">(</span></span>
<span>  <span class="va">training_data</span>,</span>
<span>  outcome <span class="op">=</span> <span class="st">"death_rate"</span>,</span>
<span>  predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"case_rate"</span>, <span class="st">"death_rate"</span><span class="op">)</span>,</span>
<span>  args_list <span class="op">=</span> <span class="fu"><a href="../reference/arx_args_list.html">arx_args_list</a></span><span class="op">(</span></span>
<span>    lags <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">7</span>, <span class="fl">14</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">7</span>, <span class="fl">14</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    ahead <span class="op">=</span> <span class="fl">4</span> <span class="op">*</span> <span class="fl">7</span>,</span>
<span>    quantile_levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="fl">0.9</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">four_week_ahead</span><span class="op">$</span><span class="va">epi_workflow</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ══ Epi Workflow [trained] ═══════════════════════════════════════════════════</span></span>
<span><span class="co">#&gt; <span style="font-style: italic;">Preprocessor:</span> Recipe</span></span>
<span><span class="co">#&gt; <span style="font-style: italic;">Model:</span> linear_reg()</span></span>
<span><span class="co">#&gt; <span style="font-style: italic;">Postprocessor:</span> Frosting</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Preprocessor ─────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 7 Recipe steps.</span></span>
<span><span class="co">#&gt; 1. step_epi_lag()</span></span>
<span><span class="co">#&gt; 2. step_epi_lag()</span></span>
<span><span class="co">#&gt; 3. step_epi_ahead()</span></span>
<span><span class="co">#&gt; 4. step_naomit()</span></span>
<span><span class="co">#&gt; 5. step_naomit()</span></span>
<span><span class="co">#&gt; 6. step_training_window()</span></span>
<span><span class="co">#&gt; 7. check_enough_data()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Model ────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; stats::lm(formula = ..y ~ ., data = data)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;       (Intercept)    lag_0_case_rate    lag_1_case_rate    lag_2_case_rate  </span></span>
<span><span class="co">#&gt;        -0.0060191          0.0004648          0.0021793          0.0004928  </span></span>
<span><span class="co">#&gt;   lag_3_case_rate    lag_7_case_rate   lag_14_case_rate   lag_0_death_rate  </span></span>
<span><span class="co">#&gt;         0.0007806         -0.0021676          0.0018002          0.4258788  </span></span>
<span><span class="co">#&gt;  lag_7_death_rate  lag_14_death_rate  </span></span>
<span><span class="co">#&gt;         0.1632748         -0.1584456</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Postprocessor ────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 5 Frosting layers.</span></span>
<span><span class="co">#&gt; 1. layer_predict()</span></span>
<span><span class="co">#&gt; 2. layer_residual_quantiles()</span></span>
<span><span class="co">#&gt; 3. layer_add_forecast_date()</span></span>
<span><span class="co">#&gt; 4. layer_add_target_date()</span></span>
<span><span class="co">#&gt; 5. layer_threshold()</span></span>
<span><span class="co">#&gt; </span></span></code></pre></div>
<div class="section level2">
<h2 id="anatomy-of-an-epi_workflow">Anatomy of an <code>epi_workflow</code><a class="anchor" aria-label="anchor" href="#anatomy-of-an-epi_workflow"></a>
</h2>
<p>An <code><a href="../reference/epi_workflow.html">epi_workflow()</a></code> is an extension of a
<code><a href="https://workflows.tidymodels.org/reference/workflow.html" class="external-link">workflows::workflow()</a></code> that is specially designed to handle
panel data, and to apply custom post-processing steps to the output of a
model. All <code>epi_workflows</code>, including simple and canned
workflows, consist of 3 components, a preprocessor, trainer, and
postprocessor.</p>
<div class="section level4">
<h4 id="preprocessor">Preprocessor<a class="anchor" aria-label="anchor" href="#preprocessor"></a>
</h4>
<p>A preprocessor (in the context of epipredict this means a
<code>{recipe}</code>) transforms the data before model training and
prediction. Transformations can include converting counts to rates,
applying a running average to columns, or <a href="https://recipes.tidymodels.org/reference/index.html" class="external-link">any of the
<code>step</code>s found in <code>{recipes}</code></a>.</p>
<p>All workflows must include a preprocessor. The most basic
preprocessor just assigns roles to columns, telling the model in the
next step which to use as predictors or the outcome.</p>
<p>However, preprocessors can do much more. You can think of a
preprocessor as a more flexible <code>formula</code> that you would pass
to <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code>: <code>y ~ x1 + log(x2) + lag(x1, 5)</code>. The
simple model above internally runs 6 of these steps, such as creating
lagged predictor columns.</p>
<p>In general, there are 2 broad classes of transformation that
<a href="https://github.com/tidymodels/recipes" class="external-link">recipes</a> <code>step</code>s handle:</p>
<ul>
<li>Operations that are applied to both training and test data without
using stored information. Examples include taking the log of a variable,
leading or lagging columns, filtering out rows, handling dummy
variables, calculating growth rates, etc.</li>
<li>Operations that rely on stored information (parameters estimated
during training) to modify both train and test data. Examples include
centering by the mean, and normalizing the variance to be one
(whitening).</li>
</ul>
<p>We differentiate between these types of transformations because the
second type can result in information leakage if not done properly.
Information leakage or data leakage happens when a system has access to
information that would not have been available at prediction time and
could change our evaluation of the model’s real-world performance.</p>
<p>In the case of centering, we need to store the mean of the predictor
from the training data and use that value on the prediction data, rather
than using the mean of the test predictor for centering or including
test data in the mean calculation.</p>
<p>A major benefit of <a href="https://github.com/tidymodels/recipes" class="external-link">recipes</a> is that it prevents
information leakage. However, the <em>main</em> mechanism we rely on to
prevent data leakage in the context of epidemiological forecasting is
proper <a href="backtesting.html">backtesting</a>.</p>
</div>
<div class="section level4">
<h4 id="trainer">Trainer<a class="anchor" aria-label="anchor" href="#trainer"></a>
</h4>
<p>A trainer (aso called a model or engine) fits a
<a href="https://github.com/tidymodels/parsnip" class="external-link">parsnip</a> model to training data, and outputs a fitted
model object. Examples include linear regression, quantile regression,
or <a href="https://www.tidymodels.org/find/parsnip/" class="external-link">any
<code>{parsnip}</code> engine</a>. The <a href="https://github.com/tidymodels/parsnip" class="external-link">parsnip</a> front-end
abstracts away the differences in interface between a wide collection of
statistical models.</p>
<p>All workflows must include a model.</p>
</div>
<div class="section level4">
<h4 id="postprocessor">Postprocessor<a class="anchor" aria-label="anchor" href="#postprocessor"></a>
</h4>
<p>Generally a postprocessor modifies and formats the prediction after a
model has been fit. An <a href="https://github.com/cmu-delphi/epipredict/" class="external-link">epipredict</a> postprocessor is called
a <code><a href="../reference/frosting.html">frosting()</a></code>; there are alternatives such as <a href="https://tailor.tidymodels.org/" class="external-link">tailor</a> which performs
calibration.</p>
<p>The postprocessor is <em>optional</em>. It only needs to be included
in a workflow if you need to process the model output.</p>
<p>Each operation within a postprocessor is called a “layer” (functions
are named <code>layer_*</code>), and the stack of layers is known as
<code><a href="../reference/frosting.html">frosting()</a></code>, continuing the metaphor of baking a cake
established in <a href="https://github.com/tidymodels/recipes" class="external-link">recipes</a>. Some example operations
include:</p>
<ul>
<li>generating quantiles from purely point-prediction models</li>
<li>reverting transformations done in prior steps, such as converting
from rates back to counts</li>
<li>thresholding forecasts to remove negative values</li>
<li>generally adapting the format of the prediction to a downstream
use.</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="recreating-four_week_ahead-in-an-epi_workflow">Recreating <code>four_week_ahead</code> in an
<code>epi_workflow()</code><a class="anchor" aria-label="anchor" href="#recreating-four_week_ahead-in-an-epi_workflow"></a>
</h2>
<p>To understand how to create custom workflows, let’s first recreate
the simple canned <code><a href="../reference/arx_forecaster.html">arx_forecaster()</a></code> from scratch.</p>
<p>We’ll think through the following sub-steps:</p>
<ol style="list-style-type: decimal">
<li>Define the <code><a href="../reference/epi_recipe.html">epi_recipe()</a></code>, which contains the
preprocessing steps</li>
<li>Define the <code><a href="../reference/frosting.html">frosting()</a></code> which contains the
post-processing layers</li>
<li>Combine these with a trainer such as <code><a href="../reference/quantile_reg.html">quantile_reg()</a></code>
into an <code><a href="../reference/epi_workflow.html">epi_workflow()</a></code>, which we can then fit on the
training data</li>
<li>
<code><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit()</a></code> the workflow on some data</li>
<li>Grab the right prediction data using <code><a href="../reference/get_test_data.html">get_test_data()</a></code>
and apply the fit data to generate a prediction</li>
</ol>
<div class="section level3">
<h3 id="define-the-epi_recipe">Define the <code>epi_recipe()</code><a class="anchor" aria-label="anchor" href="#define-the-epi_recipe"></a>
</h3>
<p>The steps found in <code>four_week_ahead</code> look like:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">hardhat</span><span class="fu">::</span><span class="fu"><a href="https://hardhat.tidymodels.org/reference/hardhat-extract.html" class="external-link">extract_recipe</a></span><span class="op">(</span><span class="va">four_week_ahead</span><span class="op">$</span><span class="va">epi_workflow</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="font-weight: bold;">Epi Recipe</span> <span style="color: #00BBBB;">───────────────────────────────────────────────────────────────</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Inputs</span></span>
<span><span class="co">#&gt; Number of variables by role</span></span>
<span><span class="co">#&gt; raw:        2</span></span>
<span><span class="co">#&gt; geo_value:  1</span></span>
<span><span class="co">#&gt; time_value: 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Training information</span></span>
<span><span class="co">#&gt; Training data contained 856 data points and no incomplete rows.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Operations</span></span>
<span><span class="co">#&gt; 1. Lagging: <span style="color: #0000BB;">case_rate</span> by <span style="color: #0000BB;">0, 1, 2, 3, 7, 14</span> | <span style="font-style: italic;">Trained</span></span></span>
<span><span class="co">#&gt; 2. Lagging: <span style="color: #0000BB;">death_rate</span> by <span style="color: #0000BB;">0, 7, 14</span> | <span style="font-style: italic;">Trained</span></span></span>
<span><span class="co">#&gt; 3. Leading: <span style="color: #0000BB;">death_rate</span> by <span style="color: #0000BB;">28</span> | <span style="font-style: italic;">Trained</span></span></span>
<span><span class="co">#&gt; 4. <span style="color: #00BBBB;">•</span> Removing rows with NA values in: <span style="color: #0000BB;">lag_0_case_rate</span>, ... | <span style="font-style: italic;">Trained</span></span></span>
<span><span class="co">#&gt; 5. <span style="color: #00BBBB;">•</span> Removing rows with NA values in: <span style="color: #0000BB;">ahead_28_death_rate</span> | <span style="font-style: italic;">Trained</span></span></span>
<span><span class="co">#&gt; 6. <span style="color: #00BBBB;">•</span> # of recent observations per key limited to:: <span style="color: #0000BB;">Inf</span> | <span style="font-style: italic;">Trained</span></span></span>
<span><span class="co">#&gt; 7. <span style="color: #00BBBB;">•</span> Check enough data (n = 1) for: <span style="color: #0000BB;">lag_0_case_rate</span>, ... | <span style="font-style: italic;">Trained</span></span></span></code></pre></div>
<p>There are 6 steps we will need to recreate. Note that all steps in
the extracted recipe are marked as already having been
<code>Trained</code>. For steps such as
<code><a href="https://recipes.tidymodels.org/reference/step_BoxCox.html" class="external-link">recipes::step_BoxCox()</a></code> that have parameters that change
their behavior, this means that their parameters have already been
calculated based on the training data set.</p>
<p>Let’s create an <code><a href="../reference/epi_recipe.html">epi_recipe()</a></code> to hold the 6 steps:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">filtered_data</span> <span class="op">&lt;-</span> <span class="va">covid_case_death_rates</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time_value</span> <span class="op">&lt;=</span> <span class="va">forecast_date</span>, <span class="va">geo_value</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">used_locations</span><span class="op">)</span></span>
<span><span class="va">four_week_recipe</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epi_recipe.html">epi_recipe</a></span><span class="op">(</span></span>
<span>  <span class="va">filtered_data</span>,</span>
<span>  reference_date <span class="op">=</span> <span class="op">(</span><span class="va">filtered_data</span> <span class="op">%@%</span> <span class="va">metadata</span><span class="op">)</span><span class="op">$</span><span class="va">as_of</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The data set passed to <code>epi_recipe</code> isn’t required to be
the actual data set on which you are going to train the model. However,
it should have the same columns and the same metadata (such as
<code>as_of</code> and <code>other_keys</code>); it is typically easiest
just to use the training data itself.</p>
<p>This means that you can use the same workflow for multiple data sets
as long as the format remains the same. This might be useful if you
continue to get updates to a data set over time and you want to train a
new instance of the same model.</p>
<p>Then we can append each <code>step</code> using pipes. In principle,
the order matters, though for this recipe only
<code><a href="../reference/step_epi_naomit.html">step_epi_naomit()</a></code> and <code><a href="../reference/step_training_window.html">step_training_window()</a></code>
depend on the steps before them. The other steps can be thought of as
setting parameters that help specify later processing and
computation.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">four_week_recipe</span> <span class="op">&lt;-</span> <span class="va">four_week_recipe</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_epi_shift.html">step_epi_lag</a></span><span class="op">(</span><span class="va">case_rate</span>, lag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">7</span>, <span class="fl">14</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_epi_shift.html">step_epi_lag</a></span><span class="op">(</span><span class="va">death_rate</span>, lag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">7</span>, <span class="fl">14</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_epi_shift.html">step_epi_ahead</a></span><span class="op">(</span><span class="va">death_rate</span>, ahead <span class="op">=</span> <span class="fl">4</span> <span class="op">*</span> <span class="fl">7</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_epi_naomit.html">step_epi_naomit</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_training_window.html">step_training_window</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Note we said before that <code>four_week_ahead</code> contained 6
steps. We’ve only added <em>5</em> top-level steps here because
<code><a href="../reference/step_epi_naomit.html">step_epi_naomit()</a></code> is actually a wrapper around adding two
<code><a href="https://recipes.tidymodels.org/reference/step_naomit.html" class="external-link">step_naomit()</a></code>s, one for <code><a href="https://recipes.tidymodels.org/reference/has_role.html" class="external-link">all_predictors()</a></code> and
one for <code><a href="https://recipes.tidymodels.org/reference/has_role.html" class="external-link">all_outcomes()</a></code>. The <code><a href="https://recipes.tidymodels.org/reference/step_naomit.html" class="external-link">step_naomit()</a></code>s
differ in their treatment of the data at predict time.</p>
<p><code><a href="../reference/step_epi_shift.html">step_epi_lag()</a></code> and <code><a href="../reference/step_epi_shift.html">step_epi_ahead()</a></code> both
accept <a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">“tidy”
syntax</a> so processing can be applied to multiple columns at once. For
example, if we wanted to use the same lags for both
<code>case_rate</code> and <code>death_rate</code>, we could specify
them in a single step, like
<code>step_epi_lag(ends_with("rate"), lag = c(0, 7, 14))</code>.</p>
<p>In general, <a href="https://github.com/tidymodels/recipes" class="external-link">recipes</a> <code>step</code>s assign roles
(such as <code>predictor</code>, or <code>outcome</code>, see the <a href="https://recipes.tidymodels.org/articles/Roles.html" class="external-link">Roles vignette
for details</a>) to columns either by adding new columns or adjusting
existing ones. <code><a href="../reference/step_epi_shift.html">step_epi_lag()</a></code>, for example, creates a new
column for each lag with the name <code>lag_x_column_name</code> and
labels them each with the <code>predictor</code> role.
<code><a href="../reference/step_epi_shift.html">step_epi_ahead()</a></code> creates <code>ahead_x_column_name</code>
columns and labels each with the <code>outcome</code> role.</p>
<p>In general, to inspect the ‘prepared’ steps, we can run
<code><a href="https://recipes.tidymodels.org/reference/prep.html" class="external-link">prep()</a></code>, which fits any parameters used in the recipe,
calculates new columns, and assigns roles<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;Note that &lt;code&gt;&lt;a href="https://recipes.tidymodels.org/reference/prep.html" class="external-link"&gt;prep()&lt;/a&gt;&lt;/code&gt; and &lt;code&gt;&lt;a href="https://recipes.tidymodels.org/reference/bake.html" class="external-link"&gt;bake()&lt;/a&gt;&lt;/code&gt;
are standard &lt;a href="https://github.com/tidymodels/recipes" class="external-link"&gt;recipes&lt;/a&gt; functions, so any discussion of them
there applies just as well here. For example in the &lt;a href="https://www.tidymodels.org/learn/develop/recipes/#create-the-prep-method" class="external-link"&gt;guide
to creating a new step&lt;/a&gt;.&lt;/p&gt;'><sup>1</sup></a>. For example, we can
use <code><a href="https://recipes.tidymodels.org/reference/prep.html" class="external-link">prep()</a></code> to make sure that we are training on the correct
columns:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prepped</span> <span class="op">&lt;-</span> <span class="va">four_week_recipe</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html" class="external-link">prep</a></span><span class="op">(</span><span class="va">training_data</span><span class="op">)</span></span>
<span><span class="va">prepped</span><span class="op">$</span><span class="va">term_info</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">14</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 14 × 4</span></span></span>
<span><span class="co">#&gt;    <span style="font-weight: bold;">variable</span>            <span style="font-weight: bold;">type</span>    <span style="font-weight: bold;">role</span>       <span style="font-weight: bold;">source</span>  </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>               <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> geo_value           nominal geo_value  original</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> time_value          date    time_value original</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> case_rate           numeric raw        original</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> death_rate          numeric raw        original</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> lag_0_case_rate     numeric predictor  derived </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> lag_1_case_rate     numeric predictor  derived </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> lag_2_case_rate     numeric predictor  derived </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> lag_3_case_rate     numeric predictor  derived </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> lag_7_case_rate     numeric predictor  derived </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> lag_14_case_rate    numeric predictor  derived </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span> lag_0_death_rate    numeric predictor  derived </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">12</span> lag_7_death_rate    numeric predictor  derived </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">13</span> lag_14_death_rate   numeric predictor  derived </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">14</span> ahead_28_death_rate numeric outcome    derived</span></span></code></pre></div>
<p><code><a href="https://recipes.tidymodels.org/reference/bake.html" class="external-link">bake()</a></code> applies a prepared recipe to a (potentially new)
dataset to create the dataset as handed to the
<code><a href="../reference/epi_workflow.html">epi_workflow()</a></code>. We can inspect newly-created columns by
running <code><a href="https://recipes.tidymodels.org/reference/bake.html" class="external-link">bake()</a></code> on the recipe so far:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">four_week_recipe</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html" class="external-link">prep</a></span><span class="op">(</span><span class="va">training_data</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/bake.html" class="external-link">bake</a></span><span class="op">(</span><span class="va">training_data</span><span class="op">)</span></span>
<span><span class="co">#&gt; An `epi_df` object, 800 x 14 with metadata:</span></span>
<span><span class="co">#&gt; * geo_type  = state</span></span>
<span><span class="co">#&gt; * time_type = day</span></span>
<span><span class="co">#&gt; * as_of     = 2023-03-10</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 800 × 14</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">geo_value</span> <span style="font-weight: bold;">time_value</span> <span style="font-weight: bold;">case_rate</span> <span style="font-weight: bold;">death_rate</span> <span style="font-weight: bold;">lag_0_case_rate</span> <span style="font-weight: bold;">lag_1_case_rate</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">*</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> ca        2021-01-14     108.       1.22            108.            111. </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> ma        2021-01-14      88.7      0.893            88.7            92.0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> ny        2021-01-14      82.4      0.969            82.4            84.9</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> tx        2021-01-14      74.9      1.05             74.9            75.0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> ca        2021-01-15     104.       1.21            104.            108. </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> ma        2021-01-15      83.3      0.908            83.3            88.7</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 794 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 8 more variables: </span><span style="color: #949494; font-weight: bold;">lag_2_case_rate</span><span style="color: #949494;"> &lt;dbl&gt;, </span><span style="color: #949494; font-weight: bold;">lag_3_case_rate</span><span style="color: #949494;"> &lt;dbl&gt;, …</span></span></span></code></pre></div>
<p>This is also useful for debugging malfunctioning pipelines. You can
run <code><a href="https://recipes.tidymodels.org/reference/prep.html" class="external-link">prep()</a></code> and <code><a href="https://recipes.tidymodels.org/reference/bake.html" class="external-link">bake()</a></code> on a new recipe
containing a subset of <code>step</code>s – all <code>step</code>s from
the beginning up to the one that is misbehaving – from the full,
original recipe. This will return an evaluation of the
<code>recipe</code> up to that point so that you can see the data that
the misbehaving <code>step</code> is being applied to. It also allows
you to see the exact data that a later <a href="https://github.com/tidymodels/parsnip" class="external-link">parsnip</a> model is
trained on.</p>
</div>
<div class="section level3">
<h3 id="define-the-frosting">Define the <code>frosting()</code><a class="anchor" aria-label="anchor" href="#define-the-frosting"></a>
</h3>
<p>The post-processing <code>frosting</code> layers<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Think of baking a cake, where adding the frosting is the
last step in the process of actually baking.&lt;/p&gt;"><sup>2</sup></a> found in
<code>four_week_ahead</code> look like:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">epipredict</span><span class="fu">::</span><span class="fu"><a href="../reference/extract_frosting.html">extract_frosting</a></span><span class="op">(</span><span class="va">four_week_ahead</span><span class="op">$</span><span class="va">epi_workflow</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="font-weight: bold;">Frosting</span> <span style="color: #00BBBB;">─────────────────────────────────────────────────────────────────</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Layers</span></span>
<span><span class="co">#&gt; 1. Creating predictions: <span style="color: #0000BB;">"&lt;calculated&gt;"</span></span></span>
<span><span class="co">#&gt; 2. Resampling residuals for predictive quantiles: <span style="color: #0000BB;">"&lt;calculated&gt;"</span></span></span>
<span><span class="co">#&gt; 3. quantile_levels <span style="color: #0000BB;">0.1, 0.25, 0.5, 0.75, 0.9</span></span></span>
<span><span class="co">#&gt; 4. Adding forecast date: <span style="color: #0000BB;">"2021-08-01"</span></span></span>
<span><span class="co">#&gt; 5. Adding target date: <span style="color: #0000BB;">"2021-08-29"</span></span></span>
<span><span class="co">#&gt; 6. Thresholding predictions: <span style="color: #0000BB;">dplyr::starts_with(".pred")</span> to <span style="color: #0000BB;">[0, Inf)</span></span></span></code></pre></div>
<p><em>Note</em>: since <code>frosting</code> is unique to this package,
we’ve defined a custom function <code><a href="../reference/extract_frosting.html">extract_frosting()</a></code> to
inspect these steps.</p>
<p>Using the detailed information in the output above, we can recreate
the layers similar to how we defined the <code>recipe</code>
<code>step</code>s<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Note that the frosting doesn’t require any information
about the training data, since the output of the model only depends on
the model used.&lt;/p&gt;"><sup>3</sup></a>:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">four_week_layers</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/frosting.html">frosting</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_predict.html">layer_predict</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_residual_quantiles.html">layer_residual_quantiles</a></span><span class="op">(</span>quantile_levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="fl">0.9</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_add_forecast_date.html">layer_add_forecast_date</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_add_target_date.html">layer_add_target_date</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_threshold.html">layer_threshold</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><code><a href="../reference/layer_predict.html">layer_predict()</a></code> needs to be included in every
postprocessor to actually predict on the prediction data.</p>
<p>Most layers work with any engine or <code>step</code>s. There are a
couple of layers, however, that depend on whether the engine predicts
quantiles or point estimates.</p>
<p>The following layers are only supported by point estimate engines,
such as <code><a href="https://parsnip.tidymodels.org/reference/linear_reg.html" class="external-link">linear_reg()</a></code>:</p>
<ul>
<li>
<code><a href="../reference/layer_residual_quantiles.html">layer_residual_quantiles()</a></code>: for models that don’t
generate quantiles, the preferred method of generating quantiles. This
function uses the error residuals of the engine to calculate quantiles.
This will work for most <a href="https://github.com/tidymodels/parsnip" class="external-link">parsnip</a> engines.</li>
<li>
<code><a href="../reference/layer_predictive_distn.html">layer_predictive_distn()</a></code>: alternate method of
generating quantiles using an approximate parametric distribution. This
will work for linear regression specifically.</li>
</ul>
<p>On the other hand, the following layers are only supported by engines
that output quantiles, such as <code><a href="../reference/quantile_reg.html">quantile_reg()</a></code>:</p>
<ul>
<li>
<code><a href="../reference/layer_quantile_distn.html">layer_quantile_distn()</a></code>: adds the specified quantiles.
If the user-requested quantile levels differ from the ones actually fit,
they will be interpolated and/or extrapolated.</li>
<li>
<code><a href="../reference/layer_point_from_distn.html">layer_point_from_distn()</a></code>: this generates a point
estimate from a distribution (either median or mean), and, if used,
should be included after <code><a href="../reference/layer_quantile_distn.html">layer_quantile_distn()</a></code>.</li>
</ul>
</div>
<div class="section level3">
<h3 id="fitting-an-epi_workflow">Fitting an <code>epi_workflow()</code><a class="anchor" aria-label="anchor" href="#fitting-an-epi_workflow"></a>
</h3>
<p>Now that we have a recipe and some layers, we can assemble the
workflow. This is as simple as passing the component preprocessor,
model, and postprocessor into <code><a href="../reference/epi_workflow.html">epi_workflow()</a></code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">four_week_workflow</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epi_workflow.html">epi_workflow</a></span><span class="op">(</span></span>
<span>  <span class="va">four_week_recipe</span>,</span>
<span>  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/linear_reg.html" class="external-link">linear_reg</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">four_week_layers</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>After fitting it, we will have recreated
<code>four_week_ahead$epi_workflow</code>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_workflow</span> <span class="op">&lt;-</span> <span class="va">four_week_workflow</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="va">training_data</span><span class="op">)</span></span></code></pre></div>
<p>Running <code><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit()</a></code> calculates all preprocessor-required
parameters, and trains the model on the data passed in
<code><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit()</a></code>. However, it does not generate any predictions;
predictions need to be created in a separate step.</p>
</div>
<div class="section level3">
<h3 id="predicting">Predicting<a class="anchor" aria-label="anchor" href="#predicting"></a>
</h3>
<p>To make a prediction, it helps to narrow the data set down to the
relevant observations using <code><a href="../reference/get_test_data.html">get_test_data()</a></code>. We can still
generate predictions without doing this first, but it will predict on
<em>every</em> day in the data-set, and not just on the
<code>reference_date</code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">relevant_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_test_data.html">get_test_data</a></span><span class="op">(</span></span>
<span>  <span class="va">four_week_recipe</span>,</span>
<span>  <span class="va">training_data</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>In this example, we’re creating <code>relevant_data</code> from
<code>training_data</code>, but the data set we want predictions for
could be entirely new data, unrelated to the one we used when building
the workflow.</p>
<p>With a trained workflow and data in hand, we can actually make our
predictions:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_workflow</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">relevant_data</span><span class="op">)</span></span>
<span><span class="co">#&gt; An `epi_df` object, 4 x 6 with metadata:</span></span>
<span><span class="co">#&gt; * geo_type  = state</span></span>
<span><span class="co">#&gt; * time_type = day</span></span>
<span><span class="co">#&gt; * as_of     = 2023-03-10</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 6</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">geo_value</span> <span style="font-weight: bold;">time_value</span> <span style="font-weight: bold;">.pred</span> <span style="font-weight: bold;">.pred_distn</span> <span style="font-weight: bold;">forecast_date</span> <span style="font-weight: bold;">target_date</span></span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;qtls(5)&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> ca        2021-08-01 0.341     [0.341] 2021-08-01    2021-08-29 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> ma        2021-08-01 0.163     [0.163] 2021-08-01    2021-08-29 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> ny        2021-08-01 0.196     [0.196] 2021-08-01    2021-08-29 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> tx        2021-08-01 0.404     [0.404] 2021-08-01    2021-08-29</span></span></code></pre></div>
<p>Note that if we simply plug the full <code>training_data</code> into
<code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> we will still get predictions:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_workflow</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">training_data</span><span class="op">)</span></span>
<span><span class="co">#&gt; An `epi_df` object, 800 x 6 with metadata:</span></span>
<span><span class="co">#&gt; * geo_type  = state</span></span>
<span><span class="co">#&gt; * time_type = day</span></span>
<span><span class="co">#&gt; * as_of     = 2023-03-10</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 800 × 6</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">geo_value</span> <span style="font-weight: bold;">time_value</span> <span style="font-weight: bold;">.pred</span> <span style="font-weight: bold;">.pred_distn</span> <span style="font-weight: bold;">forecast_date</span> <span style="font-weight: bold;">target_date</span></span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;qtls(5)&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> ca        2021-01-14 0.997     [0.997] 2021-08-01    2021-08-29 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> ma        2021-01-14 0.835     [0.835] 2021-08-01    2021-08-29 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> ny        2021-01-14 0.868     [0.868] 2021-08-01    2021-08-29 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> tx        2021-01-14 0.581     [0.581] 2021-08-01    2021-08-29 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> ca        2021-01-15 0.869     [0.869] 2021-08-01    2021-08-29 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> ma        2021-01-15 0.830      [0.83] 2021-08-01    2021-08-29 </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 794 more rows</span></span></span></code></pre></div>
<p>The resulting tibble is 800 rows long, however. Passing the
non-subsetted data set produces forecasts for not just the requested
<code>reference_date</code>, but for every day in the data set that has
sufficient data to produce a prediction. To narrow this down, we could
filter to rows where the <code>time_value</code> matches the
<code>forecast_date</code>:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_workflow</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">training_data</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time_value</span> <span class="op">==</span> <span class="va">forecast_date</span><span class="op">)</span></span>
<span><span class="co">#&gt; An `epi_df` object, 4 x 6 with metadata:</span></span>
<span><span class="co">#&gt; * geo_type  = state</span></span>
<span><span class="co">#&gt; * time_type = day</span></span>
<span><span class="co">#&gt; * as_of     = 2023-03-10</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 6</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">geo_value</span> <span style="font-weight: bold;">time_value</span> <span style="font-weight: bold;">.pred</span> <span style="font-weight: bold;">.pred_distn</span> <span style="font-weight: bold;">forecast_date</span> <span style="font-weight: bold;">target_date</span></span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;qtls(5)&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> ca        2021-08-01 0.341     [0.341] 2021-08-01    2021-08-29 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> ma        2021-08-01 0.163     [0.163] 2021-08-01    2021-08-29 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> ny        2021-08-01 0.196     [0.196] 2021-08-01    2021-08-29 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> tx        2021-08-01 0.404     [0.404] 2021-08-01    2021-08-29</span></span></code></pre></div>
<p>This can be useful as a workaround when <code><a href="../reference/get_test_data.html">get_test_data()</a></code>
fails to pull enough data to produce a forecast. This is generally a
problem when the recipe (preprocessor) is sufficiently complicated, and
<code><a href="../reference/get_test_data.html">get_test_data()</a></code> can’t determine precisely what data is
required. The forecasts generated with <code>filter</code> and
<code>get_test_data</code> are identical.</p>
</div>
</div>
<div class="section level2">
<h2 id="extending-four_week_ahead">Extending <code>four_week_ahead</code><a class="anchor" aria-label="anchor" href="#extending-four_week_ahead"></a>
</h2>
<p>Now that we know how to create <code>four_week_ahead</code> from
scratch, we can start modifying the workflow to get custom behavior.</p>
<p>There are many ways we could modify <code>four_week_ahead</code>. We
might consider:</p>
<ul>
<li>Converting from rates to counts</li>
<li>Including a growth rate estimate as a predictor</li>
<li>Including a time component as a predictor — useful if we expect
there to be a strong seasonal component to the outcome</li>
<li>Scaling by a factor</li>
</ul>
<p>We will demonstrate a couple of these modifications below.</p>
<div class="section level3">
<h3 id="growth-rate">Growth rate<a class="anchor" aria-label="anchor" href="#growth-rate"></a>
</h3>
<p>Let’s say we’re interested in including growth rate as a predictor in
our model because we think it may potentially improve our forecast. We
can easily create a new growth rate column as a step in the
<code>epi_recipe</code>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">growth_rate_recipe</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epi_recipe.html">epi_recipe</a></span><span class="op">(</span></span>
<span>  <span class="va">covid_case_death_rates</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time_value</span> <span class="op">&lt;=</span> <span class="va">forecast_date</span>, <span class="va">geo_value</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">used_locations</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Calculate growth rate from death rate column.</span></span>
<span>  <span class="fu"><a href="../reference/step_growth_rate.html">step_growth_rate</a></span><span class="op">(</span><span class="va">death_rate</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_epi_shift.html">step_epi_lag</a></span><span class="op">(</span><span class="va">case_rate</span>, lag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">7</span>, <span class="fl">14</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_epi_shift.html">step_epi_lag</a></span><span class="op">(</span><span class="va">death_rate</span>, lag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">7</span>, <span class="fl">14</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_epi_shift.html">step_epi_ahead</a></span><span class="op">(</span><span class="va">death_rate</span>, ahead <span class="op">=</span> <span class="fl">4</span> <span class="op">*</span> <span class="fl">7</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_epi_naomit.html">step_epi_naomit</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_training_window.html">step_training_window</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Inspecting the newly added column:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">growth_rate_recipe</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html" class="external-link">prep</a></span><span class="op">(</span><span class="va">training_data</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/bake.html" class="external-link">bake</a></span><span class="op">(</span><span class="va">training_data</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span></span>
<span>    <span class="va">geo_value</span>, <span class="va">time_value</span>, <span class="va">case_rate</span>,</span>
<span>    <span class="va">death_rate</span>, <span class="va">gr_7_rel_change_death_rate</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">time_value</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; An `epi_df` object, 6 x 5 with metadata:</span></span>
<span><span class="co">#&gt; * geo_type  = state</span></span>
<span><span class="co">#&gt; * time_type = day</span></span>
<span><span class="co">#&gt; * as_of     = 2023-03-10</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 5</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">geo_value</span> <span style="font-weight: bold;">time_value</span> <span style="font-weight: bold;">case_rate</span> <span style="font-weight: bold;">death_rate</span> <span style="font-weight: bold;">gr_7_rel_change_death_rate</span></span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>                      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> tx        2021-07-27      19.8      0.104                    0.007<span style="text-decoration: underline;">21</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> tx        2021-07-28      23.6      0.118                    0.015<span style="text-decoration: underline;">9</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> tx        2021-07-29      23.4      0.122                    0.027<span style="text-decoration: underline;">2</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> tx        2021-07-30      27.6      0.128                    0.033<span style="text-decoration: underline;">9</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> tx        2021-07-31      30.7      0.132                    0.042<span style="text-decoration: underline;">1</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> tx        2021-08-01      30.7      0.136                    0.051<span style="text-decoration: underline;">6</span></span></span></code></pre></div>
<p>And the role:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prepped</span> <span class="op">&lt;-</span> <span class="va">growth_rate_recipe</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html" class="external-link">prep</a></span><span class="op">(</span><span class="va">training_data</span><span class="op">)</span></span>
<span><span class="va">prepped</span><span class="op">$</span><span class="va">term_info</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"gr"</span>, <span class="va">variable</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 4</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">variable</span>                   <span style="font-weight: bold;">type</span>    <span style="font-weight: bold;">role</span>      <span style="font-weight: bold;">source</span> </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> gr_7_rel_change_death_rate numeric predictor derived</span></span></code></pre></div>
<p>Let’s say we want to use <code><a href="../reference/quantile_reg.html">quantile_reg()</a></code> as the model.
Because <code><a href="../reference/quantile_reg.html">quantile_reg()</a></code> outputs quantiles only, we need to
change our <code>frosting</code> to convert a quantile distribution into
quantiles and point predictions. To do that, we need to switch out
<code><a href="../reference/layer_residual_quantiles.html">layer_residual_quantiles()</a></code> (used for converting point +
residuals output, e.g. from <code><a href="https://parsnip.tidymodels.org/reference/linear_reg.html" class="external-link">linear_reg()</a></code> into quantiles)
for <code><a href="../reference/layer_quantile_distn.html">layer_quantile_distn()</a></code> and
<code><a href="../reference/layer_point_from_distn.html">layer_point_from_distn()</a></code>:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">growth_rate_layers</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/frosting.html">frosting</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_predict.html">layer_predict</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_quantile_distn.html">layer_quantile_distn</a></span><span class="op">(</span></span>
<span>    quantile_levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="fl">0.9</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_point_from_distn.html">layer_point_from_distn</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_add_forecast_date.html">layer_add_forecast_date</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_add_target_date.html">layer_add_target_date</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_threshold.html">layer_threshold</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">growth_rate_workflow</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epi_workflow.html">epi_workflow</a></span><span class="op">(</span></span>
<span>  <span class="va">growth_rate_recipe</span>,</span>
<span>  <span class="fu"><a href="../reference/quantile_reg.html">quantile_reg</a></span><span class="op">(</span>quantile_levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="fl">0.9</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="va">growth_rate_layers</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">relevant_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_test_data.html">get_test_data</a></span><span class="op">(</span></span>
<span>  <span class="va">growth_rate_recipe</span>,</span>
<span>  <span class="va">training_data</span></span>
<span><span class="op">)</span></span>
<span><span class="va">gr_fit_workflow</span> <span class="op">&lt;-</span> <span class="va">growth_rate_workflow</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="va">training_data</span><span class="op">)</span></span>
<span><span class="va">gr_predictions</span> <span class="op">&lt;-</span> <span class="va">gr_fit_workflow</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">relevant_data</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time_value</span> <span class="op">==</span> <span class="va">forecast_date</span><span class="op">)</span></span></code></pre></div>
<details><summary>
Plot
</summary><p>We’ll reuse some code from the landing page to plot the result.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">forecast_date_label</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    geo_value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">used_locations</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    .response_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"case_rate"</span>, <span class="fl">4</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"death_rate"</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    dates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">forecast_date</span> <span class="op">-</span> <span class="fl">7</span> <span class="op">*</span> <span class="fl">2</span>, <span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">used_locations</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    heights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">150</span>, <span class="fl">4</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.30</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">result_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span></span>
<span>  object <span class="op">=</span> <span class="va">gr_fit_workflow</span>,</span>
<span>  predictions <span class="op">=</span> <span class="va">gr_predictions</span>,</span>
<span>  observed_response <span class="op">=</span> <span class="va">covid_case_death_rates</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">geo_value</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">used_locations</span>, <span class="va">time_value</span> <span class="op">&gt;</span> <span class="st">"2021-07-01"</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">forecast_date</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_text</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">forecast_date_label</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.response_name</span> <span class="op">==</span> <span class="st">"death_rate"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dates</span>, label <span class="op">=</span> <span class="st">"forecast\ndate"</span>, y <span class="op">=</span> <span class="va">heights</span><span class="op">)</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">3</span>, hjust <span class="op">=</span> <span class="st">"right"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html" class="external-link">scale_x_date</a></span><span class="op">(</span>date_breaks <span class="op">=</span> <span class="st">"3 months"</span>, date_labels <span class="op">=</span> <span class="st">"%Y %b"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</details><p><img src="custom_epiworkflows_files/figure-html/unnamed-chunk-2-1.png" width="90%" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="population-scaling">Population scaling<a class="anchor" aria-label="anchor" href="#population-scaling"></a>
</h3>
<p>Suppose we want to modify our predictions to return a rate
prediction, rather than the count prediction. To do that, we can adjust
<em>just</em> the <code>frosting</code> to perform post-processing on
our existing rates forecaster. Since rates are calculated as counts per
100 000 people, we will convert back to counts by multiplying rates by
the factor
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mfrac><mtext mathvariant="normal">regional population</mtext><mrow><mn>100</mn><mo>,</mo><mn>000</mn></mrow></mfrac><annotation encoding="application/x-tex">\frac{ \text{regional population} }{100,000}</annotation></semantics></math>.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">count_layers</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/frosting.html">frosting</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_predict.html">layer_predict</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_residual_quantiles.html">layer_residual_quantiles</a></span><span class="op">(</span>quantile_levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="fl">0.9</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_population_scaling.html">layer_population_scaling</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">".pred"</span><span class="op">)</span>,</span>
<span>    <span class="co"># `df` contains scaling values for all regions; in this case it is the state populations</span></span>
<span>    df <span class="op">=</span> <span class="fu">epidatasets</span><span class="fu">::</span><span class="va"><a href="https://cmu-delphi.github.io/epidatasets/reference/state_census.html" class="external-link">state_census</a></span>,</span>
<span>    df_pop_col <span class="op">=</span> <span class="st">"pop"</span>,</span>
<span>    create_new <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    <span class="co"># `rate_rescaling` gives the denominator of the existing rate predictions</span></span>
<span>    rate_rescaling <span class="op">=</span> <span class="fl">1e5</span>,</span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"geo_value"</span> <span class="op">=</span> <span class="st">"abbr"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_add_forecast_date.html">layer_add_forecast_date</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_add_target_date.html">layer_add_target_date</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_threshold.html">layer_threshold</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># building the new workflow</span></span>
<span><span class="va">count_workflow</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epi_workflow.html">epi_workflow</a></span><span class="op">(</span></span>
<span>  <span class="va">four_week_recipe</span>,</span>
<span>  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/linear_reg.html" class="external-link">linear_reg</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">count_layers</span></span>
<span><span class="op">)</span></span>
<span><span class="va">count_pred_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_test_data.html">get_test_data</a></span><span class="op">(</span><span class="va">four_week_recipe</span>, <span class="va">training_data</span><span class="op">)</span></span>
<span><span class="va">count_predictions</span> <span class="op">&lt;-</span> <span class="va">count_workflow</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="va">training_data</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">count_pred_data</span><span class="op">)</span></span>
<span></span>
<span><span class="va">count_predictions</span></span>
<span><span class="co">#&gt; An `epi_df` object, 4 x 6 with metadata:</span></span>
<span><span class="co">#&gt; * geo_type  = state</span></span>
<span><span class="co">#&gt; * time_type = day</span></span>
<span><span class="co">#&gt; * as_of     = 2023-03-10</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 6</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">geo_value</span> <span style="font-weight: bold;">time_value</span> <span style="font-weight: bold;">.pred</span> <span style="font-weight: bold;">.pred_distn</span> <span style="font-weight: bold;">forecast_date</span> <span style="font-weight: bold;">target_date</span></span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;qtls(5)&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> ca        2021-08-01 135.        [135] 2021-08-01    2021-08-29 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> ma        2021-08-01  11.3      [11.3] 2021-08-01    2021-08-29 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> ny        2021-08-01  38.2      [38.2] 2021-08-01    2021-08-29 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> tx        2021-08-01 117.        [117] 2021-08-01    2021-08-29</span></span></code></pre></div>
<p>note that we’ve used <code>tidyselect::starts_with(".pred")</code>
here, which will apply the function to both the <code>.pred</code> and
<code>.pred_distn</code> columns.</p>
</div>
</div>
<div class="section level2">
<h2 id="custom-classifier-workflow">Custom classifier workflow<a class="anchor" aria-label="anchor" href="#custom-classifier-workflow"></a>
</h2>
<p>Let’s work through an example of a more complicated kind of pipeline
you can build using the <code>epipredict</code> framework. This is a
hotspot prediction model, which predicts whether case rates are
increasing (<code>up</code>), decreasing (<code>down</code>) or flat
(<code>flat</code>). The model comes from a paper by McDonald, Bien,
Green, Hu et al<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;McDonald, Bien, Green, Hu, et al. “Can auxiliary
indicators improve COVID-19 forecasting and hotspot prediction?.”
Proceedings of the National Academy of Sciences 118.51 (2021):
e2111453118. &lt;a href="doi:10.1073/pnas.2111453118" class="uri"&gt;doi:10.1073/pnas.2111453118&lt;/a&gt;&lt;/p&gt;'><sup>4</sup></a>, and roughly serves as an extension of
<code><a href="../reference/arx_classifier.html">arx_classifier()</a></code>.</p>
<p>First, we need to add a factor version of <code>geo_value</code>, so
that it can be used as a feature.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">training_data</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">covid_case_death_rates</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time_value</span> <span class="op">&lt;=</span> <span class="va">forecast_date</span>, <span class="va">geo_value</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">used_locations</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>geo_value_factor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Then we put together the recipe, using a combination of base
<code>{recipe}</code> functions such as <code><a href="https://recipes.tidymodels.org/reference/roles.html" class="external-link">add_role()</a></code> and
<code><a href="https://recipes.tidymodels.org/reference/step_dummy.html" class="external-link">step_dummy()</a></code>, and <a href="https://github.com/cmu-delphi/epipredict/" class="external-link">epipredict</a> functions such
as <code><a href="../reference/step_growth_rate.html">step_growth_rate()</a></code>.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">classifier_recipe</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epi_recipe.html">epi_recipe</a></span><span class="op">(</span><span class="va">training_data</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Label `time_value` as predictor and do no other processing</span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/roles.html" class="external-link">add_role</a></span><span class="op">(</span><span class="va">time_value</span>, new_role <span class="op">=</span> <span class="st">"predictor"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Use one-hot encoding on `geo_value_factor` and label each resulting column as a predictor</span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_dummy.html" class="external-link">step_dummy</a></span><span class="op">(</span><span class="va">geo_value_factor</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Create and lag `case_rate` growth rate</span></span>
<span>  <span class="fu"><a href="../reference/step_growth_rate.html">step_growth_rate</a></span><span class="op">(</span><span class="va">case_rate</span>, role <span class="op">=</span> <span class="st">"none"</span>, prefix <span class="op">=</span> <span class="st">"gr_"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_epi_shift.html">step_epi_lag</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"gr_"</span><span class="op">)</span>, lag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">7</span>, <span class="fl">14</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_epi_shift.html">step_epi_ahead</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"gr_"</span><span class="op">)</span>, ahead <span class="op">=</span> <span class="fl">7</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># divide growth rate into 3 bins</span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_cut.html" class="external-link">step_cut</a></span><span class="op">(</span><span class="va">ahead_7_gr_7_rel_change_case_rate</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="op">-</span><span class="fl">0.2</span>, <span class="fl">0.25</span>, <span class="cn">Inf</span><span class="op">)</span> <span class="op">/</span> <span class="fl">7</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Drop unused columns based on role assignments. This is not strictly</span></span>
<span>  <span class="co"># necessary, as columns with roles unused in the model will be ignored anyway.</span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_rm.html" class="external-link">step_rm</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html" class="external-link">has_role</a></span><span class="op">(</span><span class="st">"none"</span><span class="op">)</span>, <span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html" class="external-link">has_role</a></span><span class="op">(</span><span class="st">"raw"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/step_epi_naomit.html">step_epi_naomit</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>This adds as predictors:</p>
<ul>
<li>time value as a continuous variable (via
<code><a href="https://recipes.tidymodels.org/reference/roles.html" class="external-link">add_role()</a></code>)</li>
<li>
<code>geo_value</code> as a set of indicator variables (via
<code><a href="https://recipes.tidymodels.org/reference/step_dummy.html" class="external-link">step_dummy()</a></code> and the previous
<code><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor()</a></code>)</li>
<li>growth rate of case rate, both at prediction time (no lag), and
lagged by one and two weeks</li>
</ul>
<p>The outcome variable is created by composing several steps together.
<code><a href="../reference/step_epi_shift.html">step_epi_ahead()</a></code> creates a column with the growth rate one
week into the future, and <code><a href="https://recipes.tidymodels.org/reference/step_mutate.html" class="external-link">step_mutate()</a></code> turns that column
into a factor with 3 possible values,</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Z</mi><mrow><mo>ℓ</mo><mo>,</mo><mi>t</mi></mrow></msub><mo>=</mo><mrow><mo stretchy="true" form="prefix">{</mo><mtable><mtr><mtd columnalign="left" style="text-align: left"><mtext mathvariant="normal">up</mtext><mo>,</mo></mtd><mtd columnalign="left" style="text-align: left"><mtext mathvariant="normal">if</mtext><mspace width="0.222em"></mspace><msubsup><mi>Y</mi><mrow><mo>ℓ</mo><mo>,</mo><mi>t</mi></mrow><mi>Δ</mi></msubsup><mo>&gt;</mo><mn>0.25</mn></mtd></mtr><mtr><mtd columnalign="left" style="text-align: left"><mtext mathvariant="normal">down</mtext><mo>,</mo></mtd><mtd columnalign="left" style="text-align: left"><mtext mathvariant="normal">if</mtext><mspace width="0.222em"></mspace><msubsup><mi>Y</mi><mrow><mo>ℓ</mo><mo>,</mo><mi>t</mi></mrow><mi>Δ</mi></msubsup><mo>&lt;</mo><mo>−</mo><mn>0.20</mn></mtd></mtr><mtr><mtd columnalign="left" style="text-align: left"><mtext mathvariant="normal">flat</mtext><mo>,</mo></mtd><mtd columnalign="left" style="text-align: left"><mtext mathvariant="normal">otherwise</mtext></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">
 Z_{\ell, t}=
    \begin{cases}
      \text{up}, &amp; \text{if}\ Y^{\Delta}_{\ell, t} &gt; 0.25 \\
      \text{down}, &amp; \text{if}\  Y^{\Delta}_{\ell, t} &lt; -0.20\\
      \text{flat}, &amp; \text{otherwise}
    \end{cases}
</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msubsup><mi>Y</mi><mrow><mo>ℓ</mo><mo>,</mo><mi>t</mi></mrow><mi>Δ</mi></msubsup><annotation encoding="application/x-tex">Y^{\Delta}_{\ell, t}</annotation></semantics></math>
is the growth rate at location
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mo>ℓ</mo><annotation encoding="application/x-tex">\ell</annotation></semantics></math>
and time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>.
<code>up</code> means that the <code>case_rate</code> is has increased
by at least 25%, while <code>down</code> means it has decreased by at
least 20%.</p>
<p>Note that in both <code><a href="../reference/step_growth_rate.html">step_growth_rate()</a></code> and
<code><a href="../reference/step_epi_shift.html">step_epi_ahead()</a></code> we explicitly assign the role
<code>none</code>. This is because those columns are used as
intermediaries to create predictor and outcome columns. Afterwards,
<code><a href="https://recipes.tidymodels.org/reference/step_rm.html" class="external-link">step_rm()</a></code> drops the temporary columns, along with the
original <code>role = "raw"</code> columns <code>death_rate</code> and
<code>case_rate</code>. Both <code>geo_value_factor</code> and
<code>time_value</code> are retained because their roles have been
reassigned.</p>
<p>To fit a 3-class classification model like this, we will need to use
a <a href="https://github.com/tidymodels/parsnip" class="external-link">parsnip</a> model that has
<code>mode = "classification"</code>. The simplest example of a
<a href="https://github.com/tidymodels/parsnip" class="external-link">parsnip</a> <code>classification</code>-<code>mode</code>
model is <code>multinomial_reg()</code>. The needed layers are more or
less the same as the <code><a href="https://parsnip.tidymodels.org/reference/linear_reg.html" class="external-link">linear_reg()</a></code> regression layers, with
the addition that we need to remove some <code>NA</code> values:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">frost</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/frosting.html">frosting</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_naomit.html">layer_naomit</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">".pred"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_add_forecast_date.html">layer_add_forecast_date</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/layer_add_target_date.html">layer_add_target_date</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epi_workflow.html">epi_workflow</a></span><span class="op">(</span></span>
<span>  <span class="va">classifier_recipe</span>,</span>
<span>  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/multinom_reg.html" class="external-link">multinom_reg</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">frost</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="va">training_data</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast</a></span><span class="op">(</span><span class="va">wf</span><span class="op">)</span></span>
<span><span class="co">#&gt; An `epi_df` object, 4 x 5 with metadata:</span></span>
<span><span class="co">#&gt; * geo_type  = state</span></span>
<span><span class="co">#&gt; * time_type = day</span></span>
<span><span class="co">#&gt; * as_of     = 2023-03-10</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 5</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">geo_value</span> <span style="font-weight: bold;">time_value</span> <span style="font-weight: bold;">.pred_class</span>   <span style="font-weight: bold;">forecast_date</span> <span style="font-weight: bold;">target_date</span></span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> ca        2021-08-01 (0.0357, Inf] 2021-08-01    2021-08-08 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> ma        2021-08-01 (0.0357, Inf] 2021-08-01    2021-08-08 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> ny        2021-08-01 (0.0357, Inf] 2021-08-01    2021-08-08 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> tx        2021-08-01 (0.0357, Inf] 2021-08-01    2021-08-08</span></span></code></pre></div>
<p>And comparing the result with the actual growth rates at that point
in time,</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">growth_rates</span> <span class="op">&lt;-</span> <span class="va">covid_case_death_rates</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">geo_value</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">used_locations</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co"># Multiply by 7 to estimate weekly equivalents</span></span>
<span>    case_gr <span class="op">=</span> <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/growth_rate.html" class="external-link">growth_rate</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time_value</span>, y <span class="op">=</span> <span class="va">case_rate</span><span class="op">)</span> <span class="op">*</span> <span class="fl">7</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">growth_rates</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time_value</span> <span class="op">==</span> <span class="st">"2021-08-01"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">death_rate</span><span class="op">)</span></span>
<span><span class="co">#&gt; An `epi_df` object, 4 x 4 with metadata:</span></span>
<span><span class="co">#&gt; * geo_type  = state</span></span>
<span><span class="co">#&gt; * time_type = day</span></span>
<span><span class="co">#&gt; * as_of     = 2023-03-10</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 4</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">geo_value</span> <span style="font-weight: bold;">time_value</span> <span style="font-weight: bold;">case_rate</span> <span style="font-weight: bold;">case_gr</span></span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> ca        2021-08-01     24.9    0.356</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> ma        2021-08-01      9.53   0.484</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> ny        2021-08-01     12.5    0.504</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> tx        2021-08-01     30.7    0.619</span></span></code></pre></div>
<p>we see that they’re all significantly higher than 25% per week
(36%-62%), which matches the classification model’s predictions.</p>
<p>See the <a href="https://cmu-delphi.github.io/delphi-tooling-book/preprocessing-and-models.html" class="external-link">tooling
book</a> for a more in-depth discussion of this example.</p>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p><a href="https://delphi.cmu.edu/about/" class="external-link">About Delphi</a> • <a href="https://delphi.cmu.edu/epidemic-signals/terms-of-use/" class="external-link">Terms of Use</a> • <a href="https://docs.google.com/forms/u/1/d/e/1FAIpQLScqgT1fKZr5VWBfsaSp-DNaN03aV6EoZU4YljIzHJ1Wl_zmtg/viewform" class="external-link">Contact Us</a> • <a href="https://github.com/cmu-delphi/" class="external-link">Delphi GitHub</a> • <a href="https://cmu-delphi.github.io/delphi-epidata/" class="external-link">Epidata API</a></p>
</div>

<div class="pkgdown-footer-right">
  <p>epipredict</p>
</div>

    </footer>
</div>





  </body>
</html>
