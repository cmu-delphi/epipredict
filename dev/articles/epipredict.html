<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Get started with epipredict • epipredict</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Open_Sans-0.4.9/font.css" rel="stylesheet">
<link href="../deps/Source_Serif_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Get started with epipredict">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">epipredict</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.1.15</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/epipredict.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/preprocessing-and-models.html">Examples of Preprocessing and Models</a></li>
    <li><a class="dropdown-item" href="../articles/backtesting.html">Accurately backtesting forecasters</a></li>
    <li><a class="dropdown-item" href="../articles/arx-classifier.html">Auto-regressive classifier</a></li>
    <li><a class="dropdown-item" href="../articles/update.html">Using the add/update/remove and adjust functions</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/cmu-delphi/epipredict/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Get started with epipredict</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/cmu-delphi/epipredict/blob/dev/vignettes/epipredict.Rmd" class="external-link"><code>vignettes/epipredict.Rmd</code></a></small>
      <div class="d-none name"><code>epipredict.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/parsnip" class="external-link">parsnip</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/workflows" class="external-link">workflows</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/recipes" class="external-link">recipes</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/cmu-delphi/epipredict/" class="external-link">epipredict</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="goals-for-the-package">Goals for the package<a class="anchor" aria-label="anchor" href="#goals-for-the-package"></a>
</h2>
<p>At a high level, our goal with <a href="https://github.com/cmu-delphi/epipredict/" class="external-link">epipredict</a> is to make
running simple Machine Learning / Statistical forecasters for
epidemiology easy. However, this package is extremely extensible, and
that is part of its utility. Our hope is that it is easy for users with
epi training and some statistics to fit baseline models while still
allowing those with more nuanced statistical understanding to create
complicated specializations using the same framework.</p>
<p>Serving both populations is the main motivation for our efforts, but
at the same time, we have tried hard to make it useful.</p>
<div class="section level3">
<h3 id="baseline-models">Baseline models<a class="anchor" aria-label="anchor" href="#baseline-models"></a>
</h3>
<p>We provide a set of basic, easy-to-use forecasters that work out of
the box. You should be able to do a reasonably limited amount of
customization on them. Any serious customization happens with the
framework discussed below).</p>
<p>For the basic forecasters, we provide:</p>
<ul>
<li>Baseline flat-line forecaster</li>
<li>Autoregressive forecaster</li>
<li>Autoregressive classifier</li>
</ul>
<p>All the forcasters we provide are built on our framework. So we will
use these basic models to illustrate its flexibility.</p>
</div>
<div class="section level3">
<h3 id="forecasting-framework">Forecasting framework<a class="anchor" aria-label="anchor" href="#forecasting-framework"></a>
</h3>
<p>Our framework for creating custom forecasters views the prediction
task as a set of modular components. There are four types of
components:</p>
<ol style="list-style-type: decimal">
<li>Preprocessor: make transformations to the data before model
training</li>
<li>Trainer: train a model on data, resulting in a fitted model
object</li>
<li>Predictor: make predictions, using a fitted model object and
processed test data</li>
<li>Postprocessor: manipulate or transform the predictions before
returning</li>
</ol>
<p>Users familiar with <a href="https://www.tidymodels.org" class="external-link"><code>{tidymodels}</code></a> and
especially the <a href="https://workflows.tidymodels.org" class="external-link"><code>{workflows}</code></a>
package will notice a lot of overlap. This is by design, and is in fact
a feature. The truth is that <a href="https://github.com/cmu-delphi/epipredict/" class="external-link">epipredict</a> is a wrapper
around much that is contained in these packages. Therefore, if you want
something from this -verse, it should “just work” (we hope).</p>
<p>The reason for the overlap is that <a href="https://github.com/tidymodels/workflows" class="external-link">workflows</a>
<em>already implements</em> the first three steps. And it does this very
well. However, it is missing the postprocessing stage and currently has
no plans for such an implementation. And this feature is important. The
baseline forecaster we provide <em>requires</em> postprocessing.
Anything more complicated needs this as well.</p>
<p>The second omission from <a href="https://tidymodels.tidymodels.org" class="external-link">tidymodels</a> is support for
panel data. Besides epidemiological data, economics, psychology,
sociology, and many other areas frequently deal with data of this type.
So the framework of behind <a href="https://github.com/cmu-delphi/epipredict/" class="external-link">epipredict</a> implements this. In
principle, this has nothing to do with epidemiology, and one could
simply use this package as a solution for the missing functionality in
<a href="https://tidymodels.tidymodels.org" class="external-link">tidymodels</a>. Again, this should “just work”.</p>
<p>All of the <em>panel data</em> functionality is implemented through
the <code>epi_df</code> data type in the companion <a href="https://cmu-delphi.github.io/epiprocess/" class="external-link"><code>{epiprocess}</code></a>
package. There is much more to see there, but for the moment, it’s
enough to look at a simple one:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">jhu</span> <span class="op">&lt;-</span> <span class="va">covid_case_death_rates</span></span>
<span><span class="va">jhu</span></span>
<span><span class="co">#&gt; An `epi_df` object, 20,496 x 4 with metadata:</span></span>
<span><span class="co">#&gt; * geo_type  = state</span></span>
<span><span class="co">#&gt; * time_type = day</span></span>
<span><span class="co">#&gt; * as_of     = 2023-03-10</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 20,496 × 4</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">geo_value</span> <span style="font-weight: bold;">time_value</span> <span style="font-weight: bold;">case_rate</span> <span style="font-weight: bold;">death_rate</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">*</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> ak        2020-12-31      35.9      0.158</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> al        2020-12-31      65.1      0.438</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> ar        2020-12-31      66.0      1.27 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> as        2020-12-31       0        0    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> az        2020-12-31      76.8      1.10 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> ca        2020-12-31      95.9      0.755</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 20,490 more rows</span></span></span></code></pre></div>
<p>This data is built into the package and contains the measured
variables <code>case_rate</code> and <code>death_rate</code> for
COVID-19 at the daily level for each US state for the year 2021. The
“panel” part is because we have repeated measurements across a number of
locations.</p>
<p>The <code>epi_df</code> encodes the time stamp as
<code>time_value</code> and the <code>key</code> as
<code>geo_value</code>. While these 2 names are required, the values
don’t need to actually represent such objects. Additional
<code>key</code>’s are also supported (like age group, ethnicity,
taxonomy, etc.).</p>
<p>The <code>epi_df</code> also contains some metadata that describes
the keys as well as the vintage of the data. It’s possible that data
collected at different times for the <em>same set</em> of
<code>geo_value</code>’s and <code>time_value</code>’s could actually be
different. For more details, see <a href="https://cmu-delphi.github.io/epiprocess/articles/epiprocess.html" class="external-link"><code>{epiprocess}</code></a>.</p>
</div>
<div class="section level3">
<h3 id="why-doesnt-this-package-already-exist">Why doesn’t this package already exist?<a class="anchor" aria-label="anchor" href="#why-doesnt-this-package-already-exist"></a>
</h3>
<p>As described above:</p>
<ul>
<li><p>Parts actually DO exist. There’s a universe called
<a href="https://tidymodels.tidymodels.org" class="external-link">tidymodels</a>. It handles preprocessing, training, and
prediction, bound together, through a package called
<a href="https://github.com/tidymodels/workflows" class="external-link">workflows</a>. We built <a href="https://github.com/cmu-delphi/epipredict/" class="external-link">epipredict</a> on top of
that setup. In this way, you CAN use almost everything they
provide.</p></li>
<li><p>However, <a href="https://github.com/tidymodels/workflows" class="external-link">workflows</a> doesn’t do postprocessing. And
nothing in the -verse handles <em>panel data</em>.</p></li>
<li><p>The tidy-team doesn’t have plans to do either of these things.
(We checked).</p></li>
<li><p>There are two packages that do <em>time series</em> built on
<a href="https://tidymodels.tidymodels.org" class="external-link">tidymodels</a>, but it’s “basic” time series: 1-step AR
models, exponential smoothing, STL decomposition, etc.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;These are &lt;a href="https://business-science.github.io/timetk/index.html" class="external-link"&gt;&lt;code&gt;{timetk}&lt;/code&gt;&lt;/a&gt;
and &lt;a href="https://business-science.github.io/timetk/index.html" class="external-link"&gt;&lt;code&gt;{modeltime}&lt;/code&gt;&lt;/a&gt;.
There are &lt;em&gt;lots&lt;/em&gt; of useful methods there than can be used to do
fairly complex machine learning methodology, though not directly for
panel data and not for direct prediction of future targets.&lt;/p&gt;'><sup>1</sup></a> Our group has not
prioritized these sorts of models for epidemic forecasting, but one
could also integrate these methods into our framework.</p></li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="show-me-the-basics">Show me the basics<a class="anchor" aria-label="anchor" href="#show-me-the-basics"></a>
</h2>
<p>We start with the <code>jhu</code> data displayed above. One of the
“canned” forecasters we provide is an autoregressive forecaster with (or
without) covariates that <em>directly</em> trains on the response. This
is in contrast to a typical “iterative” AR model that trains to predict
one-step-ahead, and then plugs in the predictions to “leverage up” to
longer horizons.</p>
<p>We’ll estimate the model jointly across all locations using only the
most recent 30 days.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">jhu</span> <span class="op">&lt;-</span> <span class="va">jhu</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time_value</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">time_value</span><span class="op">)</span> <span class="op">-</span> <span class="fl">30</span><span class="op">)</span></span>
<span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/arx_forecaster.html">arx_forecaster</a></span><span class="op">(</span></span>
<span>  <span class="va">jhu</span>,</span>
<span>  outcome <span class="op">=</span> <span class="st">"death_rate"</span>,</span>
<span>  predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"case_rate"</span>, <span class="st">"death_rate"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The <code>out</code> object has two components:</p>
<ol style="list-style-type: decimal">
<li>The predictions which is just another <code>epi_df</code>. It
contains the predictions for each location along with additional
columns. By default, these are a 90% predictive interval, the
<code>forecast_date</code> (the date on which the forecast was
putatively made) and the <code>target_date</code> (the date for which
the forecast is being made).</li>
</ol>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out</span><span class="op">$</span><span class="va">predictions</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 56 × 5</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">geo_value</span> <span style="font-weight: bold;">.pred</span> <span style="font-weight: bold;">.pred_distn</span> <span style="font-weight: bold;">forecast_date</span> <span style="font-weight: bold;">target_date</span></span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;qtls(7)&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> ak        0.324     [0.324] 2021-12-31    2022-01-07 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> al        0.264     [0.264] 2021-12-31    2022-01-07 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> ar        0.444     [0.444] 2021-12-31    2022-01-07 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> as        0.103     [0.103] 2021-12-31    2022-01-07 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> az        0.591     [0.591] 2021-12-31    2022-01-07 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> ca        0.289     [0.289] 2021-12-31    2022-01-07 </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 50 more rows</span></span></span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>A list object of class <code>epi_workflow</code>. This object
encapsulates all the instructions necessary to create the prediction.
More details on this below.</li>
</ol>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out</span><span class="op">$</span><span class="va">epi_workflow</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ══ Epi Workflow [trained] ═══════════════════════════════════════════════════</span></span>
<span><span class="co">#&gt; <span style="font-style: italic;">Preprocessor:</span> Recipe</span></span>
<span><span class="co">#&gt; <span style="font-style: italic;">Model:</span> linear_reg()</span></span>
<span><span class="co">#&gt; <span style="font-style: italic;">Postprocessor:</span> Frosting</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Preprocessor ─────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 7 Recipe steps.</span></span>
<span><span class="co">#&gt; 1. step_epi_lag()</span></span>
<span><span class="co">#&gt; 2. step_epi_lag()</span></span>
<span><span class="co">#&gt; 3. step_epi_ahead()</span></span>
<span><span class="co">#&gt; 4. step_naomit()</span></span>
<span><span class="co">#&gt; 5. step_naomit()</span></span>
<span><span class="co">#&gt; 6. step_training_window()</span></span>
<span><span class="co">#&gt; 7. check_enough_data()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Model ────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; stats::lm(formula = ..y ~ ., data = data)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;       (Intercept)    lag_0_case_rate    lag_7_case_rate   lag_14_case_rate  </span></span>
<span><span class="co">#&gt;         0.1015759         -0.0003068          0.0047910         -0.0015547  </span></span>
<span><span class="co">#&gt;  lag_0_death_rate   lag_7_death_rate  lag_14_death_rate  </span></span>
<span><span class="co">#&gt;         0.2448844          0.1915621          0.0721446</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Postprocessor ────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 5 Frosting layers.</span></span>
<span><span class="co">#&gt; 1. layer_predict()</span></span>
<span><span class="co">#&gt; 2. layer_residual_quantiles()</span></span>
<span><span class="co">#&gt; 3. layer_add_forecast_date()</span></span>
<span><span class="co">#&gt; 4. layer_add_target_date()</span></span>
<span><span class="co">#&gt; 5. layer_threshold()</span></span>
<span><span class="co">#&gt; </span></span></code></pre></div>
<p>By default, the forecaster predicts the outcome
(<code>death_rate</code>) 1-week ahead, using 3 lags of each predictor
(<code>case_rate</code> and <code>death_rate</code>) at 0 (today), 1
week back and 2 weeks back. The predictors and outcome can be changed
directly. The rest of the defaults are encapsulated into a list of
arguments. This list is produced by <code><a href="../reference/arx_args_list.html">arx_args_list()</a></code>.</p>
<div class="section level3">
<h3 id="simple-adjustments">Simple adjustments<a class="anchor" aria-label="anchor" href="#simple-adjustments"></a>
</h3>
<p>Basic adjustments can be made through the <code>args_list</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out2week</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/arx_forecaster.html">arx_forecaster</a></span><span class="op">(</span></span>
<span>  <span class="va">jhu</span>,</span>
<span>  outcome <span class="op">=</span> <span class="st">"death_rate"</span>,</span>
<span>  predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"case_rate"</span>, <span class="st">"death_rate"</span><span class="op">)</span>,</span>
<span>  args_list <span class="op">=</span> <span class="fu"><a href="../reference/arx_args_list.html">arx_args_list</a></span><span class="op">(</span></span>
<span>    lags <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">7</span>, <span class="fl">14</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">7</span>, <span class="fl">14</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    ahead <span class="op">=</span> <span class="fl">14</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Here, we’ve used different lags on the <code>case_rate</code> and are
now predicting 2 weeks ahead. This example also illustrates a major
difficulty with the “iterative” versions of AR models. This model
doesn’t produce forecasts for <code>case_rate</code>, and so, would not
have data to “plug in” for the necessary lags.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;An obvious fix is to instead use a VAR and predict both,
but this would likely increase the variance of the model, and therefore,
may lead to less accurate forecasts for the variable of interest.&lt;/p&gt;"><sup>2</sup></a></p>
<p>Another property of the basic model is the predictive interval. We
describe this in more detail in a different vignette, but it is easy to
request multiple quantiles.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out_q</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/arx_forecaster.html">arx_forecaster</a></span><span class="op">(</span><span class="va">jhu</span>, <span class="st">"death_rate"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"case_rate"</span>, <span class="st">"death_rate"</span><span class="op">)</span>,</span>
<span>  args_list <span class="op">=</span> <span class="fu"><a href="../reference/arx_args_list.html">arx_args_list</a></span><span class="op">(</span></span>
<span>    quantile_levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.01</span>, <span class="fl">.025</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">19</span> <span class="op">/</span> <span class="fl">20</span>, <span class="fl">.975</span>, <span class="fl">.99</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The column <code>.pred_dstn</code> in the <code>predictions</code>
object is actually a “distribution” here parameterized by its quantiles.
For this default forecaster, these are created using the quantiles of
the residuals of the predictive model (possibly symmetrized). Here, we
used 23 quantiles, but one can grab a particular quantile,</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">out_q</span><span class="op">$</span><span class="va">predictions</span><span class="op">$</span><span class="va">.pred_distn</span>, p <span class="op">=</span> <span class="fl">.4</span><span class="op">)</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt;       [,1]</span></span>
<span><span class="co">#&gt; [1,] 0.275</span></span>
<span><span class="co">#&gt; [2,] 0.215</span></span>
<span><span class="co">#&gt; [3,] 0.395</span></span>
<span><span class="co">#&gt; [4,] 0.054</span></span>
<span><span class="co">#&gt; [5,] 0.542</span></span>
<span><span class="co">#&gt; [6,] 0.240</span></span></code></pre></div>
<p>or extract the entire distribution into a “long” <code>epi_df</code>
with <code>quantile_levels</code> being the probability and
<code>values</code> being the value associated to that quantile.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out_q</span><span class="op">$</span><span class="va">predictions</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/pivot_quantiles_longer.html">pivot_quantiles_longer</a></span><span class="op">(</span><span class="va">.pred_distn</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1,288 × 6</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">geo_value</span> <span style="font-weight: bold;">.pred</span> <span style="font-weight: bold;">forecast_date</span> <span style="font-weight: bold;">target_date</span> <span style="font-weight: bold;">.pred_distn_value</span></span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>                  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> ak        0.324 2021-12-31    2022-01-07            0      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> ak        0.324 2021-12-31    2022-01-07            0      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> ak        0.324 2021-12-31    2022-01-07            0.009<span style="text-decoration: underline;">69</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> ak        0.324 2021-12-31    2022-01-07            0.096<span style="text-decoration: underline;">9</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> ak        0.324 2021-12-31    2022-01-07            0.141  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> ak        0.324 2021-12-31    2022-01-07            0.177  </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1,282 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1 more variable: </span><span style="color: #949494; font-weight: bold;">.pred_distn_quantile_level</span><span style="color: #949494;"> &lt;dbl&gt;</span></span></span></code></pre></div>
<p>Additional simple adjustments to the basic forecaster can be made
using the function:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/arx_args_list.html">arx_args_list</a></span><span class="op">(</span></span>
<span>  lags <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0L</span>, <span class="fl">7L</span>, <span class="fl">14L</span><span class="op">)</span>, ahead <span class="op">=</span> <span class="fl">7L</span>, n_training <span class="op">=</span> <span class="cn">Inf</span>,</span>
<span>  forecast_date <span class="op">=</span> <span class="cn">NULL</span>, target_date <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  quantile_levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="fl">0.9</span>, <span class="fl">0.95</span><span class="op">)</span>,</span>
<span>  symmetrize <span class="op">=</span> <span class="cn">TRUE</span>, nonneg <span class="op">=</span> <span class="cn">TRUE</span>, quantile_by_key <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fl">0L</span><span class="op">)</span>,</span>
<span>  nafill_buffer <span class="op">=</span> <span class="cn">Inf</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="changing-the-engine">Changing the engine<a class="anchor" aria-label="anchor" href="#changing-the-engine"></a>
</h3>
<p>So far, our forecasts have been produced using simple linear
regression. But this is not the only way to estimate such a model. The
<code>trainer</code> argument determines the type of model we want. This
takes a <a href="https://parsnip.tidymodels.org" class="external-link"><code>{parsnip}</code></a> model.
The default is linear regression, but we could instead use a random
forest with the <a href="https://imbs-hl.github.io/ranger/" class="external-link">ranger</a> package:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out_rf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/arx_forecaster.html">arx_forecaster</a></span><span class="op">(</span></span>
<span>  <span class="va">jhu</span>,</span>
<span>  outcome <span class="op">=</span> <span class="st">"death_rate"</span>,</span>
<span>  predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"case_rate"</span>, <span class="st">"death_rate"</span><span class="op">)</span>,</span>
<span>  trainer <span class="op">=</span> <span class="fu"><a href="https://parsnip.tidymodels.org/reference/rand_forest.html" class="external-link">rand_forest</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"regression"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Or boosted regression trees with <a href="https://github.com/dmlc/xgboost" class="external-link">xgboost</a>:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out_gb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/arx_forecaster.html">arx_forecaster</a></span><span class="op">(</span></span>
<span>  <span class="va">jhu</span>,</span>
<span>  outcome <span class="op">=</span> <span class="st">"death_rate"</span>,</span>
<span>  predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"case_rate"</span>, <span class="st">"death_rate"</span><span class="op">)</span>,</span>
<span>  trainer <span class="op">=</span> <span class="fu"><a href="https://parsnip.tidymodels.org/reference/boost_tree.html" class="external-link">boost_tree</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"regression"</span>, trees <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Or quantile regression, using our custom forecasting engine
<code><a href="../reference/quantile_reg.html">quantile_reg()</a></code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out_qr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/arx_forecaster.html">arx_forecaster</a></span><span class="op">(</span></span>
<span>  <span class="va">jhu</span>,</span>
<span>  outcome <span class="op">=</span> <span class="st">"death_rate"</span>,</span>
<span>  predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"case_rate"</span>, <span class="st">"death_rate"</span><span class="op">)</span>,</span>
<span>  trainer <span class="op">=</span> <span class="fu"><a href="../reference/quantile_reg.html">quantile_reg</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>FWIW, this last case (using quantile regression), is not far from
what the Delphi production forecast team used for its Covid forecasts
over the past few years.</p>
</div>
<div class="section level3">
<h3 id="inner-workings">Inner workings<a class="anchor" aria-label="anchor" href="#inner-workings"></a>
</h3>
<p>Underneath the hood, this forecaster creates (and returns) an
<code>epi_workflow</code>. Essentially, this is a big S3 object that
wraps up the 4 modular steps (preprocessing - postprocessing) described
above.</p>
<div class="section level4">
<h4 id="preprocessing">Preprocessing<a class="anchor" aria-label="anchor" href="#preprocessing"></a>
</h4>
<p>Preprocessing is accomplished through a <code>recipe</code> (imagine
baking a cake) as provided in the <a href="https://recipes.tidymodels.org" class="external-link"><code>{recipes}</code></a>
package. We’ve made a few modifications (to handle panel data) as well
as added some additional options. The recipe gives a specification of
how to handle training data. Think of it like a fancified
<code>formula</code> that you would pass to <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code>:
<code>y ~ x1 + log(x2)</code>. In general, there are 2 extensions to the
<code>formula</code> that <a href="https://github.com/tidymodels/recipes" class="external-link">recipes</a> handles:</p>
<ol style="list-style-type: decimal">
<li>Doing transformations of both training and test data that can always
be applied. These are things like taking the log of a variable, leading
or lagging, filtering out rows, handling dummy variables, etc.</li>
<li>Using statistics from the training data to eventually process test
data. This is a major benefit of <a href="https://github.com/tidymodels/recipes" class="external-link">recipes</a>. It prevents
what the tidy team calls “data leakage”. A simple example is centering a
predictor by its mean. We need to store the mean of the predictor from
the training data and use that value on the test data rather than
accidentally calculating the mean of the test predictor for
centering.</li>
</ol>
<p>A recipe is processed in 2 steps, first it is “prepped”. This
calculates and stores any intermediate statistics necessary for use on
the test data. Then it is “baked” resulting in training data ready for
passing into a statistical model (like <code>lm</code>).</p>
<p>We have introduced an <code>epi_recipe</code>. It’s just a
<code>recipe</code> that knows how to handle the
<code>time_value</code>, <code>geo_value</code>, and any additional keys
so that these are available when necessary.</p>
<p>The <code>epi_recipe</code> from <code>out_gb</code> can be extracted
from the result:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://hardhat.tidymodels.org/reference/hardhat-extract.html" class="external-link">extract_recipe</a></span><span class="op">(</span><span class="va">out_gb</span><span class="op">$</span><span class="va">epi_workflow</span><span class="op">)</span></span></code></pre></div>
<p>The “Inputs” are the original <code>epi_df</code> and the “roles”
that these are assigned. None of these are predictors or outcomes. Those
will be created by the recipe when it is prepped. The “Operations” are
the sequence of instructions to create the cake (baked training data).
Here we create lagged predictors, lead the outcome, and then remove
<code>NA</code>s. Some models like <code>lm</code> internally handle
<code>NA</code>s, but not everything does, so we deal with them
explicitly. The code to do this (inside the forecaster) is</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">er</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epi_recipe.html">epi_recipe</a></span><span class="op">(</span><span class="va">jhu</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/step_epi_shift.html">step_epi_lag</a></span><span class="op">(</span><span class="va">case_rate</span>, <span class="va">death_rate</span>, lag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">7</span>, <span class="fl">14</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/step_epi_shift.html">step_epi_ahead</a></span><span class="op">(</span><span class="va">death_rate</span>, ahead <span class="op">=</span> <span class="fl">7</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/step_epi_naomit.html">step_epi_naomit</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>While <a href="https://github.com/tidymodels/recipes" class="external-link">recipes</a> provides a function
<code><a href="https://recipes.tidymodels.org/reference/step_lag.html" class="external-link">step_lag()</a></code>, it assumes that the data have no breaks in the
sequence of <code>time_values</code>. This is a bit dangerous, so we
avoid that behaviour. Our <code>lag/ahead</code> functions also
appropriately adjust the amount of data to avoid accidentally dropping
recent predictors from the test data.</p>
</div>
<div class="section level4">
<h4 id="the-model-specification">The model specification<a class="anchor" aria-label="anchor" href="#the-model-specification"></a>
</h4>
<p>Users with familiarity with the <a href="https://github.com/tidymodels/parsnip" class="external-link">parsnip</a> package will
have no trouble here. Basically, <a href="https://github.com/tidymodels/parsnip" class="external-link">parsnip</a> unifies the
function signature across statistical models. For example,
<code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code> “likes” to work with formulas, but
<code>glmnet::glmnet()</code> uses <code>x</code> and <code>y</code> for
predictors and response. <a href="https://github.com/tidymodels/parsnip" class="external-link">parsnip</a> is agnostic. Both of
these do “linear regression”. Above we switched from <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code>
to <code>xgboost()</code> without any issue despite the fact that these
functions couldn’t be more different.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">formula</span>, <span class="va">data</span>, <span class="va">subset</span>, <span class="va">weights</span>, <span class="va">na.action</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"qr"</span>,</span>
<span>  model <span class="op">=</span> <span class="cn">TRUE</span>, x <span class="op">=</span> <span class="cn">FALSE</span>, y <span class="op">=</span> <span class="cn">FALSE</span>, qr <span class="op">=</span> <span class="cn">TRUE</span>, singular.ok <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  contrasts <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">offset</span>, <span class="va">...</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">xgboost</span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="cn">NULL</span>, label <span class="op">=</span> <span class="cn">NULL</span>, missing <span class="op">=</span> <span class="cn">NA</span>, weight <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">nrounds</span>, verbose <span class="op">=</span> <span class="fl">1</span>, print_every_n <span class="op">=</span> <span class="fl">1L</span>,</span>
<span>  early_stopping_rounds <span class="op">=</span> <span class="cn">NULL</span>, maximize <span class="op">=</span> <span class="cn">NULL</span>, save_period <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  save_name <span class="op">=</span> <span class="st">"xgboost.model"</span>, xgb_model <span class="op">=</span> <span class="cn">NULL</span>, callbacks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><a href="https://github.com/cmu-delphi/epipredict/" class="external-link">epipredict</a> provides a few engines/modules (the
flatline forecaster and quantile regression), but you should be able to
use any available models listed <a href="https://www.tidymodels.org/find/parsnip/" class="external-link">here</a>.</p>
<p>To estimate (fit) a preprocessed model, one calls <code><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit()</a></code>
on the <code>epi_workflow</code>.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ewf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epi_workflow.html">epi_workflow</a></span><span class="op">(</span><span class="va">er</span>, <span class="fu"><a href="https://parsnip.tidymodels.org/reference/linear_reg.html" class="external-link">linear_reg</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="va">jhu</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="postprocessing">Postprocessing<a class="anchor" aria-label="anchor" href="#postprocessing"></a>
</h4>
<p>To stretch the metaphor of preparing a cake to its natural limits, we
have created postprocessing functionality called “frosting”. Much like
the recipe, each postprocessing operation is a “layer” and we “slather”
these onto our baked cake. To fix ideas, below is the postprocessing
<code>frosting</code> for <code><a href="../reference/arx_forecaster.html">arx_forecaster()</a></code></p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/extract_frosting.html">extract_frosting</a></span><span class="op">(</span><span class="va">out_q</span><span class="op">$</span><span class="va">epi_workflow</span><span class="op">)</span></span></code></pre></div>
<p>Here we have 5 layers of frosting. The first generates the forecasts
from the test data. The second uses quantiles of the residuals to create
distributional forecasts. The next two add columns for the date the
forecast was made and the date for which it is intended to occur.
Because we are predicting rates, they should be non-negative, so the
last layer thresholds both predicted values and intervals at 0. The code
to do this (inside the forecaster) is</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/frosting.html">frosting</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/layer_predict.html">layer_predict</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/layer_residual_quantiles.html">layer_residual_quantiles</a></span><span class="op">(</span></span>
<span>    quantile_levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.01</span>, <span class="fl">.025</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">19</span> <span class="op">/</span> <span class="fl">20</span>, <span class="fl">.975</span>, <span class="fl">.99</span><span class="op">)</span>,</span>
<span>    symmetrize <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/layer_add_forecast_date.html">layer_add_forecast_date</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/layer_add_target_date.html">layer_add_target_date</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/layer_threshold.html">layer_threshold</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">".pred"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>At predict time, we add this object onto the
<code>epi_workflow</code> and call <code><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast()</a></code></p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ewf</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_frosting.html">add_frosting</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; An `epi_df` object, 56 x 6 with metadata:</span></span>
<span><span class="co">#&gt; * geo_type  = state</span></span>
<span><span class="co">#&gt; * time_type = day</span></span>
<span><span class="co">#&gt; * as_of     = 2023-03-10</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 56 × 6</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">geo_value</span> <span style="font-weight: bold;">time_value</span> <span style="font-weight: bold;">.pred</span> <span style="font-weight: bold;">.pred_distn</span> <span style="font-weight: bold;">forecast_date</span> <span style="font-weight: bold;">target_date</span></span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;qtls(23)&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> ak        2021-12-31 0.324     [0.324] 2021-12-31    2022-01-07 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> al        2021-12-31 0.264     [0.264] 2021-12-31    2022-01-07 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> ar        2021-12-31 0.444     [0.444] 2021-12-31    2022-01-07 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> as        2021-12-31 0.103     [0.103] 2021-12-31    2022-01-07 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> az        2021-12-31 0.591     [0.591] 2021-12-31    2022-01-07 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> ca        2021-12-31 0.289     [0.289] 2021-12-31    2022-01-07 </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 50 more rows</span></span></span></code></pre></div>
<p>The above <code><a href="../reference/get_test_data.html">get_test_data()</a></code> function examines the recipe
and ensures that enough test data is available to create the necessary
lags and produce a prediction for the desired future time point (after
the end of the training data). This mimics what would happen if
<code>jhu</code> contained the most recent available historical data and
we wanted to actually predict the future. We could have instead used any
test data that contained the necessary predictors.</p>
</div>
</div>
<div class="section level3">
<h3 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h3>
<p>Internally, we provide some simple functions to create reasonable
forecasts. But ideally, a user could create their own forecasters by
building up the components we provide. In other vignettes, we try to
walk through some of these customizations.</p>
<p>To illustrate everything above, here is (roughly) the code for the
<code><a href="../reference/flatline_forecaster.html">flatline_forecaster()</a></code> applied to the
<code>case_rate</code>.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epi_recipe.html">epi_recipe</a></span><span class="op">(</span><span class="va">jhu</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/step_epi_shift.html">step_epi_ahead</a></span><span class="op">(</span><span class="va">case_rate</span>, ahead <span class="op">=</span> <span class="fl">7</span>, skip <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/roles.html" class="external-link">update_role</a></span><span class="op">(</span><span class="va">case_rate</span>, new_role <span class="op">=</span> <span class="st">"predictor"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/roles.html" class="external-link">add_role</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/key_colnames.html" class="external-link">key_colnames</a></span><span class="op">(</span><span class="va">jhu</span><span class="op">)</span><span class="op">)</span>, new_role <span class="op">=</span> <span class="st">"predictor"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/frosting.html">frosting</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/layer_predict.html">layer_predict</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/layer_residual_quantiles.html">layer_residual_quantiles</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/layer_add_forecast_date.html">layer_add_forecast_date</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/layer_add_target_date.html">layer_add_target_date</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/layer_threshold.html">layer_threshold</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">".pred"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">eng</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://parsnip.tidymodels.org/reference/linear_reg.html" class="external-link">linear_reg</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_engine.html" class="external-link">set_engine</a></span><span class="op">(</span><span class="st">"flatline"</span><span class="op">)</span></span>
<span><span class="va">wf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epi_workflow.html">epi_workflow</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">eng</span>, <span class="va">f</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="va">jhu</span><span class="op">)</span></span>
<span><span class="va">preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast</a></span><span class="op">(</span><span class="va">wf</span><span class="op">)</span></span></code></pre></div>
<p>All that really differs from the <code><a href="../reference/arx_forecaster.html">arx_forecaster()</a></code> is the
<code>recipe</code>, the test data, and the engine. The
<code>frosting</code> is identical, as is the fitting and predicting
procedure.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">preds</span></span>
<span><span class="co">#&gt; An `epi_df` object, 56 x 6 with metadata:</span></span>
<span><span class="co">#&gt; * geo_type  = state</span></span>
<span><span class="co">#&gt; * time_type = day</span></span>
<span><span class="co">#&gt; * as_of     = 2023-03-10</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 56 × 6</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">geo_value</span> <span style="font-weight: bold;">time_value</span> <span style="font-weight: bold;">.pred</span> <span style="font-weight: bold;">.pred_distn</span> <span style="font-weight: bold;">forecast_date</span> <span style="font-weight: bold;">target_date</span></span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;qtls(7)&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> ak        2021-12-31  36.4      [36.4] 2021-12-31    2022-01-07 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> al        2021-12-31  89.9      [89.9] 2021-12-31    2022-01-07 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> ar        2021-12-31  82.6      [82.6] 2021-12-31    2022-01-07 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> as        2021-12-31   0           [0] 2021-12-31    2022-01-07 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> az        2021-12-31  58.3      [58.3] 2021-12-31    2022-01-07 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> ca        2021-12-31  84.3      [84.3] 2021-12-31    2022-01-07 </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 50 more rows</span></span></span></code></pre></div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p><a href="https://delphi.cmu.edu/about/" class="external-link">About Delphi</a> • <a href="https://delphi.cmu.edu/epidemic-signals/terms-of-use/" class="external-link">Terms of Use</a> • <a href="https://docs.google.com/forms/u/1/d/e/1FAIpQLScqgT1fKZr5VWBfsaSp-DNaN03aV6EoZU4YljIzHJ1Wl_zmtg/viewform" class="external-link">Contact Us</a> • <a href="https://github.com/cmu-delphi/" class="external-link">Delphi GitHub</a> • <a href="https://cmu-delphi.github.io/delphi-epidata/" class="external-link">Epidata API</a></p>
</div>

<div class="pkgdown-footer-right">
  <p>epipredict</p>
</div>

    </footer>
</div>





  </body>
</html>
