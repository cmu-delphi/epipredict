<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Examples of Preprocessing and Models • epipredict</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Open_Sans-0.4.9/font.css" rel="stylesheet">
<link href="../deps/Source_Serif_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Examples of Preprocessing and Models">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">epipredict</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.1.14</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/epipredict.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/preprocessing-and-models.html">Examples of Preprocessing and Models</a></li>
    <li><a class="dropdown-item" href="../articles/backtesting.html">Accurately backtesting forecasters</a></li>
    <li><a class="dropdown-item" href="../articles/arx-classifier.html">Auto-regressive classifier</a></li>
    <li><a class="dropdown-item" href="../articles/update.html">Using the add/update/remove and adjust functions</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/cmu-delphi/epipredict/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Examples of Preprocessing and Models</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/cmu-delphi/epipredict/blob/dev/vignettes/preprocessing-and-models.Rmd" class="external-link"><code>vignettes/preprocessing-and-models.Rmd</code></a></small>
      <div class="d-none name"><code>preprocessing-and-models.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <code>epipredict</code> package utilizes the
<code>tidymodels</code> framework, namely <a href="https://recipes.tidymodels.org/" class="external-link"><code>{recipes}</code></a> for <a href="https://dplyr.tidyverse.org/" class="external-link">dplyr</a>-like pipeable sequences of
feature engineering and <a href="https://parsnip.tidymodels.org/" class="external-link"><code>{parsnip}</code></a> for a
unified interface to a range of models.</p>
<p><code>epipredict</code> has additional customized feature engineering
and preprocessing steps, such as <code><a href="../reference/step_epi_shift.html">step_epi_lag()</a></code>,
<code><a href="../reference/step_population_scaling.html">step_population_scaling()</a></code>, <code><a href="../reference/step_epi_naomit.html">step_epi_naomit()</a></code>.
They can be used along with steps from the <a href="https://github.com/tidymodels/recipes" class="external-link">recipes</a>
package for more feature engineering.</p>
<p>In this vignette, we will illustrate some examples of how to use
<code>epipredict</code> with <code>recipes</code> and
<code>parsnip</code> for different purposes of epidemiological
forecasting. We will focus on basic autoregressive models, in which
COVID cases and deaths in the near future are predicted using a linear
combination of cases and deaths in the near past.</p>
<p>The remaining vignette will be split into three sections. The first
section, we will use a Poisson regression to predict death counts. In
the second section, we will use a linear regression to predict death
rates. Last but not least, we will create a classification model for
hotspot predictions.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/cmu-delphi/epipredict/" class="external-link">epipredict</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/recipes" class="external-link">recipes</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/workflows" class="external-link">workflows</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/poissonreg" class="external-link">poissonreg</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="poisson-regression">Poisson Regression<a class="anchor" aria-label="anchor" href="#poisson-regression"></a>
</h2>
<p>During COVID-19, the US Center for Disease Control and Prevention
(CDC) collected models and forecasts to characterize the state of an
outbreak and its course. They use it to inform public health decision
makers on potential consequences of deploying control measures.</p>
<p>One of the outcomes that the CDC forecasts is <a href="https://www.cdc.gov/coronavirus/2019-ncov/science/forecasting/forecasting-us.html" class="external-link">death
counts from COVID-19</a>. Although there are many state-of-the-art
models, we choose to use Poisson regression, the textbook example for
modeling count data, as an illustration for using the
<code>epipredict</code> package with other existing tidymodels
packages.</p>
<p>The <code>counts_subset</code> dataset is available in the <a href="https://cmu-delphi.github.io/epidatasets/" class="external-link"><code>epidatasets</code>
package</a>), and contains the number of confirmed cases and deaths from
June 4, 2021 to Dec 31, 2021 in some U.S. states. It can be loaded
with:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">epidatasets</span><span class="fu">::</span><span class="va"><a href="https://cmu-delphi.github.io/epidatasets/reference/counts_subset.html" class="external-link">counts_subset</a></span></span></code></pre></div>
<p>The data can also be fetched from the Delphi API with the following
query:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://cmu-delphi.github.io/epidatr/" class="external-link">epidatr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2024-03-20"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://cmu-delphi.github.io/epidatr/reference/pub_covidcast.html" class="external-link">pub_covidcast</a></span><span class="op">(</span></span>
<span>  source <span class="op">=</span> <span class="st">"jhu-csse"</span>,</span>
<span>  signals <span class="op">=</span> <span class="st">"confirmed_incidence_num"</span>,</span>
<span>  time_type <span class="op">=</span> <span class="st">"day"</span>,</span>
<span>  geo_type <span class="op">=</span> <span class="st">"state"</span>,</span>
<span>  time_values <span class="op">=</span> <span class="fu"><a href="https://cmu-delphi.github.io/epidatr/reference/epirange.html" class="external-link">epirange</a></span><span class="op">(</span><span class="fl">20210604</span>, <span class="fl">20211231</span><span class="op">)</span>,</span>
<span>  geo_values <span class="op">=</span> <span class="st">"ca,fl,tx,ny,nj"</span>,</span>
<span>  as_of <span class="op">=</span> <span class="va">d</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">time_value</span>, cases <span class="op">=</span> <span class="va">value</span><span class="op">)</span></span>
<span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://cmu-delphi.github.io/epidatr/reference/pub_covidcast.html" class="external-link">pub_covidcast</a></span><span class="op">(</span></span>
<span>  source <span class="op">=</span> <span class="st">"jhu-csse"</span>,</span>
<span>  signals <span class="op">=</span> <span class="st">"deaths_incidence_num"</span>,</span>
<span>  time_type <span class="op">=</span> <span class="st">"day"</span>,</span>
<span>  geo_type <span class="op">=</span> <span class="st">"state"</span>,</span>
<span>  time_values <span class="op">=</span> <span class="fu"><a href="https://cmu-delphi.github.io/epidatr/reference/epirange.html" class="external-link">epirange</a></span><span class="op">(</span><span class="fl">20210604</span>, <span class="fl">20211231</span><span class="op">)</span>,</span>
<span>  geo_values <span class="op">=</span> <span class="st">"ca,fl,tx,ny,nj"</span>,</span>
<span>  as_of <span class="op">=</span> <span class="va">d</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">time_value</span>, deaths <span class="op">=</span> <span class="va">value</span><span class="op">)</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">full_join</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"geo_value"</span>, <span class="st">"time_value"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epi_df.html" class="external-link">as_epi_df</a></span><span class="op">(</span>as_of <span class="op">=</span> <span class="va">d</span><span class="op">)</span></span></code></pre></div>
<p>We wish to predict the 7-day ahead death counts with lagged cases and
deaths. Furthermore, we will let each state be a dummy variable. Using
differential intercept coefficients, we can allow for an intercept shift
between states.</p>
The model takes the form
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>μ</mi><mrow><mi>t</mi><mo>+</mo><mn>7</mn></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msub><mi>β</mi><mn>0</mn></msub><mo>+</mo><msub><mi>δ</mi><mn>1</mn></msub><msub><mi>s</mi><msub><mtext mathvariant="normal">state</mtext><mn>1</mn></msub></msub><mo>+</mo><msub><mi>δ</mi><mn>2</mn></msub><msub><mi>s</mi><msub><mtext mathvariant="normal">state</mtext><mn>2</mn></msub></msub><mo>+</mo><mi>⋯</mi><mo>+</mo></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mspace width="1.0em"></mspace><msub><mi>β</mi><mn>1</mn></msub><msub><mtext mathvariant="normal">deaths</mtext><mi>t</mi></msub><mo>+</mo><msub><mi>β</mi><mn>2</mn></msub><msub><mtext mathvariant="normal">deaths</mtext><mrow><mi>t</mi><mo>−</mo><mn>7</mn></mrow></msub><mo>+</mo><msub><mi>β</mi><mn>3</mn></msub><msub><mtext mathvariant="normal">cases</mtext><mi>t</mi></msub><mo>+</mo><msub><mi>β</mi><mn>4</mn></msub><msub><mtext mathvariant="normal">cases</mtext><mrow><mi>t</mi><mo>−</mo><mn>7</mn></mrow></msub><mo>,</mo></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
\log\left( \mu_{t+7} \right) &amp;= \beta_0 + \delta_1 s_{\text{state}_1} +
\delta_2 s_{\text{state}_2} + \cdots + \nonumber \\
&amp;\quad\beta_1 \text{deaths}_{t} +
\beta_2 \text{deaths}_{t-7} + \beta_3 \text{cases}_{t} +
\beta_4 \text{cases}_{t-7},
\end{aligned}</annotation></semantics></math><p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>μ</mi><mrow><mi>t</mi><mo>+</mo><mn>7</mn></mrow></msub><mo>=</mo><mi>𝔼</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>y</mi><mrow><mi>t</mi><mo>+</mo><mn>7</mn></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mu_{t+7} = \mathbb{E}(y_{t+7})</annotation></semantics></math>,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>y</mi><mrow><mi>t</mi><mo>+</mo><mn>7</mn></mrow></msub><annotation encoding="application/x-tex">y_{t+7}</annotation></semantics></math>
is assumed to follow a Poisson distribution with mean
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>μ</mi><mrow><mi>t</mi><mo>+</mo><mn>7</mn></mrow></msub><annotation encoding="application/x-tex">\mu_{t+7}</annotation></semantics></math>;
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>s</mi><mtext mathvariant="normal">state</mtext></msub><annotation encoding="application/x-tex">s_{\text{state}}</annotation></semantics></math>
are dummy variables for each state and take values of either 0 or 1.</p>
<p>Preprocessing steps will be performed to prepare the data for model
fitting. But before diving into them, it will be helpful to understand
what <code>roles</code> are in the <code>recipes</code> framework.</p>
<hr>
<div class="section level4">
<h4 id="aside-on-recipes">Aside on <code>recipes</code><a class="anchor" aria-label="anchor" href="#aside-on-recipes"></a>
</h4>
<p><code>recipes</code> can assign one or more roles to each column in
the data. The roles are not restricted to a predefined set; they can be
anything. For most conventional situations, they are typically
“predictor” and/or “outcome”. Additional roles enable targeted
<code>step_*()</code> operations on specific variables or groups of
variables.</p>
<p>In our case, the role <code>predictor</code> is given to explanatory
variables on the right-hand side of the model (in the equation above).
The role <code>outcome</code> is the response variable that we wish to
predict. <code>geo_value</code> and <code>time_value</code> are
predefined roles that are unique to the <code>epipredict</code> package.
Since we work with <code>epi_df</code> objects, all datasets should have
<code>geo_value</code> and <code>time_value</code> passed through
automatically with these two roles assigned to the appropriate columns
in the data.</p>
<p>The <code>recipes</code> package also allows <a href="https://recipes.tidymodels.org/reference/roles.html" class="external-link">manual
alterations of roles</a> in bulk. There are a few handy functions that
can be used together to help us manipulate variable roles easily.</p>
<blockquote>
<p><code><a href="https://recipes.tidymodels.org/reference/roles.html" class="external-link">update_role()</a></code> alters an existing role in the recipe or
assigns an initial role to variables that do not yet have a declared
role.</p>
<p><code><a href="https://recipes.tidymodels.org/reference/roles.html" class="external-link">add_role()</a></code> adds an additional role to variables that
already have a role in the recipe, without overwriting old roles.</p>
<p><code><a href="https://recipes.tidymodels.org/reference/roles.html" class="external-link">remove_role()</a></code> eliminates a single existing role in the
recipe.</p>
</blockquote>
</div>
<div class="section level4">
<h4 id="end-aside">End aside<a class="anchor" aria-label="anchor" href="#end-aside"></a>
</h4>
<hr>
<p>Notice in the following preprocessing steps, we used
<code><a href="https://recipes.tidymodels.org/reference/roles.html" class="external-link">add_role()</a></code> on <code>geo_value_factor</code> since,
currently, the default role for it is <code>raw</code>, but we would
like to reuse this variable as <code>predictor</code>s.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">counts_subset</span> <span class="op">&lt;-</span> <span class="va">counts_subset</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>geo_value_factor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epi_df.html" class="external-link">as_epi_df</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/epi_recipe.html">epi_recipe</a></span><span class="op">(</span><span class="va">counts_subset</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="font-weight: bold;">Epi Recipe</span> <span style="color: #00BBBB;">───────────────────────────────────────────────────────────────</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Inputs</span></span>
<span><span class="co">#&gt; Number of variables by role</span></span>
<span><span class="co">#&gt; raw:        3</span></span>
<span><span class="co">#&gt; geo_value:  1</span></span>
<span><span class="co">#&gt; time_value: 1</span></span>
<span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epi_recipe.html">epi_recipe</a></span><span class="op">(</span><span class="va">counts_subset</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/roles.html" class="external-link">add_role</a></span><span class="op">(</span><span class="va">geo_value_factor</span>, new_role <span class="op">=</span> <span class="st">"predictor"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_dummy.html" class="external-link">step_dummy</a></span><span class="op">(</span><span class="va">geo_value_factor</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## Occasionally, data reporting errors / corrections result in negative</span></span>
<span>  <span class="co">## cases / deaths</span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_mutate.html" class="external-link">step_mutate</a></span><span class="op">(</span>cases <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="va">cases</span>, <span class="fl">0</span><span class="op">)</span>, deaths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="va">deaths</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/step_epi_shift.html">step_epi_lag</a></span><span class="op">(</span><span class="va">cases</span>, <span class="va">deaths</span>, lag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">7</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/step_epi_shift.html">step_epi_ahead</a></span><span class="op">(</span><span class="va">deaths</span>, ahead <span class="op">=</span> <span class="fl">7</span>, role <span class="op">=</span> <span class="st">"outcome"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/step_epi_naomit.html">step_epi_naomit</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>After specifying the preprocessing steps, we will use the
<code>parsnip</code> package for modeling and producing the prediction
for death count, 7 days after the latest available date in the
dataset.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">latest</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_test_data.html">get_test_data</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">counts_subset</span><span class="op">)</span></span>
<span></span>
<span><span class="va">wf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epi_workflow.html">epi_workflow</a></span><span class="op">(</span><span class="va">r</span>, <span class="fu">parsnip</span><span class="fu">::</span><span class="fu"><a href="https://parsnip.tidymodels.org/reference/poisson_reg.html" class="external-link">poisson_reg</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="va">counts_subset</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">wf</span>, <span class="va">latest</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">.pred</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; An `epi_df` object, 5 x 3 with metadata:</span></span>
<span><span class="co">#&gt; * geo_type  = state</span></span>
<span><span class="co">#&gt; * time_type = day</span></span>
<span><span class="co">#&gt; * as_of     = 2024-03-20</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 × 3</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">geo_value</span> <span style="font-weight: bold;">time_value</span> <span style="font-weight: bold;">.pred</span></span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> ca        2021-12-31 108. </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> fl        2021-12-31 270. </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> nj        2021-12-31  22.5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> ny        2021-12-31  94.8</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> tx        2021-12-31  91.0</span></span></code></pre></div>
<p>Note that the <code>time_value</code> corresponds to the last
available date in the training set, <strong>NOT</strong> to the target
date of the forecast (2022-01-07).</p>
<p>Let’s take a look at the fit:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://hardhat.tidymodels.org/reference/hardhat-extract.html" class="external-link">extract_fit_engine</a></span><span class="op">(</span><span class="va">wf</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:  stats::glm(formula = ..y ~ ., family = stats::poisson, data = data)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;         (Intercept)  geo_value_factor_fl  geo_value_factor_nj  </span></span>
<span><span class="co">#&gt;           3.970e+00           -1.487e-01           -1.425e+00  </span></span>
<span><span class="co">#&gt; geo_value_factor_ny  geo_value_factor_tx          lag_0_cases  </span></span>
<span><span class="co">#&gt;          -6.865e-01            3.025e-01            1.339e-05  </span></span>
<span><span class="co">#&gt;         lag_7_cases         lag_0_deaths         lag_7_deaths  </span></span>
<span><span class="co">#&gt;           1.717e-06            1.731e-03            8.566e-04  </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Degrees of Freedom: 984 Total (i.e. Null);  976 Residual</span></span>
<span><span class="co">#&gt; Null Deviance:       139600 </span></span>
<span><span class="co">#&gt; Residual Deviance: 58110     AIC: 62710</span></span></code></pre></div>
<p>Up to now, we’ve used the Poisson regression to model count data.
Poisson regression can also be used to model rate data, such as case
rates or death rates, by incorporating offset terms in the model.</p>
To model death rates, the Poisson regression would be expressed as:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>μ</mi><mrow><mi>t</mi><mo>+</mo><mn>7</mn></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><mtext mathvariant="normal">population</mtext><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><msub><mi>β</mi><mn>0</mn></msub><mo>+</mo><msub><mi>δ</mi><mn>1</mn></msub><msub><mi>s</mi><msub><mtext mathvariant="normal">state</mtext><mn>1</mn></msub></msub><mo>+</mo><msub><mi>δ</mi><mn>2</mn></msub><msub><mi>s</mi><msub><mtext mathvariant="normal">state</mtext><mn>2</mn></msub></msub><mo>+</mo><mi>⋯</mi><mo>+</mo></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mspace width="1.0em"></mspace><msub><mi>β</mi><mn>1</mn></msub><msub><mtext mathvariant="normal">deaths</mtext><mi>t</mi></msub><mo>+</mo><msub><mi>β</mi><mn>2</mn></msub><msub><mtext mathvariant="normal">deaths</mtext><mrow><mi>t</mi><mo>−</mo><mn>7</mn></mrow></msub><mo>+</mo><msub><mi>β</mi><mn>3</mn></msub><msub><mtext mathvariant="normal">cases</mtext><mi>t</mi></msub><mo>+</mo><msub><mi>β</mi><mn>4</mn></msub><msub><mtext mathvariant="normal">cases</mtext><mrow><mi>t</mi><mo>−</mo><mn>7</mn></mrow></msub></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
\log\left( \mu_{t+7} \right) &amp;= \log(\text{population}) +
\beta_0 + \delta_1 s_{\text{state}_1} +
\delta_2 s_{\text{state}_2} + \cdots + \nonumber \\
&amp;\quad\beta_1 \text{deaths}_{t} +
\beta_2 \text{deaths}_{t-7} + \beta_3 \text{cases}_{t} +
\beta_4 \text{cases}_{t-7}
\end{aligned}</annotation></semantics></math><p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><mtext mathvariant="normal">population</mtext><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\log(\text{population})</annotation></semantics></math>
is the log of the state population that was used to scale the count data
on the left-hand side of the equation. This offset is simply a predictor
with coefficient fixed at 1 rather than estimated.</p>
<p>There are several ways to model rate data given count and population
data. First, in the <code>parsnip</code> framework, we could specify the
formula in <code><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit()</a></code>. However, by doing so we lose the ability
to use the <code>recipes</code> framework to create new variables since
variables that do not exist in the original dataset (such as, here, the
lags and leads) cannot be called directly in <code><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit()</a></code>.</p>
<p>Alternatively, <code><a href="../reference/step_population_scaling.html">step_population_scaling()</a></code> and
<code><a href="../reference/layer_population_scaling.html">layer_population_scaling()</a></code> in the <code>epipredict</code>
package can perform the population scaling if we provide the population
data, which we will illustrate in the next section.</p>
</div>
</div>
<div class="section level2">
<h2 id="linear-regression">Linear Regression<a class="anchor" aria-label="anchor" href="#linear-regression"></a>
</h2>
<p>For COVID-19, the CDC required submission of case and death count
predictions. However, the Delphi Group preferred to train on rate data
instead, because it puts different locations on a similar scale
(eliminating the need for location-specific intercepts). We can use a
liner regression to predict the death rates and use state population
data to scale the rates to counts.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;We could continue with the Poisson model, but we’ll
switch to the Gaussian likelihood just for simplicity.&lt;/p&gt;"><sup>1</sup></a> We will do so using
<code><a href="../reference/layer_population_scaling.html">layer_population_scaling()</a></code> from the <code>epipredict</code>
package.</p>
<p>Additionally, when forecasts are submitted, prediction intervals
should be provided along with the point estimates. This can be obtained
via postprocessing using <code><a href="../reference/layer_residual_quantiles.html">layer_residual_quantiles()</a></code>. It is
worth pointing out, however, that
<code><a href="../reference/layer_residual_quantiles.html">layer_residual_quantiles()</a></code> should be used before population
scaling or else the transformation will make the results
uninterpretable.</p>
<p>We wish, now, to predict the 7-day ahead death counts with lagged
case rates and death rates, along with some extra behaviourial
predictors. Namely, we will use survey data from <a href="https://cmu-delphi.github.io/delphi-epidata/api/covidcast-signals/fb-survey.html#behavior-indicators" class="external-link">COVID-19
Trends and Impact Survey</a>.</p>
<p>The survey data provides the estimated percentage of people who wore
a mask for most or all of the time while in public in the past 7 days
and the estimated percentage of respondents who reported that all or
most people they encountered in public in the past 7 days maintained a
distance of at least 6 feet.</p>
<p>State-wise population data from the 2019 U.S. Census will be used in
<code><a href="../reference/layer_population_scaling.html">layer_population_scaling()</a></code>.</p>
<p>Both datasets are available in the <a href="https://cmu-delphi.github.io/epidatasets/" class="external-link"><code>epidatasets</code>
package</a>), and can be loaded with:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">behav_ind</span> <span class="op">&lt;-</span> <span class="fu">epidatasets</span><span class="fu">::</span><span class="va"><a href="https://cmu-delphi.github.io/epidatasets/reference/ctis_covid_behaviours.html" class="external-link">ctis_covid_behaviours</a></span></span>
<span><span class="va">pop_dat</span> <span class="op">&lt;-</span> <span class="fu">epidatasets</span><span class="fu">::</span><span class="va"><a href="https://cmu-delphi.github.io/epidatasets/reference/state_census.html" class="external-link">state_census</a></span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">abbr</span>, <span class="va">pop</span><span class="op">)</span></span></code></pre></div>
<p>The data can also be fetched from the Delphi API with the following
query:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://cmu-delphi.github.io/epidatr/" class="external-link">epidatr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2024-03-20"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">behav_ind_mask</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://cmu-delphi.github.io/epidatr/reference/pub_covidcast.html" class="external-link">pub_covidcast</a></span><span class="op">(</span></span>
<span>  source <span class="op">=</span> <span class="st">"fb-survey"</span>,</span>
<span>  signals <span class="op">=</span> <span class="st">"smoothed_wwearing_mask_7d"</span>,</span>
<span>  time_type <span class="op">=</span> <span class="st">"day"</span>,</span>
<span>  geo_type <span class="op">=</span> <span class="st">"state"</span>,</span>
<span>  time_values <span class="op">=</span> <span class="fu"><a href="https://cmu-delphi.github.io/epidatr/reference/epirange.html" class="external-link">epirange</a></span><span class="op">(</span><span class="fl">20210604</span>, <span class="fl">20211231</span><span class="op">)</span>,</span>
<span>  geo_values <span class="op">=</span> <span class="st">"ca,fl,tx,ny,nj"</span>,</span>
<span>  as_of <span class="op">=</span> <span class="va">d</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">time_value</span>, masking <span class="op">=</span> <span class="va">value</span><span class="op">)</span></span>
<span></span>
<span><span class="va">behav_ind_distancing</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://cmu-delphi.github.io/epidatr/reference/pub_covidcast.html" class="external-link">pub_covidcast</a></span><span class="op">(</span></span>
<span>  source <span class="op">=</span> <span class="st">"fb-survey"</span>,</span>
<span>  signals <span class="op">=</span> <span class="st">"smoothed_wothers_distanced_public"</span>,</span>
<span>  time_type <span class="op">=</span> <span class="st">"day"</span>,</span>
<span>  geo_type <span class="op">=</span> <span class="st">"state"</span>,</span>
<span>  time_values <span class="op">=</span> <span class="fu"><a href="https://cmu-delphi.github.io/epidatr/reference/epirange.html" class="external-link">epirange</a></span><span class="op">(</span><span class="fl">20210604</span>, <span class="fl">20211231</span><span class="op">)</span>,</span>
<span>  geo_values <span class="op">=</span> <span class="st">"ca,fl,tx,ny,nj"</span>,</span>
<span>  as_of <span class="op">=</span> <span class="va">d</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">time_value</span>, distancing <span class="op">=</span> <span class="va">value</span><span class="op">)</span></span>
<span></span>
<span><span class="va">behav_ind</span> <span class="op">&lt;-</span> <span class="va">behav_ind_mask</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">full_join</a></span><span class="op">(</span><span class="va">behav_ind_distancing</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"geo_value"</span>, <span class="st">"time_value"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epi_df.html" class="external-link">as_epi_df</a></span><span class="op">(</span>as_of <span class="op">=</span> <span class="va">d</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pop_dat</span> <span class="op">&lt;-</span> <span class="va">state_census</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">abbr</span>, <span class="va">pop</span><span class="op">)</span></span></code></pre></div>
<p>Rather than using raw mask-wearing / social-distancing metrics, for
the sake of illustration, we’ll convert both into categorical
predictors.</p>
<p><img src="preprocessing-and-models_files/figure-html/unnamed-chunk-9-1.png" width="90%" style="display: block; margin: auto;"></p>
<p>We will take a subset of death rate and case rate data from the
built-in dataset <code>covid_case_death_rates</code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">jhu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>  <span class="va">covid_case_death_rates</span>,</span>
<span>  <span class="va">time_value</span> <span class="op">&gt;=</span> <span class="st">"2021-06-04"</span>,</span>
<span>  <span class="va">time_value</span> <span class="op">&lt;=</span> <span class="st">"2021-12-31"</span>,</span>
<span>  <span class="va">geo_value</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ca"</span>, <span class="st">"fl"</span>, <span class="st">"tx"</span>, <span class="st">"ny"</span>, <span class="st">"nj"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Preprocessing steps will again rely on functions from the
<code>epipredict</code> package as well as the <code>recipes</code>
package. There are also many functions in the <code>recipes</code>
package that allow for <a href="https://recipes.tidymodels.org/reference/#step-functions-individual-transformations" class="external-link">scalar
transformations</a>, such as log transformations and data centering. In
our case, we will center the numerical predictors to allow for a more
meaningful interpretation of the intercept.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">jhu</span> <span class="op">&lt;-</span> <span class="va">jhu</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>geo_value_factor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">behav_ind</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"geo_value"</span>, <span class="st">"time_value"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://cmu-delphi.github.io/epiprocess/reference/epi_df.html" class="external-link">as_epi_df</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epi_recipe.html">epi_recipe</a></span><span class="op">(</span><span class="va">jhu</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/roles.html" class="external-link">add_role</a></span><span class="op">(</span><span class="va">geo_value_factor</span>, new_role <span class="op">=</span> <span class="st">"predictor"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_dummy.html" class="external-link">step_dummy</a></span><span class="op">(</span><span class="va">geo_value_factor</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/step_epi_shift.html">step_epi_lag</a></span><span class="op">(</span><span class="va">case_rate</span>, <span class="va">death_rate</span>, lag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">7</span>, <span class="fl">14</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_mutate.html" class="external-link">step_mutate</a></span><span class="op">(</span></span>
<span>    masking <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/cut_interval.html" class="external-link">cut_number</a></span><span class="op">(</span><span class="va">masking</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>    distancing <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/cut_interval.html" class="external-link">cut_number</a></span><span class="op">(</span><span class="va">distancing</span>, <span class="fl">5</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/step_epi_shift.html">step_epi_ahead</a></span><span class="op">(</span><span class="va">death_rate</span>, ahead <span class="op">=</span> <span class="fl">7</span>, role <span class="op">=</span> <span class="st">"outcome"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_center.html" class="external-link">step_center</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">contains</a></span><span class="op">(</span><span class="st">"lag"</span><span class="op">)</span>, role <span class="op">=</span> <span class="st">"predictor"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/step_epi_naomit.html">step_epi_naomit</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>As a sanity check we can examine the structure of the training
data:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_sample</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/bake.html" class="external-link">bake</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html" class="external-link">prep</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">jhu</span><span class="op">)</span>, <span class="va">jhu</span><span class="op">)</span>, n <span class="op">=</span> <span class="fl">6</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 6</span></span>
<span><span class="co">#&gt; Columns: 17</span></span>
<span><span class="co">#&gt; $ <span style="font-weight: bold;">geo_value          </span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "ny", "ca", "ca", "nj", "ca", "tx"</span></span>
<span><span class="co">#&gt; $ <span style="font-weight: bold;">time_value         </span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span> 2021-10-16, 2021-11-24, 2021-11-28, 2021-12-03,…</span></span>
<span><span class="co">#&gt; $ <span style="font-weight: bold;">case_rate          </span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 23.910028, 11.687497, 10.642052, 34.521027, 32…</span></span>
<span><span class="co">#&gt; $ <span style="font-weight: bold;">death_rate         </span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.1935616, 0.2489327, 0.1596653, 0.1736988, -0.…</span></span>
<span><span class="co">#&gt; $ <span style="font-weight: bold;">masking            </span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; $ <span style="font-weight: bold;">distancing         </span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span>, <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; $ <span style="font-weight: bold;">geo_value_factor_fl</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0, 0, 0, 0, 0, 0</span></span>
<span><span class="co">#&gt; $ <span style="font-weight: bold;">geo_value_factor_nj</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0, 0, 0, 1, 0, 0</span></span>
<span><span class="co">#&gt; $ <span style="font-weight: bold;">geo_value_factor_ny</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1, 0, 0, 0, 0, 0</span></span>
<span><span class="co">#&gt; $ <span style="font-weight: bold;">geo_value_factor_tx</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0, 0, 0, 0, 0, 1</span></span>
<span><span class="co">#&gt; $ <span style="font-weight: bold;">lag_0_case_rate    </span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -3.031947, -15.254479, -16.299923, 7.579052, 5.…</span></span>
<span><span class="co">#&gt; $ <span style="font-weight: bold;">lag_7_case_rate    </span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -1.452426, -13.683953, -13.892606, -2.516386, 2…</span></span>
<span><span class="co">#&gt; $ <span style="font-weight: bold;">lag_14_case_rate   </span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -1.971052, -11.437390, -12.995578, -5.872955, -…</span></span>
<span><span class="co">#&gt; $ <span style="font-weight: bold;">lag_0_death_rate   </span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -0.08822027, -0.03284917, -0.12211657, -0.10808…</span></span>
<span><span class="co">#&gt; $ <span style="font-weight: bold;">lag_7_death_rate   </span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -0.10521237, -0.08728057, -0.06514517, -0.14829…</span></span>
<span><span class="co">#&gt; $ <span style="font-weight: bold;">lag_14_death_rate  </span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -0.05793007, -0.07639427, -0.07022537, -0.13542…</span></span>
<span><span class="co">#&gt; $ <span style="font-weight: bold;">ahead_7_death_rate </span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.1950392, 0.1694629, 0.2282487, 0.1753071, 0.1…</span></span></code></pre></div>
<p>Before directly predicting the results, we need to add postprocessing
layers to obtain the death counts instead of death rates. Note that the
rates used so far are “per 100K people” rather than “per person”. We’ll
also use quantile regression with the <code>quantile_reg</code> engine
rather than ordinary least squares to create median predictions and a
90% prediction interval.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/frosting.html">frosting</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/layer_predict.html">layer_predict</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/layer_add_target_date.html">layer_add_target_date</a></span><span class="op">(</span><span class="st">"2022-01-07"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/layer_threshold.html">layer_threshold</a></span><span class="op">(</span><span class="va">.pred</span>, lower <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/layer_quantile_distn.html">layer_quantile_distn</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/layer_naomit.html">layer_naomit</a></span><span class="op">(</span><span class="va">.pred</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/layer_population_scaling.html">layer_population_scaling</a></span><span class="op">(</span></span>
<span>    <span class="va">.pred</span>, <span class="va">.pred_distn</span>,</span>
<span>    df <span class="op">=</span> <span class="va">pop_dat</span>,</span>
<span>    rate_rescaling <span class="op">=</span> <span class="fl">1e5</span>,</span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"geo_value"</span> <span class="op">=</span> <span class="st">"abbr"</span><span class="op">)</span>,</span>
<span>    df_pop_col <span class="op">=</span> <span class="st">"pop"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">wf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epi_workflow.html">epi_workflow</a></span><span class="op">(</span><span class="va">r</span>, <span class="fu"><a href="../reference/quantile_reg.html">quantile_reg</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="va">jhu</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_frosting.html">add_frosting</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast</a></span><span class="op">(</span><span class="va">wf</span><span class="op">)</span></span>
<span><span class="va">p</span></span>
<span><span class="co">#&gt; An `epi_df` object, 5 x 7 with metadata:</span></span>
<span><span class="co">#&gt; * geo_type  = state</span></span>
<span><span class="co">#&gt; * time_type = day</span></span>
<span><span class="co">#&gt; * as_of     = 2023-03-10</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 × 7</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">geo_value</span> <span style="font-weight: bold;">time_value</span>     <span style="font-weight: bold;">.pred</span> <span style="font-weight: bold;">target_date</span> <span style="font-weight: bold;">.pred_distn</span> <span style="font-weight: bold;">.pred_scaled</span></span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;qtls(7)&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;qtls(7)&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;qtls(7)&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> ca        2021-12-31   [0.182] 2022-01-07      [0.182]       [71.8]</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> fl        2021-12-31   [0.354] 2022-01-07      [0.354]       [76.1]</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> nj        2021-12-31   [0.651] 2022-01-07      [0.651]       [57.8]</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> ny        2021-12-31   [0.703] 2022-01-07      [0.703]        [137]</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> tx        2021-12-31   [0.296] 2022-01-07      [0.296]       [85.7]</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1 more variable: </span><span style="color: #949494; font-weight: bold;">.pred_distn_scaled</span><span style="color: #949494;"> &lt;qtls(7)&gt;</span></span></span></code></pre></div>
<p>The columns marked <code>*_scaled</code> have been rescaled to the
correct units, in this case <code>deaths</code> rather than deaths per
100K people (these remain in <code>.pred</code>).</p>
<p>To look at the prediction intervals:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">target_date</span>, <span class="va">.pred_scaled</span>, <span class="va">.pred_distn_scaled</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/pivot_quantiles_wider.html">pivot_quantiles_wider</a></span><span class="op">(</span><span class="va">.pred_distn_scaled</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 × 10</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">geo_value</span> <span style="font-weight: bold;">target_date</span> <span style="font-weight: bold;">.pred_scaled</span> <span style="font-weight: bold;">`0.05`</span> <span style="font-weight: bold;">`0.1`</span> <span style="font-weight: bold;">`0.25`</span> <span style="font-weight: bold;">`0.5`</span> <span style="font-weight: bold;">`0.75`</span> <span style="font-weight: bold;">`0.9`</span></span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;qtls(7)&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> ca        2022-01-07        [71.8]   32.4  52.9   62.0  71.8   71.3  53.7</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> fl        2022-01-07        [76.1]   31.4  50.1   62.7  76.1   69.2  43.2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> nj        2022-01-07        [57.8]   36.3  45.2   52.6  57.8   55.6  42.6</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> ny        2022-01-07         [137]   85.8 110.   124.  137.   134.   98.5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> tx        2022-01-07        [85.7]   52.7  64.1   76.5  85.7   96.0  94.7</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1 more variable: </span><span style="color: #949494; font-weight: bold;">`0.95`</span><span style="color: #949494;"> &lt;dbl&gt;</span></span></span></code></pre></div>
<p>Last but not least, let’s take a look at the regression fit and check
the coefficients:</p>
<pre><code><span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; quantreg::rq(formula = ..y ~ ., tau = ~c(0.05, 0.1, 0.25, 0.5, </span></span>
<span><span class="co">#&gt; 0.75, 0.9, 0.95), data = data, na.action = stats::na.omit, method = ~"br", </span></span>
<span><span class="co">#&gt;     model = FALSE)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;                        tau= 0.05     tau= 0.10     tau= 0.25     tau= 0.50</span></span>
<span><span class="co">#&gt; (Intercept)          0.210972402  0.2359826581  0.2664823658  0.2947231936</span></span>
<span><span class="co">#&gt; geo_value_factor_fl  0.029646713  0.0164328932  0.0228839635  0.0477642418</span></span>
<span><span class="co">#&gt; geo_value_factor_nj  0.007927635 -0.0004083631 -0.0012956427 -0.0022679253</span></span>
<span><span class="co">#&gt; geo_value_factor_ny -0.003055366 -0.0045424488 -0.0154494128 -0.0186682895</span></span>
<span><span class="co">#&gt; geo_value_factor_tx  0.020163817  0.0260190881  0.0325313901  0.0380479148</span></span>
<span><span class="co">#&gt; lag_0_case_rate     -0.001497710 -0.0008892893 -0.0011817541 -0.0011301607</span></span>
<span><span class="co">#&gt; lag_7_case_rate      0.004540193  0.0042615475  0.0055779628  0.0058296289</span></span>
<span><span class="co">#&gt; lag_14_case_rate     0.001401322  0.0007932742  0.0005183414  0.0001946297</span></span>
<span><span class="co">#&gt; lag_0_death_rate     0.500930277  0.4897370924  0.4452127352  0.5322549795</span></span>
<span><span class="co">#&gt; lag_7_death_rate     0.023373823  0.0856670896  0.0800142120  0.1192945031</span></span>
<span><span class="co">#&gt; lag_14_death_rate   -0.114626164 -0.0610698031  0.0154793659 -0.0291354449</span></span>
<span><span class="co">#&gt;                         tau= 0.75     tau= 0.90    tau= 0.95</span></span>
<span><span class="co">#&gt; (Intercept)          0.3389449098  0.3797560267  0.415298613</span></span>
<span><span class="co">#&gt; geo_value_factor_fl  0.0588500157  0.1331501784  0.168089770</span></span>
<span><span class="co">#&gt; geo_value_factor_nj -0.0138013295 -0.0137781000 -0.029492405</span></span>
<span><span class="co">#&gt; geo_value_factor_ny -0.0101301003 -0.0195144856 -0.037258463</span></span>
<span><span class="co">#&gt; geo_value_factor_tx  0.0489007435  0.0749248485  0.073000742</span></span>
<span><span class="co">#&gt; lag_0_case_rate     -0.0018750320 -0.0029905834 -0.001683478</span></span>
<span><span class="co">#&gt; lag_7_case_rate      0.0067506556  0.0060268400  0.007268965</span></span>
<span><span class="co">#&gt; lag_14_case_rate     0.0007346599  0.0052740974  0.002825240</span></span>
<span><span class="co">#&gt; lag_0_death_rate     0.5119314030  0.2221271697  0.198207000</span></span>
<span><span class="co">#&gt; lag_7_death_rate     0.1447297067  0.2473517717  0.218447512</span></span>
<span><span class="co">#&gt; lag_14_death_rate   -0.0007025566 -0.0003914277  0.122566902</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Degrees of freedom: 950 total; 939 residual</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="classification">Classification<a class="anchor" aria-label="anchor" href="#classification"></a>
</h2>
<p>Sometimes it is preferable to create a predictive model for surges or
upswings rather than for raw values. In this case, the target is to
predict if the future will have increased case rates (denoted
<code>up</code>), decreased case rates (<code>down</code>), or flat case
rates (<code>flat</code>) relative to the current level. Such models may
be referred to as “hotspot prediction models”. We will follow the
analysis in <a href="#references">McDonald, Bien, Green, Hu, et al.</a>
but extend the application to predict three categories instead of
two.</p>
<p>Hotspot prediction uses a categorical outcome variable defined in
terms of the relative change of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Y</mi><mrow><mo>ℓ</mo><mo>,</mo><mi>t</mi><mo>+</mo><mi>a</mi></mrow></msub><annotation encoding="application/x-tex">Y_{\ell, t+a}</annotation></semantics></math>
compared to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Y</mi><mrow><mo>ℓ</mo><mo>,</mo><mi>t</mi></mrow></msub><annotation encoding="application/x-tex">Y_{\ell, t}</annotation></semantics></math>.
Where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Y</mi><mrow><mo>ℓ</mo><mo>,</mo><mi>t</mi></mrow></msub><annotation encoding="application/x-tex">Y_{\ell, t}</annotation></semantics></math>
denotes the case rates in location
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mo>ℓ</mo><annotation encoding="application/x-tex">\ell</annotation></semantics></math>
at time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>.
We define the response variables as follows:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Z</mi><mrow><mo>ℓ</mo><mo>,</mo><mi>t</mi></mrow></msub><mo>=</mo><mrow><mo stretchy="true" form="prefix">{</mo><mtable><mtr><mtd columnalign="left" style="text-align: left"><mtext mathvariant="normal">up</mtext><mo>,</mo></mtd><mtd columnalign="left" style="text-align: left"><mtext mathvariant="normal">if</mtext><mspace width="0.222em"></mspace><msubsup><mi>Y</mi><mrow><mo>ℓ</mo><mo>,</mo><mi>t</mi></mrow><mi>Δ</mi></msubsup><mo>&gt;</mo><mn>0.25</mn></mtd></mtr><mtr><mtd columnalign="left" style="text-align: left"><mtext mathvariant="normal">down</mtext><mo>,</mo></mtd><mtd columnalign="left" style="text-align: left"><mtext mathvariant="normal">if</mtext><mspace width="0.222em"></mspace><msubsup><mi>Y</mi><mrow><mo>ℓ</mo><mo>,</mo><mi>t</mi></mrow><mi>Δ</mi></msubsup><mo>&lt;</mo><mo>−</mo><mn>0.20</mn></mtd></mtr><mtr><mtd columnalign="left" style="text-align: left"><mtext mathvariant="normal">flat</mtext><mo>,</mo></mtd><mtd columnalign="left" style="text-align: left"><mtext mathvariant="normal">otherwise</mtext></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">
 Z_{\ell, t}=
    \begin{cases}
      \text{up}, &amp; \text{if}\ Y^{\Delta}_{\ell, t} &gt; 0.25 \\
      \text{down}, &amp; \text{if}\  Y^{\Delta}_{\ell, t} &lt; -0.20\\
      \text{flat}, &amp; \text{otherwise}
    \end{cases}
</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>Y</mi><mrow><mo>ℓ</mo><mo>,</mo><mi>t</mi></mrow><mi>Δ</mi></msubsup><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Y</mi><mrow><mo>ℓ</mo><mo>,</mo><mi>t</mi></mrow></msub><mo>−</mo><msub><mi>Y</mi><mrow><mo>ℓ</mo><mo>,</mo><mi>t</mi><mo>−</mo><mn>7</mn></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mspace width="0.222em"></mspace><mi>/</mi><mspace width="0.222em"></mspace><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Y</mi><mrow><mo>ℓ</mo><mo>,</mo><mi>t</mi><mo>−</mo><mn>7</mn></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">Y^{\Delta}_{\ell, t} = (Y_{\ell, t}- Y_{\ell, t-7})\ /\ (Y_{\ell, t-7})</annotation></semantics></math>.
We say location
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mo>ℓ</mo><annotation encoding="application/x-tex">\ell</annotation></semantics></math>
is a hotspot at time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>
when
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Z</mi><mrow><mo>ℓ</mo><mo>,</mo><mi>t</mi></mrow></msub><annotation encoding="application/x-tex">Z_{\ell,t}</annotation></semantics></math>
is <code>up</code>, meaning the number of newly reported cases over the
past 7 days has increased by at least 25% compared to the preceding
week. When
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Z</mi><mrow><mo>ℓ</mo><mo>,</mo><mi>t</mi></mrow></msub><annotation encoding="application/x-tex">Z_{\ell,t}</annotation></semantics></math>
is categorized as <code>down</code>, it suggests that there has been at
least a 20% decrease in newly reported cases over the past 7 days (a 20%
decrease is the inverse of a 25% increase). Otherwise, we will consider
the trend to be <code>flat</code>.</p>
<p>The expression of the multinomial regression we will use is as
follows:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mi>j</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mtext mathvariant="normal">Pr</mtext><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Z</mi><mrow><mo>ℓ</mo><mo>,</mo><mi>t</mi></mrow></msub><mo>=</mo><mi>j</mi><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mfrac><msup><mi>e</mi><mrow><msub><mi>g</mi><mi>j</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msup><mrow><mn>1</mn><mo>+</mo><munderover><mo>∑</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mn>2</mn></munderover><msup><mi>e</mi><mrow><msub><mi>g</mi><mi>k</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">
\pi_{j}(x) = \text{Pr}(Z_{\ell,t} = j|x) = \frac{e^{g_j(x)}}{1 + \sum_{k=1}^{2}e^{g_k(x)} }
</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>
is either down, flat, or up</p>
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>g</mi><mtext mathvariant="normal">down</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mn>0</mn><mi>.</mi></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>g</mi><mtext mathvariant="normal">flat</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><mrow><mi>P</mi><mi>r</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Z</mi><mrow><mo>ℓ</mo><mo>,</mo><mi>t</mi></mrow></msub><mo>=</mo><mtext mathvariant="normal">flat</mtext><mo>∣</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mi>P</mi><mi>r</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Z</mi><mrow><mo>ℓ</mo><mo>,</mo><mi>t</mi></mrow></msub><mo>=</mo><mtext mathvariant="normal">down</mtext><mo>∣</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>β</mi><mn>10</mn></msub><mo>+</mo><msub><mi>β</mi><mn>11</mn></msub><mi>t</mi><mo>+</mo><msub><mi>δ</mi><mn>10</mn></msub><msub><mi>s</mi><mtext mathvariant="normal">state_1</mtext></msub><mo>+</mo><msub><mi>δ</mi><mn>11</mn></msub><msub><mi>s</mi><mtext mathvariant="normal">state_2</mtext></msub><mo>+</mo><mi>⋯</mi></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mspace width="1.0em"></mspace><mo>+</mo><msub><mi>β</mi><mn>12</mn></msub><msubsup><mi>Y</mi><mrow><mo>ℓ</mo><mo>,</mo><mi>t</mi></mrow><mi>Δ</mi></msubsup><mo>+</mo><msub><mi>β</mi><mn>13</mn></msub><msubsup><mi>Y</mi><mrow><mo>ℓ</mo><mo>,</mo><mi>t</mi><mo>−</mo><mn>7</mn></mrow><mi>Δ</mi></msubsup><mo>+</mo><msub><mi>β</mi><mn>14</mn></msub><msubsup><mi>Y</mi><mrow><mo>ℓ</mo><mo>,</mo><mi>t</mi><mo>−</mo><mn>14</mn></mrow><mi>Δ</mi></msubsup></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>g</mi><mtext mathvariant="normal">up</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><mrow><mi>P</mi><mi>r</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Z</mi><mrow><mo>ℓ</mo><mo>,</mo><mi>t</mi></mrow></msub><mo>=</mo><mtext mathvariant="normal">up</mtext><mo>∣</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mi>P</mi><mi>r</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Z</mi><mrow><mo>ℓ</mo><mo>,</mo><mi>t</mi></mrow></msub><mo>=</mo><mtext mathvariant="normal">down</mtext><mo>∣</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>β</mi><mn>20</mn></msub><mo>+</mo><msub><mi>β</mi><mn>21</mn></msub><mi>t</mi><mo>+</mo><msub><mi>δ</mi><mn>20</mn></msub><msub><mi>s</mi><mtext mathvariant="normal">state_1</mtext></msub><mo>+</mo><msub><mi>δ</mi><mn>21</mn></msub><msub><mi>s</mi><mrow><mtext mathvariant="normal">state</mtext><mi>_</mi><mn>2</mn></mrow></msub><mo>+</mo><mi>⋯</mi></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd><mtd columnalign="left" style="text-align: left"><mspace width="1.0em"></mspace><mo>+</mo><msub><mi>β</mi><mn>22</mn></msub><msubsup><mi>Y</mi><mrow><mo>ℓ</mo><mo>,</mo><mi>t</mi></mrow><mi>Δ</mi></msubsup><mo>+</mo><msub><mi>β</mi><mn>23</mn></msub><msubsup><mi>Y</mi><mrow><mo>ℓ</mo><mo>,</mo><mi>t</mi><mo>−</mo><mn>7</mn></mrow><mi>Δ</mi></msubsup><mo>+</mo><msub><mi>β</mi><mn>24</mn></msub><msubsup><mi>Y</mi><mrow><mo>ℓ</mo><mo>,</mo><mi>t</mi><mo>−</mo><mn>14</mn></mrow><mi>Δ</mi></msubsup></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
g_{\text{down}}(x) &amp;= 0.\\
g_{\text{flat}}(x) &amp;= \log\left(\frac{Pr(Z_{\ell,t}=\text{flat}\mid x)}{Pr(Z_{\ell,t}=\text{down}\mid x)}\right) =
\beta_{10} + \beta_{11} t + \delta_{10} s_{\text{state_1}} +
\delta_{11} s_{\text{state_2}} + \cdots \nonumber \\
&amp;\quad + \beta_{12} Y^{\Delta}_{\ell, t} +
\beta_{13} Y^{\Delta}_{\ell, t-7} + \beta_{14} Y^{\Delta}_{\ell, t-14}\\
g_{\text{up}}(x) &amp;= \log\left(\frac{Pr(Z_{\ell,t}=\text{up}\mid x)}{Pr(Z_{\ell,t}=\text{down} \mid x)}\right) =
\beta_{20} + \beta_{21}t + \delta_{20} s_{\text{state_1}} +
\delta_{21} s_{\text{state}\_2} + \cdots \nonumber \\
&amp;\quad + \beta_{22} Y^{\Delta}_{\ell, t} +
\beta_{23} Y^{\Delta}_{\ell, t-7} + \beta_{24} Y^{\Delta}_{\ell, t-14}
\end{aligned}</annotation></semantics></math><p>Preprocessing steps are similar to the previous models with an
additional step of categorizing the response variables. Again, we will
use a subset of death rate and case rate data from our built-in dataset
<code>covid_case_death_rates</code>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">jhu</span> <span class="op">&lt;-</span> <span class="va">covid_case_death_rates</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">time_value</span> <span class="op">&gt;=</span> <span class="st">"2021-06-04"</span>,</span>
<span>    <span class="va">time_value</span> <span class="op">&lt;=</span> <span class="st">"2021-12-31"</span>,</span>
<span>    <span class="va">geo_value</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ca"</span>, <span class="st">"fl"</span>, <span class="st">"tx"</span>, <span class="st">"ny"</span>, <span class="st">"nj"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>geo_value_factor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epi_recipe.html">epi_recipe</a></span><span class="op">(</span><span class="va">jhu</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/roles.html" class="external-link">add_role</a></span><span class="op">(</span><span class="va">time_value</span>, new_role <span class="op">=</span> <span class="st">"predictor"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_dummy.html" class="external-link">step_dummy</a></span><span class="op">(</span><span class="va">geo_value_factor</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/step_growth_rate.html">step_growth_rate</a></span><span class="op">(</span><span class="va">case_rate</span>, role <span class="op">=</span> <span class="st">"none"</span>, prefix <span class="op">=</span> <span class="st">"gr_"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/step_epi_shift.html">step_epi_lag</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"gr_"</span><span class="op">)</span>, lag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">7</span>, <span class="fl">14</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/step_epi_shift.html">step_epi_ahead</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"gr_"</span><span class="op">)</span>, ahead <span class="op">=</span> <span class="fl">7</span>, role <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># note recipes::step_cut() has a bug in it, or we could use that here</span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_mutate.html" class="external-link">step_mutate</a></span><span class="op">(</span></span>
<span>    response <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut</a></span><span class="op">(</span></span>
<span>      <span class="va">ahead_7_gr_7_rel_change_case_rate</span>,</span>
<span>      breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="op">-</span><span class="fl">0.2</span>, <span class="fl">0.25</span>, <span class="cn">Inf</span><span class="op">)</span> <span class="op">/</span> <span class="fl">7</span>, <span class="co"># division gives weekly not daily</span></span>
<span>      labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"down"</span>, <span class="st">"flat"</span>, <span class="st">"up"</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    role <span class="op">=</span> <span class="st">"outcome"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_rm.html" class="external-link">step_rm</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html" class="external-link">has_role</a></span><span class="op">(</span><span class="st">"none"</span><span class="op">)</span>, <span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html" class="external-link">has_role</a></span><span class="op">(</span><span class="st">"raw"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/step_epi_naomit.html">step_epi_naomit</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>We will fit the multinomial regression and examine the
predictions:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epi_workflow.html">epi_workflow</a></span><span class="op">(</span><span class="va">r</span>, <span class="fu"><a href="https://parsnip.tidymodels.org/reference/multinom_reg.html" class="external-link">multinom_reg</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="va">jhu</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast</a></span><span class="op">(</span><span class="va">wf</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">.pred_class</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; An `epi_df` object, 5 x 3 with metadata:</span></span>
<span><span class="co">#&gt; * geo_type  = state</span></span>
<span><span class="co">#&gt; * time_type = day</span></span>
<span><span class="co">#&gt; * as_of     = 2023-03-10</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 × 3</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">geo_value</span> <span style="font-weight: bold;">time_value</span> <span style="font-weight: bold;">.pred_class</span></span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> ca        2021-12-31 up         </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> fl        2021-12-31 up         </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> nj        2021-12-31 up         </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> ny        2021-12-31 up         </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> tx        2021-12-31 up</span></span></code></pre></div>
<p>We can also look at the estimated coefficients and model summary
information:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://hardhat.tidymodels.org/reference/hardhat-extract.html" class="external-link">extract_fit_engine</a></span><span class="op">(</span><span class="va">wf</span><span class="op">)</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; nnet::multinom(formula = ..y ~ ., data = data, trace = FALSE)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;      (Intercept)  time_value geo_value_factor_fl geo_value_factor_nj</span></span>
<span><span class="co">#&gt; flat   -161.3776 0.008663641           -1.310482            1.145751</span></span>
<span><span class="co">#&gt; up     -146.6629 0.007796713           -0.565096            1.582188</span></span>
<span><span class="co">#&gt;      geo_value_factor_ny geo_value_factor_tx lag_0_gr_7_rel_change_case_rate</span></span>
<span><span class="co">#&gt; flat            25.93757          -0.2681016                        20.06018</span></span>
<span><span class="co">#&gt; up              26.04283          -0.2679387                        34.18244</span></span>
<span><span class="co">#&gt;      lag_7_gr_7_rel_change_case_rate lag_14_gr_7_rel_change_case_rate</span></span>
<span><span class="co">#&gt; flat                        33.91462                         7.466482</span></span>
<span><span class="co">#&gt; up                          57.78538                         5.116403</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual Deviance: 1152.434 </span></span>
<span><span class="co">#&gt; AIC: 1188.434</span></span></code></pre></div>
<p>One could also use a formula in <code><a href="../reference/epi_recipe.html">epi_recipe()</a></code> to achieve
the same results as above. However, only one of
<code><a href="https://workflows.tidymodels.org/reference/add_formula.html" class="external-link">add_formula()</a></code>, <code><a href="https://workflows.tidymodels.org/reference/add_recipe.html" class="external-link">add_recipe()</a></code>, or
<code><a href="https://workflows.tidymodels.org/reference/add_variables.html" class="external-link">workflow_variables()</a></code> can be specified. For the purpose of
demonstrating <code>add_formula</code> rather than
<code>add_recipe</code>, we will <code>prep</code> and <code>bake</code>
our recipe to return a <code>data.frame</code> that could be used for
model fitting.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/bake.html" class="external-link">bake</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html" class="external-link">prep</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">jhu</span><span class="op">)</span>, <span class="va">jhu</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/epi_workflow.html">epi_workflow</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://workflows.tidymodels.org/reference/add_formula.html" class="external-link">add_formula</a></span><span class="op">(</span></span>
<span>    <span class="va">response</span> <span class="op">~</span> <span class="va">geo_value</span> <span class="op">+</span> <span class="va">time_value</span> <span class="op">+</span> <span class="va">lag_0_gr_7_rel_change_case_rate</span> <span class="op">+</span></span>
<span>      <span class="va">lag_7_gr_7_rel_change_case_rate</span> <span class="op">+</span> <span class="va">lag_14_gr_7_rel_change_case_rate</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/Add_model.html">add_model</a></span><span class="op">(</span><span class="fu">parsnip</span><span class="fu">::</span><span class="fu"><a href="https://parsnip.tidymodels.org/reference/multinom_reg.html" class="external-link">multinom_reg</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">b</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ══ Epi Workflow [trained] ═══════════════════════════════════════════════════</span></span>
<span><span class="co">#&gt; <span style="font-style: italic;">Preprocessor:</span> Formula</span></span>
<span><span class="co">#&gt; <span style="font-style: italic;">Model:</span> multinom_reg()</span></span>
<span><span class="co">#&gt; <span style="font-style: italic;">Postprocessor:</span> None</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Preprocessor ─────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; response ~ geo_value + time_value + lag_0_gr_7_rel_change_case_rate +</span></span>
<span><span class="co">#&gt; lag_7_gr_7_rel_change_case_rate + lag_14_gr_7_rel_change_case_rate</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Model ────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; nnet::multinom(formula = ..y ~ ., data = data, trace = FALSE)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;      (Intercept) geo_valuefl geo_valuenj geo_valueny geo_valuetx  time_value</span></span>
<span><span class="co">#&gt; flat   -161.3782   -1.310438    1.145794    25.93743  -0.2680307 0.008663669</span></span>
<span><span class="co">#&gt; up     -146.6592   -0.565024    1.582236    26.04272  -0.2678949 0.007796513</span></span>
<span><span class="co">#&gt;      lag_0_gr_7_rel_change_case_rate lag_7_gr_7_rel_change_case_rate</span></span>
<span><span class="co">#&gt; flat                        20.05896                        33.91374</span></span>
<span><span class="co">#&gt; up                          34.18073                        57.78475</span></span>
<span><span class="co">#&gt;      lag_14_gr_7_rel_change_case_rate</span></span>
<span><span class="co">#&gt; flat                         7.466884</span></span>
<span><span class="co">#&gt; up                           5.116729</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual Deviance: 1152.434 </span></span>
<span><span class="co">#&gt; AIC: 1188.434</span></span>
<span><span class="co">#&gt; </span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="benefits-of-lagging-and-leading-in-epipredict">Benefits of Lagging and Leading in <code>epipredict</code><a class="anchor" aria-label="anchor" href="#benefits-of-lagging-and-leading-in-epipredict"></a>
</h2>
<p>The <code>step_epi_ahead</code> and <code>step_epi_lag</code>
functions in the <code>epipredict</code> package is handy for creating
correct lags and leads for future predictions.</p>
<p>Let’s start with a simple dataset and preprocessing:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ex</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>  <span class="va">covid_case_death_rates</span>,</span>
<span>  <span class="va">time_value</span> <span class="op">&gt;=</span> <span class="st">"2021-12-01"</span>,</span>
<span>  <span class="va">time_value</span> <span class="op">&lt;=</span> <span class="st">"2021-12-31"</span>,</span>
<span>  <span class="va">geo_value</span> <span class="op">==</span> <span class="st">"ca"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">ex</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 31  4</span></span></code></pre></div>
<p>We want to predict death rates on 2022-01-07, which is 7 days ahead
of the latest available date in our dataset.</p>
<p>We will compare two methods of trying to create lags and leads:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epi_recipe.html">epi_recipe</a></span><span class="op">(</span><span class="va">ex</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/step_epi_shift.html">step_epi_lag</a></span><span class="op">(</span><span class="va">case_rate</span>, lag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">7</span>, <span class="fl">14</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/step_epi_shift.html">step_epi_lag</a></span><span class="op">(</span><span class="va">death_rate</span>, lag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">7</span>, <span class="fl">14</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/step_epi_shift.html">step_epi_ahead</a></span><span class="op">(</span><span class="va">death_rate</span>, ahead <span class="op">=</span> <span class="fl">7</span>, role <span class="op">=</span> <span class="st">"outcome"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/step_epi_naomit.html">step_epi_naomit</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html" class="external-link">prep</a></span><span class="op">(</span><span class="va">ex</span><span class="op">)</span></span>
<span></span>
<span><span class="va">b1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/bake.html" class="external-link">bake</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">ex</span><span class="op">)</span></span>
<span><span class="va">b1</span></span>
<span><span class="co">#&gt; An `epi_df` object, 17 x 11 with metadata:</span></span>
<span><span class="co">#&gt; * geo_type  = state</span></span>
<span><span class="co">#&gt; * time_type = day</span></span>
<span><span class="co">#&gt; * as_of     = 2023-03-10</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 17 × 11</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">geo_value</span> <span style="font-weight: bold;">time_value</span> <span style="font-weight: bold;">case_rate</span> <span style="font-weight: bold;">death_rate</span> <span style="font-weight: bold;">lag_0_case_rate</span> <span style="font-weight: bold;">lag_7_case_rate</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">*</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> ca        2021-12-15      15.8      0.154            15.8            18.0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> ca        2021-12-16      16.3      0.155            16.3            17.4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> ca        2021-12-17      16.8      0.158            16.8            17.3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> ca        2021-12-18      17.6      0.164            17.6            17.2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> ca        2021-12-19      19.0      0.165            19.0            16.3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> ca        2021-12-20      20.6      0.163            20.6            16.0</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 11 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 5 more variables: </span><span style="color: #949494; font-weight: bold;">lag_14_case_rate</span><span style="color: #949494;"> &lt;dbl&gt;, </span><span style="color: #949494; font-weight: bold;">lag_0_death_rate</span><span style="color: #949494;"> &lt;dbl&gt;, …</span></span></span>
<span></span>
<span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epi_recipe.html">epi_recipe</a></span><span class="op">(</span><span class="va">ex</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_mutate.html" class="external-link">step_mutate</a></span><span class="op">(</span></span>
<span>    lag0case_rate <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">case_rate</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>    lag7case_rate <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">case_rate</span>, <span class="fl">7</span><span class="op">)</span>,</span>
<span>    lag14case_rate <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">case_rate</span>, <span class="fl">14</span><span class="op">)</span>,</span>
<span>    lag0death_rate <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">death_rate</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>    lag7death_rate <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">death_rate</span>, <span class="fl">7</span><span class="op">)</span>,</span>
<span>    lag14death_rate <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">death_rate</span>, <span class="fl">14</span><span class="op">)</span>,</span>
<span>    ahead7death_rate <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lead</a></span><span class="op">(</span><span class="va">death_rate</span>, <span class="fl">7</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/step_epi_naomit.html">step_epi_naomit</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html" class="external-link">prep</a></span><span class="op">(</span><span class="va">ex</span><span class="op">)</span></span>
<span></span>
<span><span class="va">b2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/bake.html" class="external-link">bake</a></span><span class="op">(</span><span class="va">p2</span>, <span class="va">ex</span><span class="op">)</span></span>
<span><span class="va">b2</span></span>
<span><span class="co">#&gt; An `epi_df` object, 10 x 11 with metadata:</span></span>
<span><span class="co">#&gt; * geo_type  = state</span></span>
<span><span class="co">#&gt; * time_type = day</span></span>
<span><span class="co">#&gt; * as_of     = 2023-03-10</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 10 × 11</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">geo_value</span> <span style="font-weight: bold;">time_value</span> <span style="font-weight: bold;">case_rate</span> <span style="font-weight: bold;">death_rate</span> <span style="font-weight: bold;">lag0case_rate</span> <span style="font-weight: bold;">lag7case_rate</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">*</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> ca        2021-12-15      15.8      0.154          15.8          18.0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> ca        2021-12-16      16.3      0.155          16.3          17.4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> ca        2021-12-17      16.8      0.158          16.8          17.3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> ca        2021-12-18      17.6      0.164          17.6          17.2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> ca        2021-12-19      19.0      0.165          19.0          16.3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> ca        2021-12-20      20.6      0.163          20.6          16.0</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 4 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 5 more variables: </span><span style="color: #949494; font-weight: bold;">lag14case_rate</span><span style="color: #949494;"> &lt;dbl&gt;, </span><span style="color: #949494; font-weight: bold;">lag0death_rate</span><span style="color: #949494;"> &lt;dbl&gt;, …</span></span></span></code></pre></div>
<p>Notice the difference in number of rows <code>b1</code> and
<code>b2</code> returns. This is because the second version, the one
that doesn’t use <code>step_epi_ahead</code> and
<code>step_epi_lag</code>, has omitted dates compared to the one that
used the <code>epipredict</code> functions.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dates_used_in_training1</span> <span class="op">&lt;-</span> <span class="va">b1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">ahead_7_death_rate</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">time_value</span><span class="op">)</span></span>
<span><span class="va">dates_used_in_training1</span></span>
<span><span class="co">#&gt;  [1] "2021-12-15" "2021-12-16" "2021-12-17" "2021-12-18" "2021-12-19"</span></span>
<span><span class="co">#&gt;  [6] "2021-12-20" "2021-12-21" "2021-12-22" "2021-12-23" "2021-12-24"</span></span>
<span><span class="co">#&gt; [11] "2021-12-25" "2021-12-26" "2021-12-27" "2021-12-28" "2021-12-29"</span></span>
<span><span class="co">#&gt; [16] "2021-12-30" "2021-12-31"</span></span>
<span></span>
<span><span class="va">dates_used_in_training2</span> <span class="op">&lt;-</span> <span class="va">b2</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">ahead7death_rate</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">time_value</span><span class="op">)</span></span>
<span><span class="va">dates_used_in_training2</span></span>
<span><span class="co">#&gt;  [1] "2021-12-15" "2021-12-16" "2021-12-17" "2021-12-18" "2021-12-19"</span></span>
<span><span class="co">#&gt;  [6] "2021-12-20" "2021-12-21" "2021-12-22" "2021-12-23" "2021-12-24"</span></span></code></pre></div>
<p>The model that is trained based on the <a href="https://github.com/tidymodels/recipes" class="external-link">recipes</a>
functions will predict 7 days ahead from 2021-12-24 instead of 7 days
ahead from 2021-12-31.</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>McDonald, Bien, Green, Hu, et al. “Can auxiliary indicators improve
COVID-19 forecasting and hotspot prediction?.” Proceedings of the
National Academy of Sciences 118.51 (2021): e2111453118. <a href="https://doi.org/10.1073/pnas.2111453118" class="external-link">doi:10.1073/pnas.2111453118</a></p>
</div>
<div class="section level2">
<h2 id="attribution">Attribution<a class="anchor" aria-label="anchor" href="#attribution"></a>
</h2>
<p>This object contains a modified part of the <a href="https://github.com/CSSEGISandData/COVID-19" class="external-link">COVID-19 Data
Repository by the Center for Systems Science and Engineering (CSSE) at
Johns Hopkins University</a> as <a href="https://cmu-delphi.github.io/delphi-epidata/api/covidcast-signals/jhu-csse.html" class="external-link">republished
in the COVIDcast Epidata API.</a></p>
<p>This data set is licensed under the terms of the <a href="https://creativecommons.org/licenses/by/4.0/" class="external-link">Creative Commons
Attribution 4.0 International license</a> by the Johns Hopkins
University on behalf of its Center for Systems Science in Engineering.
Copyright Johns Hopkins University 2020.</p>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p><a href="https://delphi.cmu.edu/about/" class="external-link">About Delphi</a> • <a href="https://delphi.cmu.edu/epidemic-signals/terms-of-use/" class="external-link">Terms of Use</a> • <a href="https://docs.google.com/forms/u/1/d/e/1FAIpQLScqgT1fKZr5VWBfsaSp-DNaN03aV6EoZU4YljIzHJ1Wl_zmtg/viewform" class="external-link">Contact Us</a> • <a href="https://github.com/cmu-delphi/" class="external-link">Delphi GitHub</a> • <a href="https://cmu-delphi.github.io/delphi-epidata/" class="external-link">Epidata API</a></p>
</div>

<div class="pkgdown-footer-right">
  <p>epipredict</p>
</div>

    </footer>
</div>





  </body>
</html>
